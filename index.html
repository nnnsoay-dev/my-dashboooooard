<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>my dashboard</title>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Inter Font (Standard Notion) & Gaegu (Korean Handwritten) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Gaegu:wght@400;700&display=swap" rel="stylesheet">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        notion: {
                            bg: '#FFFFFF',          /* ä¸»èƒŒæ™¯ */
                            sidebar: '#F7F7F5',     /* å´é‚Šæ¬„ */
                            text: '#37352F',        /* ä¸»è¦æ–‡å­— */
                            dim: 'rgba(55, 53, 47, 0.6)', /* æ¬¡è¦æ–‡å­— */
                            border: '#E9E9E7',      /* é‚Šæ¡† */
                            hover: '#EFEFED',       /* æ‡¸åœèƒŒæ™¯ */
                            'red-bg': '#FDEBEC',
                            'blue-bg': '#E6F3F7',
                            'green-bg': '#EDF3EC',
                            'yellow-bg': '#FBF3DB',
                            'brown-bg': '#F4EEEE',
                            'orange-bg': '#FAEBDD',
                            'purple-bg': '#F6F3F9',
                            'gray-bg': '#F1F1EF'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'ui-sans-serif', 'system-ui', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'sans-serif'],
                        korean: ['"Gaegu"', 'cursive'], 
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            color: #37352F;
            background-color: #FFFFFF;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #D3D1CB; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #AEACA6; }

        /* Animations */
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Notion-like UI */
        .nav-item {
            display: flex; align-items: center; padding: 6px 12px; margin-bottom: 2px;
            border-radius: 4px; color: #37352F; font-weight: 500; font-size: 14px;
            transition: background-color 0.1s; cursor: pointer; user-select: none;
        }
        .nav-item:hover { background-color: #EFEFED; }
        .nav-item.active { background-color: #EFEFED; font-weight: 600; }
        .nav-item i, .nav-item .emoji { margin-right: 10px; width: 20px; text-align: center; font-size: 16px; color: #787774; }

        input, select, textarea {
            background-color: transparent; border: 1px solid #E9E9E7; color: #37352F;
            border-radius: 4px; padding: 6px 10px; font-size: 14px; transition: all 0.2s;
        }
        input:focus, select:focus, textarea:focus { border-color: #A4A29E; outline: none; box-shadow: 0 0 0 2px rgba(46, 170, 220, 0.1); }
        input::placeholder, textarea::placeholder { color: rgba(55, 53, 47, 0.4); }
        
        .btn-notion {
            display: inline-flex; align-items: center; justify-content: center;
            padding: 4px 10px; font-size: 13px; border-radius: 4px; font-weight: 500;
            transition: background-color 0.1s; cursor: pointer; border: 1px solid rgba(55, 53, 47, 0.16);
            color: #37352F; background: white;
        }
        .btn-notion:hover { background-color: #EFEFED; }
        .btn-notion-primary { background-color: #2383E2; color: white; border: 1px solid #2383E2; }
        .btn-notion-primary:hover { background-color: #1D70C2; }

        .collapse-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; border-top: 0px solid #4A4238; }
        .collapse-content.open { max-height: 3000px; }
        
        /* Transitions for Forms - FIXED */
        #task-form-panel, #drink-form-panel, #order-form-panel, #sub-form-panel, #lit-form-panel, #course-form-panel {
            transition: max-height 0.4s ease-in-out, opacity 0.4s ease-in-out, margin 0.4s, padding 0.4s;
            max-height: 0; 
            opacity: 0; 
            overflow: hidden; 
            
            /* Initial closed state: no padding, no border, no margin to be truly invisible */
            padding: 0;
            margin: 0;
            border: none;
        }
        
        #task-form-panel.open, #drink-form-panel.open, #order-form-panel.open, #sub-form-panel.open, #lit-form-panel.open, #course-form-panel.open {
            max-height: 2000px; /* Enough height */
            opacity: 1; 
            
            /* Open state styles */
            margin-bottom: 1.5rem; 
            padding: 1.5rem; /* p-6 equivalent */
            border: 1px solid #E9E9E7;
            border-radius: 6px; /* rounded-md */
        }

        .notion-callout { padding: 16px; border-radius: 4px; display: flex; align-items: flex-start; }
        .notion-callout-icon { font-size: 24px; margin-right: 12px; margin-top: -2px; }
        #drop-zone.dragover { background-color: #E6F3F7; border-color: #2383E2; }

        .schedule-cell { min-height: 60px; border-bottom: 1px solid #E9E9E7; border-right: 1px solid #E9E9E7; position: relative; }
        .course-block { position: absolute; left: 2px; right: 2px; top: 2px; bottom: 2px; border-radius: 4px; padding: 4px; font-size: 11px; font-weight: 500; color: #37352F; display: flex; flex-direction: column; justify-content: center; text-align: center; z-index: 10; overflow: hidden; text-overflow: ellipsis; }
        
        /* Custom Grid for Schedule (Time + 5 Days) */
        .grid-schedule { display: grid; grid-template-columns: 85px repeat(5, 1fr); }
        
        /* Cover Image Styles */
        #page-cover-container {
            position: relative;
            width: 100%;
            height: 200px; 
            background-color: #F1F1EF; /* default gray */
            overflow: hidden;
            background-size: cover;
            background-position: center;
        }
        #page-cover-container:hover #change-cover-btn { opacity: 1; }
        #change-cover-btn { opacity: 0; transition: opacity 0.2s ease-in-out; }

    </style>
</head>
<body class="h-screen flex overflow-hidden bg-notion-bg text-notion-text">

    <!-- Sidebar -->
    <aside class="w-60 bg-notion-sidebar border-r border-notion-border flex-shrink-0 flex flex-col h-full transition-all duration-300 hidden md:flex">
        
        <!-- Sidebar Top: Date & Backup Actions -->
        <div class="p-4 border-b border-notion-border/50">
            <!-- Corrected Date Display -->
            <div id="sidebar-date-display" class="font-bold text-xl text-notion-text mb-4 px-1 tracking-tight leading-tight min-h-[3rem]">
                <!-- Date will be injected here -->
            </div>
            
            <!-- Updated Buttons: Row layout -->
            <div class="flex gap-2">
                 <button onclick="backupAllData()" class="btn-notion flex-1 justify-center text-xs text-notion-dim hover:text-notion-text" title="åŒ¯å‡ºæ‰€æœ‰è³‡æ–™">
                    <i class="fas fa-download mr-1"></i>åŒ¯å‡º
                </button>
                 <label class="btn-notion flex-1 justify-center text-xs text-notion-dim hover:text-notion-text cursor-pointer" title="åŒ¯å…¥å‚™ä»½æª”">
                    <i class="fas fa-upload mr-1"></i>åŒ¯å…¥
                    <input type="file" class="hidden" onchange="importAllData(this)">
                </label>
            </div>
        </div>

        <!-- Navigation (Sorted Alphabetically) -->
        <div class="flex-1 overflow-y-auto px-2 py-2 space-y-0.5 custom-scroll">
            <div class="text-xs font-semibold text-notion-dim px-3 py-2 mt-2">FAVORITES</div>
            
            <div onclick="switchTab('dashboard')" id="btn-dashboard" class="nav-item active">
                <span class="emoji">ğŸ </span>Dashboard
            </div>
            
            <div class="text-xs font-semibold text-notion-dim px-3 py-2 mt-4">PRIVATE</div>
            
            <!-- Sorted A-Z -->
            <div onclick="switchTab('academia')" id="btn-academia" class="nav-item">
                <span class="emoji">ğŸ“</span>Academia
            </div>
            
            <div onclick="switchTab('drinks')" id="btn-drinks" class="nav-item">
                <span class="emoji">ğŸ§‹</span>Drinks Log
            </div>

            <div onclick="switchTab('debt')" id="btn-debt" class="nav-item">
                <span class="emoji">ğŸ’°</span>Finance
            </div>

            <div onclick="switchTab('literature')" id="btn-literature" class="nav-item">
                <span class="emoji">ğŸ“š</span>Literature
            </div>

            <div onclick="switchTab('notebook')" id="btn-notebook" class="nav-item">
                <span class="emoji">ğŸ““</span>Notebook
            </div>

            <div onclick="switchTab('planner')" id="btn-planner" class="nav-item">
                <span class="emoji">ğŸ“…</span>Planner
            </div>

            <div onclick="switchTab('purchasing')" id="btn-purchasing" class="nav-item">
                <span class="emoji">ğŸ›ï¸</span>Purchase Agent
            </div>
            
            <div onclick="switchTab('resources')" id="btn-resources" class="nav-item">
                <span class="emoji">ğŸ“‚</span>Resources
            </div>

            <div onclick="switchTab('subs')" id="btn-subs" class="nav-item">
                <span class="emoji">ğŸ’³</span>Subscriptions
            </div>
        </div>
    </aside>

    <!-- Mobile Nav Bar (Bottom) -->
    <div class="md:hidden fixed bottom-0 left-0 right-0 h-16 bg-white border-t border-notion-border z-50 flex justify-around items-center px-2">
        <button onclick="switchTab('dashboard')" class="flex flex-col items-center justify-center w-full h-full text-notion-dim hover:text-notion-text">
            <i class="fas fa-home text-lg mb-1"></i><span class="text-[10px]">Home</span>
        </button>
        <button onclick="switchTab('notebook')" class="flex flex-col items-center justify-center w-full h-full text-notion-dim hover:text-notion-text">
            <i class="fas fa-book text-lg mb-1"></i><span class="text-[10px]">Notes</span>
        </button>
        <button onclick="switchTab('planner')" class="flex flex-col items-center justify-center w-full h-full text-notion-dim hover:text-notion-text">
            <i class="fas fa-calendar-alt text-lg mb-1"></i><span class="text-[10px]">Planner</span>
        </button>
        <button onclick="switchTab('resources')" class="flex flex-col items-center justify-center w-full h-full text-notion-dim hover:text-notion-text">
            <i class="fas fa-folder text-lg mb-1"></i><span class="text-[10px]">Files</span>
        </button>
        <button onclick="showMoreMenu()" class="flex flex-col items-center justify-center w-full h-full text-notion-dim hover:text-notion-text">
            <i class="fas fa-ellipsis-h text-lg mb-1"></i><span class="text-[10px]">More</span>
        </button>
    </div>

    <!-- Mobile More Menu -->
    <div id="mobile-more-menu" class="hidden md:hidden fixed inset-0 bg-black/50 z-50" onclick="hideMoreMenu()">
        <div class="absolute bottom-16 right-4 bg-white rounded-lg shadow-xl w-48 py-2 overflow-hidden animate-fade-in-up" onclick="event.stopPropagation()">
            <!-- Sorted Mobile Menu (excluding bottom bar items) -->
            <div onclick="switchTab('academia'); hideMoreMenu()" class="px-4 py-3 hover:bg-notion-hover flex items-center gap-3 border-b border-gray-100">
                <span>ğŸ“</span> Academia
            </div>
            <div onclick="switchTab('drinks'); hideMoreMenu()" class="px-4 py-3 hover:bg-notion-hover flex items-center gap-3 border-b border-gray-100">
                <span>ğŸ§‹</span> Drinks
            </div>
            <div onclick="switchTab('debt'); hideMoreMenu()" class="px-4 py-3 hover:bg-notion-hover flex items-center gap-3 border-b border-gray-100">
                <span>ğŸ’°</span> Finance
            </div>
            <div onclick="switchTab('literature'); hideMoreMenu()" class="px-4 py-3 hover:bg-notion-hover flex items-center gap-3 border-b border-gray-100">
                <span>ğŸ“š</span> Literature
            </div>
            <div onclick="switchTab('purchasing'); hideMoreMenu()" class="px-4 py-3 hover:bg-notion-hover flex items-center gap-3 border-b border-gray-100">
                <span>ğŸ›ï¸</span> Shop
            </div>
            <div onclick="switchTab('subs'); hideMoreMenu()" class="px-4 py-3 hover:bg-notion-hover flex items-center gap-3">
                <span>ğŸ’³</span> Subscriptions
            </div>
        </div>
    </div>


    <!-- Main Content Area -->
    <main class="flex-1 h-full overflow-y-auto relative bg-white">
        <!-- Top Cover Image Area (Fixed Layout) -->
        <div id="page-cover-container" class="bg-gradient-to-r from-pink-100 via-purple-100 to-indigo-100 opacity-90 group relative w-full h-48 md:h-64">
            <!-- Default gradient is background-color fallback -->
            <label id="change-cover-btn" class="absolute bottom-2 right-4 btn-notion text-xs bg-white/80 hover:bg-white cursor-pointer shadow-sm z-10">
                <i class="fas fa-image mr-1"></i> æ›´æ›å°é¢
                <input type="file" class="hidden" accept="image/*" onchange="uploadCover(this)">
            </label>
            <button onclick="removeCover()" class="absolute bottom-2 right-28 btn-notion text-xs bg-white/80 hover:bg-white shadow-sm z-10 text-red-500" title="ç§»é™¤å°é¢"><i class="fas fa-times"></i></button>
        </div>
        
        <div class="max-w-5xl mx-auto px-4 md:px-12 pb-24 md:pb-12 relative z-10">
            
            <!-- Page Icon -->
            <div class="text-6xl md:text-7xl mb-4 select-none -mt-10 md:-mt-12">ğŸ“’</div>

            <!-- Header Title Area -->
            <div class="mb-8 border-b border-notion-border pb-4 flex flex-col md:flex-row justify-between items-start md:items-end gap-4">
                <div>
                    <h1 class="text-3xl md:text-4xl font-bold text-notion-text mb-1" id="page-title">Dashboard</h1>
                    <div class="text-sm text-notion-dim flex items-center gap-2" id="page-desc">
                        <span>æœ€å¾Œæ›´æ–°: <span id="dashboard-date">--</span></span>
                    </div>
                </div>
                
                <!-- Mobile Only Actions -->
                <div class="flex gap-2 md:hidden">
                    <button onclick="backupAllData()" class="btn-notion hover:bg-notion-gray-bg text-notion-dim text-xs">
                        <i class="fas fa-download mr-1"></i>åŒ¯å‡º
                    </button>
                    <label class="btn-notion hover:bg-notion-gray-bg text-notion-dim cursor-pointer text-xs">
                        <i class="fas fa-upload mr-1"></i>åŒ¯å…¥
                        <input type="file" class="hidden" onchange="importAllData(this)">
                    </label>
                </div>
            </div>

            <!-- Content Container -->
            <div id="content-area">
                
                <!-- Tab 0: Dashboard -->
                <div id="tab-dashboard" class="section-content fade-in space-y-8">
                    <!-- Quote & Info -->
                    <div class="bg-notion-gray-bg rounded-md p-6 flex flex-col md:flex-row items-center justify-between">
                        <div class="flex-1 border-l-4 border-notion-text pl-4 py-1">
                            <p class="text-xl font-korean text-notion-text leading-relaxed">"ë©ˆì¶°ì„œë„ ê´œì°®ì•„ ì•„ë¬´ ì´ìœ ë„ ëª¨ë¥´ëŠ” ì±„ ë‹¬ë¦´ í•„ìš” ì—†ì´"</p>
                        </div>
                         <div id="dash-next-sub-header" class="text-sm text-right mt-4 md:mt-0 md:border-l border-gray-300 md:pl-6 md:ml-6 flex-shrink-0">
                             <div class="text-xs text-notion-dim font-bold uppercase tracking-wider">è¿‘æœŸæ‰£æ¬¾</div>
                             <div id="dash-next-sub-content" class="font-medium text-notion-text text-lg">ç„¡</div>
                         </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <!-- Left Column -->
                        <div class="space-y-8">
                            <!-- To Do List -->
                            <section>
                                <h3 class="text-lg font-bold mb-3 flex items-center border-b border-notion-border pb-2">
                                    <span class="mr-2">ğŸ“</span> To Do List
                                </h3>
                                <div id="dashboard-tasks" class="space-y-1">
                                    <div class="text-sm text-notion-dim pl-2">è¼‰å…¥ä¸­...</div>
                                </div>
                            </section>

                            <!-- Course Notebook -->
                            <section>
                                <h3 class="text-lg font-bold mb-3 flex items-center border-b border-notion-border pb-2">
                                    <span class="mr-2">ğŸ““</span> Course Notebook
                                </h3>
                                <div id="dash-course-list-notes" class="space-y-1">
                                    <div class="text-sm text-notion-dim pl-2 italic">è«‹å…ˆè‡³ã€Œå­¸æ¥­èˆ‡èª²è¡¨ã€æ–°å¢èª²ç¨‹</div>
                                </div>
                            </section>
                        </div>

                        <!-- Right Column -->
                        <div class="space-y-8">
                            <!-- Bookmarks -->
                            <section>
                                <div class="flex justify-between items-center mb-3 border-b border-notion-border pb-2">
                                    <h3 class="text-lg font-bold flex items-center"><span class="mr-2">ğŸ”–</span> Bookmarks</h3>
                                    <button onclick="addBookmark()" class="text-notion-dim hover:text-notion-text"><i class="fas fa-plus"></i></button>
                                </div>
                                <ul id="dash-bookmarks" class="space-y-1">
                                    <li class="text-sm text-notion-dim pl-2">æš«ç„¡æ›¸ç±¤</li>
                                </ul>
                            </section>

                            <!-- Upcoming -->
                            <section>
                                <h3 class="text-lg font-bold mb-3 flex items-center border-b border-notion-border pb-2">
                                    <span class="mr-2">â³</span> Upcoming & Due
                                </h3>
                                <ul id="dash-due-dates" class="space-y-2">
                                    <li class="text-sm text-notion-dim pl-2">ç„¡è¿‘æœŸäº‹é …</li>
                                </ul>
                            </section>
                        </div>
                    </div>
                </div>

                <!-- Tab: Resources -->
                <div id="tab-resources" class="section-content hidden fade-in space-y-8">
                     <!-- Recent Source -->
                     <section>
                        <h3 class="text-lg font-bold mb-3 flex items-center border-b border-notion-border pb-2">
                            <span class="mr-2">ğŸ“„</span> Recent Sources (From Literature)
                        </h3>
                        <div id="dash-recent-sources" class="space-y-1 overflow-y-auto custom-scroll">
                            <div class="text-sm text-notion-dim">å°šç„¡æ–‡ç»è³‡æ–™</div>
                        </div>
                    </section>

                     <!-- File Archive -->
                     <section>
                        <h3 class="text-lg font-bold mb-3 flex items-center border-b border-notion-border pb-2">
                            <span class="mr-2">ğŸ“‚</span> æ­¸æª”ç´€éŒ„ (File Log)
                        </h3>
                        <div id="drop-zone" class="border border-dashed border-gray-300 rounded p-6 text-center cursor-pointer hover:bg-notion-hover mb-4 transition bg-notion-gray-bg/30">
                            <i class="fas fa-cloud-upload-alt text-2xl text-notion-dim mb-2"></i>
                            <div class="text-sm text-notion-text font-medium">æ‹–æ›³æª”æ¡ˆè‡³æ­¤å»ºç«‹ç´€éŒ„</div>
                            <div class="text-xs text-notion-dim mt-1">(åƒ…è¨˜éŒ„æª”åèˆ‡é€£çµï¼Œæª”æ¡ˆè«‹è‡ªè¡Œä¸Šå‚³é›²ç«¯)</div>
                        </div>
                        <ul id="dash-drive-files" class="space-y-2 text-sm custom-scroll"></ul>
                    </section>
                </div>

                <!-- Tab 1: Planner -->
                <div id="tab-planner" class="section-content hidden fade-in">
                    <div class="flex justify-end mb-4">
                        <button onclick="toggleTaskForm()" class="btn-notion btn-notion-primary">
                            <i class="fas fa-plus mr-1"></i> æ–°å¢å¾…è¾¦
                        </button>
                    </div>

                    <!-- Task Form -->
                    <div id="task-form-panel" class="bg-notion-gray-bg rounded-md border border-notion-border">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                            <input type="date" id="task-date" class="w-full">
                            <div class="flex items-center gap-2">
                                <input type="time" id="task-time" class="w-full">
                                <label class="text-sm text-notion-dim whitespace-nowrap"><input type="checkbox" id="task-allday" onchange="toggleTimeInput()"> å…¨æ—¥</label>
                            </div>
                            <select id="task-priority" class="md:col-span-2">
                                <option value="q1">ğŸ”¥ ç·Šæ€¥ä¸”é‡è¦</option>
                                <option value="q2">â­ é‡è¦ä½†ä¸ç·Šæ€¥</option>
                                <option value="q3">âš¡ ç·Šæ€¥ä½†ä¸é‡è¦</option><option value="q4">â˜• ä¸é‡è¦ä¸ç·Šæ€¥</option>
                            </select>
                        </div>
                        <input type="text" id="task-title" placeholder="ä»»å‹™æ¨™é¡Œ" class="w-full font-bold mb-4">
                        <textarea id="task-content" rows="3" placeholder="è©³ç´°å…§å®¹..." class="w-full mb-4"></textarea>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <input type="text" id="task-location" placeholder="åœ°é»">
                            <input type="text" id="task-url" placeholder="ç›¸é—œé€£çµ">
                        </div>
                        <div class="flex justify-end gap-2">
                            <button onclick="toggleTaskForm()" class="btn-notion">å–æ¶ˆ</button>
                            <button onclick="addTask()" class="btn-notion btn-notion-primary">ç¢ºèªæ–°å¢</button>
                        </div>
                    </div>

                    <!-- Calendar Nav -->
                    <div class="flex justify-between items-center mb-4 mt-8">
                        <button onclick="changeMonth(-1)" class="btn-notion"><i class="fas fa-chevron-left"></i></button>
                        <h2 id="calendar-month-year" class="text-xl font-bold"></h2>
                        <button onclick="changeMonth(1)" class="btn-notion"><i class="fas fa-chevron-right"></i></button>
                    </div>
                    
                    <!-- Calendar Grid -->
                    <div class="grid grid-cols-7 text-center text-xs font-semibold text-notion-dim mb-2 border-b border-notion-border pb-2">
                        <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
                    </div>
                    <div id="calendar-grid" class="grid grid-cols-7 gap-1"></div>

                    <!-- Task List -->
                    <h3 class="text-lg font-bold mt-8 mb-4 border-b border-notion-border pb-2">å¾…è¾¦æ¸…å–®</h3>
                    <div class="bg-notion-gray-bg/50 p-2 rounded">
                        <div class="flex justify-between items-center p-2">
                             <span class="text-sm font-semibold text-notion-dim">æ‰€æœ‰äº‹é …</span>
                             <button onclick="toggleCollapse('matrix-content', 'icon-matrix-view')" class="text-notion-dim hover:text-notion-text"><i id="icon-matrix-view" class="fas fa-chevron-down"></i></button>
                        </div>
                        <ul id="all-tasks-list" class="divide-y divide-notion-border collapse-content open" id="matrix-content"></ul>
                        <div id="empty-tasks-msg" class="hidden p-8 text-center text-notion-dim text-sm">ç›®å‰æ²’æœ‰å¾…è¾¦äº‹é …</div>
                    </div>
                </div>

                <!-- Tab 1.5: Academia -->
                <div id="tab-academia" class="section-content hidden fade-in">
                    <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
                        <!-- New Semester Tabs -->
                        <div class="flex flex-col md:flex-row gap-4 items-start md:items-center w-full md:w-auto overflow-x-auto">
                            <div class="flex bg-notion-gray-bg p-1 rounded-md shrink-0" id="semester-tabs">
                                <button onclick="switchSemester('114-1')" id="sem-btn-114-1" class="px-3 py-1 rounded text-sm font-bold transition">114-1</button>
                                <button onclick="switchSemester('114-2')" id="sem-btn-114-2" class="px-3 py-1 rounded text-sm font-bold text-notion-dim hover:bg-white/50 transition">114-2</button>
                                <button onclick="switchSemester('115-1')" id="sem-btn-115-1" class="px-3 py-1 rounded text-sm font-bold text-notion-dim hover:bg-white/50 transition">115-1</button>
                                <button onclick="switchSemester('115-2')" id="sem-btn-115-2" class="px-3 py-1 rounded text-sm font-bold text-notion-dim hover:bg-white/50 transition">115-2</button>
                            </div>
                            
                            <div class="flex gap-2 shrink-0">
                                <div class="notion-callout bg-notion-blue-bg py-1 px-3 flex items-center text-sm">
                                    <span class="mr-2">ğŸ“</span> <span id="acad-gpa" class="font-bold">0.0</span> <span class="text-notion-dim text-xs ml-1">/ 4.5</span>
                                </div>
                                <div class="notion-callout bg-notion-green-bg py-1 px-3 flex items-center text-sm">
                                    <span class="mr-2">ğŸ“Š</span> <span id="acad-total-credits" class="font-bold">0</span> <span class="text-notion-dim text-xs ml-1">/ 42</span>
                                </div>
                            </div>
                        </div>
                        <button onclick="toggleCourseForm()" class="btn-notion btn-notion-primary ml-auto"><i class="fas fa-plus mr-1"></i> èª²ç¨‹</button>
                    </div>

                    <!-- Course Form -->
                    <div id="course-form-panel" class="bg-notion-gray-bg rounded-md border border-notion-border">
                         <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                            <input type="text" id="course-name" placeholder="èª²ç¨‹åç¨±" class="md:col-span-2">
                            <input type="number" id="course-credits" placeholder="å­¸åˆ†" value="2">
                            <!-- New Grade Inputs -->
                            <input type="number" id="course-target-grade" placeholder="ç›®æ¨™æˆç¸¾">
                            <input type="number" id="course-grade" placeholder="å¯¦éš›æˆç¸¾">
                            
                            <!-- Type Selector -->
                            <select id="course-type">
                                <option value="å¿…ä¿®">å¿…ä¿®</option>
                                <option value="å¿…é¸ä¿®">å¿…é¸ä¿®</option>
                                <option value="é¸ä¿®">é¸ä¿®</option>
                            </select>
                            <select id="course-day">
                                <option value="1">é€±ä¸€</option><option value="2">é€±äºŒ</option><option value="3">é€±ä¸‰</option>
                                <option value="4">é€±å››</option><option value="5">é€±äº”</option>
                            </select>
                            <select id="course-start"></select>
                            <select id="course-end"></select>
                            <!-- Hidden Semester Input, value set by JS -->
                            <input type="hidden" id="course-semester">
                            <button onclick="addCourse()" class="btn-notion btn-notion-primary">ä¿å­˜</button>
                        </div>
                    </div>

                    <!-- Course List Table (All Courses) -->
                    <h3 class="text-base font-bold mb-3 mt-6">èª²ç¨‹åˆ—è¡¨ (All Courses)</h3>
                    <div class="overflow-x-auto border border-notion-border rounded-md mb-8">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-notion-gray-bg text-notion-dim text-xs">
                                <tr>
                                    <th class="p-3 border-b border-notion-border">å­¸æœŸ</th>
                                    <th class="p-3 border-b border-notion-border">èª²ç¨‹</th>
                                    <th class="p-3 border-b border-notion-border">é¡åˆ¥</th>
                                    <th class="p-3 border-b border-notion-border">å­¸åˆ†</th>
                                    <th class="p-3 border-b border-notion-border">ç›®æ¨™</th>
                                    <th class="p-3 border-b border-notion-border">å¯¦éš›</th>
                                    <th class="p-3 border-b border-notion-border w-16"></th>
                                </tr>
                            </thead>
                            <tbody id="course-list-body" class="divide-y divide-notion-border bg-white"></tbody>
                        </table>
                    </div>

                    <!-- Course Planning Block -->
                    <div class="mb-8">
                        <h3 class="text-base font-bold mb-3 border-b border-notion-border pb-2">èª²ç¨‹è¦åŠƒ (Course Planning)</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <!-- Required -->
                            <div class="bg-notion-gray-bg/50 rounded p-3 border border-notion-border">
                                <div class="text-xs font-bold text-red-600 uppercase mb-2">å¿…ä¿® (Required)</div>
                                <ul id="plan-required" class="space-y-1 text-sm text-notion-text"></ul>
                            </div>
                            <!-- Compulsory Elective -->
                            <div class="bg-notion-gray-bg/50 rounded p-3 border border-notion-border">
                                <div class="text-xs font-bold text-blue-600 uppercase mb-2">å¿…é¸ä¿® (Compulsory Elective)</div>
                                <ul id="plan-comp-elective" class="space-y-1 text-sm text-notion-text"></ul>
                            </div>
                            <!-- Elective -->
                            <div class="bg-notion-gray-bg/50 rounded p-3 border border-notion-border">
                                <div class="text-xs font-bold text-green-600 uppercase mb-2">é¸ä¿® (Elective)</div>
                                <ul id="plan-elective" class="space-y-1 text-sm text-notion-text"></ul>
                            </div>
                        </div>
                    </div>

                    <!-- Schedule -->
                    <h3 class="text-base font-bold mb-3 pt-6 border-t border-notion-border">æœ¬å­¸æœŸèª²è¡¨ (<span id="schedule-title-semester"></span>)</h3>
                    <div class="overflow-x-auto border border-notion-border rounded-md mb-8">
                        <div class="min-w-[600px] bg-white">
                            <!-- Custom Grid: 1 col for time, 5 cols for days -->
                            <div class="grid-schedule border-b border-notion-border bg-notion-gray-bg text-center text-xs font-bold py-2 text-notion-dim">
                                <div>æ™‚é–“</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div>
                            </div>
                            <div id="schedule-container" class="relative"></div>
                        </div>
                    </div>

                </div>

                <!-- Tab: Notebook -->
                <div id="tab-notebook" class="section-content hidden fade-in space-y-8">
                    <!-- Global Note -->
                    <section>
                        <h3 class="text-lg font-bold mb-3 flex items-center border-b border-notion-border pb-2">
                            <span class="mr-2">âœï¸</span> éš¨æ‰‹ç­†è¨˜ (Quick Notes)
                        </h3>
                        <textarea id="notebook-global-note" oninput="saveCourseNotes()" 
                            class="w-full h-48 bg-notion-gray-bg border-none rounded p-4 text-sm resize-y focus:ring-0 leading-relaxed" 
                            placeholder="åœ¨é€™è£¡å¯«ä¸‹ä»»ä½•æƒ³æ³•..."></textarea>
                    </section>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <!-- Course Notes List -->
                        <section>
                             <h3 class="text-lg font-bold mb-3 flex items-center border-b border-notion-border pb-2">
                                <span class="mr-2">ğŸ““</span> èª²ç¨‹ç­†è¨˜ (Course Notes)
                            </h3>
                            <div id="notebook-course-list" class="space-y-2">
                                <!-- JS Injected -->
                            </div>
                        </section>

                        <!-- Literature Notes List -->
                        <section>
                             <h3 class="text-lg font-bold mb-3 flex items-center border-b border-notion-border pb-2">
                                <span class="mr-2">ğŸ“š</span> æ–‡ç»ç­†è¨˜ (Reading Notes)
                            </h3>
                            <div id="notebook-lit-list" class="space-y-2">
                                <!-- JS Injected -->
                            </div>
                        </section>
                    </div>
                </div>

                <!-- Tab 2: Drinks -->
                <div id="tab-drinks" class="section-content hidden fade-in">
                    <div class="flex justify-end mb-4">
                        <button onclick="toggleDrinkForm()" class="btn-notion btn-notion-primary"><i class="fas fa-plus mr-1"></i> ç´€éŒ„é£²å“</button>
                    </div>

                    <div id="drink-form-panel" class="bg-notion-gray-bg rounded-md border border-notion-border">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <input type="date" id="drink-date">
                            <input type="text" id="drink-shop" placeholder="åº—å®¶">
                            <input type="text" id="drink-name" placeholder="å“é …" class="md:col-span-2">
                            <select id="drink-ice">
                                <option value="æ­£å¸¸">æ­£å¸¸å†°</option><option value="å°‘å†°">å°‘å†°</option><option value="å¾®å†°">å¾®å†°</option>
                                <option value="å»å†°">å»å†°</option><option value="å¸¸æº«">å¸¸æº«</option><option value="æº«">æº«</option><option value="ç„¡">ç„¡</option>
                            </select>
                            <div class="flex flex-col">
                                <div class="flex justify-between text-xs text-notion-dim mb-1"><span>ç”œåº¦</span><span id="drink-sugar-display">ç„¡</span></div>
                                <input type="range" id="drink-sugar" min="0" max="6" value="0" step="1">
                            </div>
                            <div class="flex gap-2 items-center md:col-span-2">
                                <input type="number" id="drink-price" placeholder="é‡‘é¡" class="flex-1">
                                <label class="text-xs"><input type="checkbox" id="drink-treat" onchange="toggleDrinkPriceState()"> è«‹å®¢</label>
                                <label class="text-xs"><input type="checkbox" id="drink-meal" onchange="toggleDrinkPriceState()"> éš¨é¤</label>
                                <label class="text-xs"><input type="checkbox" id="drink-eco"> ç’°ä¿</label>
                            </div>
                        </div>
                        <button onclick="addDrink()" class="btn-notion btn-notion-primary w-full">ç´€éŒ„</button>
                    </div>
                    
                    <!-- Added Drink Calendar Here -->
                    <div class="mb-8">
                        <div class="flex justify-between items-center mb-4 border-b border-notion-border pb-2">
                             <h3 class="text-base font-bold">é£²å“æ—¥æ›†</h3>
                             <div class="flex items-center gap-2">
                                 <button onclick="changeDrinkMonth(-1)" class="btn-notion"><i class="fas fa-chevron-left"></i></button>
                                 <span id="drink-calendar-month-year" class="text-sm font-bold"></span>
                                 <button onclick="changeDrinkMonth(1)" class="btn-notion"><i class="fas fa-chevron-right"></i></button>
                             </div>
                        </div>
                        <div class="grid grid-cols-7 text-center text-xs font-semibold text-notion-dim mb-1">
                            <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
                        </div>
                        <div id="drink-calendar-grid" class="grid grid-cols-7 gap-1"></div>
                    </div>

                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                         <div class="notion-callout bg-notion-green-bg flex-col items-center justify-center text-center">
                             <div class="text-xs text-notion-dim uppercase tracking-wider">ç¸½èŠ±è²»</div>
                             <div class="text-2xl font-bold mt-1" id="stat-total-cost">NT$ 0</div>
                             <div class="text-xs text-gray-500 mt-1" id="stat-total-cups">0 æ¯</div>
                         </div>
                         <div class="notion-callout bg-notion-blue-bg flex-col items-center justify-center text-center">
                             <div class="text-xs text-notion-dim uppercase tracking-wider">æœ€å¸¸å»</div>
                             <div class="text-xl font-bold mt-1" id="stat-fav-shop">-</div>
                         </div>
                         <div class="notion-callout bg-notion-red-bg flex-col items-center justify-center text-center">
                             <div class="text-xs text-notion-dim uppercase tracking-wider">æœ€æ„›å–</div>
                             <div class="text-xl font-bold mt-1" id="stat-fav-drink">-</div>
                         </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="md:col-span-2">
                             <h3 class="text-base font-bold mb-3 border-b border-notion-border pb-2">æœ€è¿‘ç´€éŒ„</h3>
                             <div class="overflow-x-auto">
                                <table class="w-full text-sm text-left">
                                    <thead class="text-notion-dim text-xs bg-notion-gray-bg">
                                        <tr><th class="p-2 rounded-l">æ—¥æœŸ</th><th class="p-2">åº—å®¶</th><th class="p-2">å“é …</th><th class="p-2">é‡‘é¡</th><th class="p-2 rounded-r w-8"></th></tr>
                                    </thead>
                                    <tbody id="drink-list-body" class="divide-y divide-notion-border"></tbody>
                                </table>
                             </div>
                        </div>
                        <div class="md:col-span-1">
                            <h3 class="text-base font-bold mb-3 border-b border-notion-border pb-2">æ¶ˆè²»è¶¨å‹¢</h3>
                            <div class="flex flex-col items-center justify-center h-48 bg-notion-gray-bg/30 rounded border border-notion-border p-4">
                                <div id="chart-pie" class="w-24 h-24 rounded-full bg-gray-100 flex items-center justify-center text-xs text-gray-400 mb-4">Chart</div>
                                <div id="chart-legend" class="text-xs space-y-1 w-full"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab 3: Purchasing -->
                <div id="tab-purchasing" class="section-content hidden fade-in">
                    <div class="flex justify-end mb-4">
                        <button onclick="toggleOrderForm()" class="btn-notion btn-notion-primary"><i class="fas fa-plus mr-1"></i> æ–°å¢è¨‚å–®</button>
                    </div>

                    <div id="order-form-panel" class="bg-notion-gray-bg rounded-md border border-notion-border">
                        <h4 class="font-bold mb-4">å»ºç«‹æ–°è¨‚å–®</h4>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                            <input type="date" id="order-date">
                            <input type="text" id="order-code" placeholder="ä»£è™Ÿ">
                            <input type="text" id="order-shop" placeholder="åº—å®¶" class="md:col-span-2">
                            <input type="number" id="order-rate" placeholder="åŒ¯ç‡ (38)" value="38" oninput="calcProfit()">
                            <select id="order-status" class="md:col-span-3"></select>
                        </div>
                        <div class="mb-4 bg-white p-3 rounded border border-notion-border">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm font-bold">å“é …åˆ—è¡¨</span>
                                <button onclick="addOrderItemRow()" class="text-xs text-blue-500 hover:underline">+ å¢åŠ å“é …</button>
                            </div>
                            <div id="order-items-container" class="space-y-2"></div>
                        </div>
                        <div class="grid grid-cols-3 gap-4 mb-4 text-sm">
                            <div class="bg-white p-2 rounded border">æˆæœ¬: <span id="order-twd-cost" class="font-bold">0</span></div>
                            <div class="bg-white p-2 rounded border">å”®åƒ¹: <span id="order-sell-price" class="font-bold">0</span></div>
                            <div class="bg-notion-green-bg p-2 rounded border border-green-200">åˆ©æ½¤: <span id="order-profit" class="font-bold text-green-700">0</span></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <input type="text" id="order-note" placeholder="å‚™è¨»">
                            <div class="flex gap-4 items-center">
                                <label class="text-sm"><input type="checkbox" id="order-paid"> å•†å“å·²æ”¶</label>
                                <label class="text-sm"><input type="checkbox" id="order-shipping"> é‹è²»å·²åŒ¯</label>
                            </div>
                        </div>
                        <button onclick="addOrder()" class="btn-notion btn-notion-primary w-full">å„²å­˜è¨‚å–®</button>
                    </div>

                    <!-- Purchasing Stats -->
                    <div class="grid grid-cols-3 gap-4 mb-6">
                        <div class="notion-callout bg-notion-gray-bg flex-col text-center py-3">
                             <div class="text-xs text-notion-dim">æ·¨åˆ©æ½¤</div>
                             <div class="text-xl font-bold text-green-600" id="stats-net-profit">0</div>
                        </div>
                        <div class="notion-callout bg-notion-gray-bg flex-col text-center py-3">
                             <div class="text-xs text-notion-dim">æœªæ”¶æ¬¾ (è²¨æ¬¾)</div>
                             <div class="text-xl font-bold text-red-500" id="stats-unpaid">0</div>
                        </div>
                        <div class="notion-callout bg-notion-gray-bg flex-col text-center py-3">
                             <div class="text-xs text-notion-dim">è¨‚å–®æ•¸</div>
                             <div class="text-xl font-bold" id="stats-total-orders">0</div>
                        </div>
                    </div>

                    <div class="flex justify-between items-center mb-3 border-b border-notion-border pb-2">
                        <h3 class="text-base font-bold">è¨‚å–®å¸³æœ¬</h3>
                        <div class="flex items-center gap-2 text-xs">
                             <select id="order-sort-select" onchange="updateOrderDisplaySettings()" class="bg-transparent border-none p-0 font-bold"><option value="desc">æ–°â†’èˆŠ</option><option value="asc">èˆŠâ†’æ–°</option></select>
                             <label><input type="checkbox" id="order-filter-unfinished" onchange="updateOrderDisplaySettings()"> åƒ…æœªå®Œæˆ</label>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="text-notion-dim text-xs bg-notion-gray-bg">
                                <tr><th class="p-2 rounded-l">è³‡è¨Š</th><th class="p-2">æ˜ç´°</th><th class="p-2">ç‹€æ…‹</th><th class="p-2">è²¡å‹™</th><th class="p-2">åˆ©æ½¤</th><th class="p-2 rounded-r w-8"></th></tr>
                            </thead>
                            <tbody id="order-list-body" class="divide-y divide-notion-border"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Tab 4: Subs -->
                <div id="tab-subs" class="section-content hidden fade-in">
                     <div class="flex justify-end mb-4">
                        <button onclick="toggleSubForm()" class="btn-notion btn-notion-primary"><i class="fas fa-plus mr-1"></i> æ–°å¢è¨‚é–±</button>
                    </div>

                    <div id="sub-form-panel" class="bg-notion-gray-bg rounded-md border border-notion-border">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                            <input type="text" id="sub-name" placeholder="æœå‹™åç¨±" class="md:col-span-2">
                            <input type="number" id="sub-price" placeholder="é‡‘é¡">
                            <input type="text" id="sub-person" placeholder="åˆ†æ“”äºº">
                            <select id="sub-cycle">
                                <option value="monthly">æ¯æœˆ</option><option value="quarterly">æ¯å­£</option><option value="yearly">æ¯å¹´</option>
                            </select>
                            <input type="date" id="sub-date">
                        </div>
                        <button onclick="addSub()" class="btn-notion btn-notion-primary w-full">å„²å­˜</button>
                    </div>

                    <div class="flex gap-1 mb-4 border-b border-notion-border pb-1">
                        <button id="btn-view-service" onclick="renderSubs('service')" class="px-3 py-1 text-sm rounded hover:bg-notion-hover font-bold text-notion-text">ä¾æœå‹™</button>
                        <button id="btn-view-person" onclick="renderSubs('person')" class="px-3 py-1 text-sm rounded hover:bg-notion-hover text-notion-dim">ä¾äººå“¡</button>
                    </div>
                    <div id="sub-list-container" class="space-y-3"></div>
                </div>

                <!-- Tab 5: Investment -->
                <div id="tab-debt" class="section-content hidden fade-in space-y-8">
                    <!-- Form -->
                    <div id="ledger-form-container" class="bg-notion-gray-bg p-4 rounded-md border border-notion-border">
                        <h3 class="text-sm font-bold mb-3">æ–°å¢ç´€éŒ„</h3>
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
                             <div class="md:col-span-2 flex gap-2">
                                <select id="ledger-category" onchange="updateLedgerTypeOptions()" class="flex-1">
                                    <option value="general">ä¸€èˆ¬å¸³å‹™</option><option value="camera">ç›¸æ©Ÿå¤¢</option>
                                </select>
                                <select id="ledger-type" class="flex-1"></select>
                            </div>
                            <input type="date" id="ledger-date">
                            <input type="text" id="ledger-desc" placeholder="é …ç›®/èªªæ˜">
                            <input type="number" id="ledger-amount" placeholder="é‡‘é¡">
                        </div>
                        <div class="flex gap-2 mt-3 justify-end">
                            <button id="btn-cancel-ledger" onclick="resetLedgerForm()" class="btn-notion hidden">å–æ¶ˆ</button>
                            <button id="btn-save-ledger" onclick="saveLedgerEntry()" class="btn-notion btn-notion-primary">æ–°å¢</button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <h3 class="text-base font-bold mb-3 flex items-center justify-between border-b border-notion-border pb-2">
                                <span>ä¸€èˆ¬å¸³å‹™</span>
                                <span id="debt-header-balance" class="text-xs font-normal bg-notion-gray-bg px-2 py-1 rounded">çµé¤˜: 0</span>
                            </h3>
                            <ul id="debt-list" class="space-y-2"></ul>
                        </div>
                        <div>
                             <h3 class="text-base font-bold mb-3 flex items-center justify-between border-b border-notion-border pb-2">
                                <span>ç›¸æ©Ÿå¤¢åŸºé‡‘</span>
                                <span id="camera-header-balance" class="text-xs font-normal text-green-600 bg-green-50 px-2 py-1 rounded">å­˜: 0</span>
                            </h3>
                             <div class="w-full bg-gray-100 rounded-full h-2 mb-4 overflow-hidden">
                                <div id="camera-bar" class="bg-green-500 h-full transition-all duration-500" style="width: 0%"></div>
                            </div>
                            <ul id="fund-list" class="space-y-2 max-h-96 overflow-y-auto custom-scroll"></ul>
                        </div>
                    </div>
                </div>

                <!-- Tab 6: Literature -->
                <div id="tab-literature" class="section-content hidden fade-in">
                    <div class="flex justify-end mb-4">
                        <button onclick="toggleCollapse('lit-form-panel', 'icon-add-lit')" class="btn-notion btn-notion-primary"><i class="fas fa-plus mr-1"></i> æ–°å¢æ–‡ç»</button>
                    </div>

                    <div id="lit-form-panel" class="bg-notion-gray-bg rounded-md border border-notion-border hidden mb-8">
                        <h4 class="text-xs font-bold text-notion-dim mb-4 uppercase">åŸºæœ¬è³‡è¨Š</h4>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                            <input type="text" id="lit-title" placeholder="æ¨™é¡Œ" class="md:col-span-2 font-bold">
                            <input type="text" id="lit-author" placeholder="ä½œè€…">
                            <input type="text" id="lit-date" placeholder="å¹´ä»½ (2023)">
                            <select id="lit-type"><option>æœŸåˆŠè«–æ–‡</option><option>æ›¸ç±</option><option>å­¸ä½è«–æ–‡</option><option>ç¶²è·¯æ–‡ç« </option><option>å…¶ä»–</option></select>
                            <select id="lit-status"><option>å·²è®€</option><option>é–±è®€ä¸­</option><option>æƒ³è®€</option></select>
                            <input type="text" id="lit-field" placeholder="é ˜åŸŸ" class="md:col-span-2">
                            <input type="text" id="lit-keywords" placeholder="é—œéµå­—" class="md:col-span-4">
                            <input type="text" id="lit-doi" placeholder="DOI">
                            <input type="text" id="lit-theories" placeholder="ç›¸é—œç†è«–" class="md:col-span-3">
                        </div>

                        <h4 class="text-xs font-bold text-notion-dim mb-4 uppercase">è®Šæ•¸æ¨¡å‹</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 bg-white p-4 rounded border border-notion-border">
                            <input type="text" id="lit-method-iv" placeholder="è‡ªè®Šæ•¸ (IV)">
                            <input type="text" id="lit-method-dv" placeholder="å› è®Šæ•¸ (DV)">
                            <input type="text" id="lit-method-med" placeholder="ä¸­ä»‹è®Šæ•¸ (Mediator)">
                            <input type="text" id="lit-method-mod" placeholder="èª¿ç¯€è®Šæ•¸ (Moderator)">
                        </div>

                        <h4 class="text-xs font-bold text-notion-dim mb-4 uppercase">ç ”ç©¶æ ¸å¿ƒ</h4>
                        <div class="space-y-4 mb-6">
                            <textarea id="lit-background" class="w-full" rows="2" placeholder="ç ”ç©¶èƒŒæ™¯..."></textarea>
                            <textarea id="lit-purpose" class="w-full" rows="2" placeholder="ç ”ç©¶ç›®çš„..."></textarea>
                            <textarea id="lit-conclusion" class="w-full" rows="3" placeholder="ç ”ç©¶çµè«–..."></textarea>
                            <textarea id="lit-note" class="w-full" rows="2" placeholder="å€‹äººç­†è¨˜..."></textarea>
                            <input type="text" id="lit-link" placeholder="é€£çµ URL" class="w-full">
                        </div>
                        <button onclick="addLit()" class="btn-notion btn-notion-primary w-full">å„²å­˜æ–‡ç»</button>
                    </div>

                    <div id="lit-list-container" class="space-y-4"></div>
                </div>

            </div> <!-- End Content Container -->
        </div>
    </main>
    
    <!-- Course Note Modal -->
    <div id="course-note-modal" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl h-[80vh] flex flex-col">
            <div class="p-4 border-b border-notion-border flex justify-between items-center">
                <h3 class="font-bold text-lg" id="modal-course-title">èª²ç¨‹ç­†è¨˜</h3>
                <button onclick="closeCourseNote()" class="text-gray-400 hover:text-black"><i class="fas fa-times"></i></button>
            </div>
            <div class="flex-1 p-4 bg-notion-gray-bg/30">
                <textarea id="modal-course-content" class="w-full h-full p-4 border border-notion-border rounded resize-none focus:ring-0 text-sm leading-relaxed" placeholder="åœ¨æ­¤è¼¸å…¥ç­†è¨˜..."></textarea>
            </div>
            <div class="p-4 border-t border-notion-border flex justify-end">
                <button onclick="saveCurrentCourseNote()" class="btn-notion btn-notion-primary">å„²å­˜</button>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-6 right-6 bg-gray-800 text-white px-4 py-3 rounded shadow-lg transform translate-y-32 opacity-0 transition-all duration-300 z-50 text-sm">Notification</div>

    <script>
        // --- CORE FUNCTIONS (Moved to top) ---
        function updateLedgerTypeOptions(){ 
            const c=document.getElementById('ledger-category').value; 
            const t=document.getElementById('ledger-type'); 
            if(c==='general') {
                t.innerHTML='<option value="income">æ”¶å…¥ (Income)</option><option value="expense">æ”¯å‡º (Expense)</option>';
            } else {
                t.innerHTML='<option value="deposit">å­˜å…¥ (Deposit)</option><option value="withdraw">æå– (Withdraw)</option>'; 
            }
        }
        
        function toggleCollapse(contentId, iconId) { 
            const content=document.getElementById(contentId); 
            const icon=document.getElementById(iconId); 
            if(!content) return; 
            
            if(content.classList.contains('open')){
                content.classList.remove('open');
                if(icon) icon.style.transform='rotate(0deg)';
            }else{
                content.classList.add('open');
                if(icon) icon.style.transform='rotate(180deg)';
            } 
        }

        function handleFileClick(id) {
            const f = appData.driveFiles.find(file => file.id === id);
            if (!f) return;
            if (f.url && f.url.trim() !== '') {
                window.open(f.url, '_blank');
            } else {
                editDriveFileUrl(id);
            }
        }
        
        // Define Time Slots (Time + 5 Days)
        const TIME_SLOTS = [
            "08:10~09:00",
            "09:10~10:00",
            "10:10~11:00",
            "11:10~12:00",
            "13:30~14:20",
            "14:30~15:20",
            "15:30~16:20"
        ];
        
        // GLOBAL STATE for Semester
        let currentSemester = '114-1'; 

        // Init appData
        let appData = { tasks: [], drinks: [], orders: [], subs: [], debts: [], cameraFund: { target: 50000, entries: [] }, literature: [], bookmarks: [], courseNotes: "", driveFiles: [], courses: [], coverImage: null };
        let currentCalendarDate = new Date();
        let currentDrinkCalendarDate = new Date();
        let orderSort = 'desc';
        let orderFilterUnfinished = false;
        let editingLedgerId = null; 
        let currentEditingCourseId = null;
        
        const ORDER_STATUSES = ["ç¢ºèªä¸­", "å·²åŒ¯æ¬¾", "å°å¸³å®Œæˆ", "éŸ“åœ‹ç«¯ä¸‹å–®", "éŸ“åœ‹ç«¯å‡ºè²¨", "å¾…é›†é‹å›å°", "å·²æŠµå°", "æŠµå°æ•´ç†ä¸­", "å¾…é¢äº¤", "å·²å¯„å‡º", "è¨‚å–®å®Œæˆ"];
        const SUGAR_LEVELS = ['ç„¡/ç„¡æ³•èª¿æ•´', 'ä¸€åˆ†ç³–', 'äºŒåˆ†ç³–', 'å¾®ç³–', 'åŠç³–', 'å°‘ç³–', 'å…¨ç³–'];

        document.addEventListener('DOMContentLoaded', () => {
            loadData(); 
            updateDate(); 
            // Render Dashboard First
            switchTab('dashboard');
            // Init components for other tabs implicitly
            renderTasks(); 
            renderCalendar(); 
            renderDrinks(); 
            renderDrinkCalendar(); 
            renderStatusOptions();
            renderOrders(); 
            updateStats(); 
            updatePurchasingStats(); 
            renderSubs('service'); 
            renderDebts(); 
            renderCameraFund(); 
            updateLedgerTypeOptions(); 
            renderLiterature(); 
            initAcademiaSelects();
            renderSchedule();
            renderCourseList();
            renderCoursePlanning(); 
            updateAcademicStats();
            initDragAndDrop(); 
            switchSemester('114-1'); // Default init
        });

        // Basic Utils
        function loadData() { 
            const s=localStorage.getItem('retroDashboardData'); 
            if(s){ 
                const p=JSON.parse(s); 
                appData={...appData,...p}; 
                ['tasks','drinks','orders','subs','debts','literature','bookmarks','driveFiles','courses'].forEach(k=>{if(!appData[k])appData[k]=[]}); 
                if(!appData.cameraFund)appData.cameraFund={target:50000,entries:[]};
                if(typeof appData.courseNotes !== 'string') appData.courseNotes = "";
            } 
        }
        function saveData() { localStorage.setItem('retroDashboardData', JSON.stringify(appData)); }
        function showToast(m) { const t=document.getElementById('toast'); t.textContent=m; t.classList.remove('translate-y-32','opacity-0'); setTimeout(()=>{t.classList.add('translate-y-32','opacity-0');},3000); }
        function updateDate() { 
            const n=new Date(); 
            const dateStr = `${n.getFullYear()} / ${String(n.getMonth()+1).padStart(2,'0')} / ${String(n.getDate()).padStart(2,'0')} (${['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][n.getDay()]})`;
            
            // Sidebar Date
            const sidebarEl = document.getElementById('sidebar-date-display');
            if(sidebarEl) sidebarEl.innerHTML = dateStr;

            // Dashboard Header Date
            const dashboardEl = document.getElementById('dashboard-date');
            if(dashboardEl) dashboardEl.innerHTML = dateStr;
            
            // Planner Header Date
            const plannerEl = document.getElementById('current-date'); // Note: ID might be duplicate in old HTML structure, check uniqueness
            if(plannerEl) plannerEl.innerHTML = dateStr;
        }
        
        function switchTab(t) { 
            document.querySelectorAll('.nav-item').forEach(b=>{
                b.classList.remove('active');
                if(b.id===`btn-${t}`) b.classList.add('active');
            });
            // Also handle mobile bottom nav active state if needed (skipped for simplicity)
            
            document.querySelectorAll('.section-content').forEach(s=>{s.classList.add('hidden');if(s.id===`tab-${t}`)s.classList.remove('hidden');}); 
            
            // Update Title
            const titles = { 'dashboard':'Dashboard', 'planner':'Planner', 'drinks':'Drinks Log', 'purchasing':'Purchase Agent', 'subs':'Subscriptions', 'debt':'Finance', 'literature':'Literature', 'academia':'Academia', 'resources':'Resources', 'notebook':'Notebook' };
            const descs = { 'dashboard':'ç¾å¥½çš„ä¸€å¤©ï¼Œå¾é€™è£¡é–‹å§‹ã€‚', 'planner':'ç®¡ç†æ‚¨çš„æ—¥ç¨‹èˆ‡å¾…è¾¦äº‹é …ã€‚', 'drinks':'ç´€éŒ„æ¯ä¸€æ¯å¿«æ¨‚çš„æ³‰æºã€‚', 'purchasing':'è¿½è¹¤ä»£è³¼è¨‚å–®èˆ‡åˆ©æ½¤ã€‚', 'subs':'ç®¡ç†å®šæœŸæ‰£æ¬¾çš„æœå‹™ã€‚', 'debt':'ä¸€èˆ¬çš„è¨˜å¸³èˆ‡å¤¢æƒ³åŸºé‡‘ã€‚', 'literature':'å­¸è¡“æ–‡ç»çš„æ•´ç†èˆ‡ç­†è¨˜ã€‚', 'academia':'èª²è¡¨ã€å­¸åˆ†èˆ‡æˆç¸¾ç®¡ç†ã€‚', 'resources':'æª”æ¡ˆæ­¸æª”èˆ‡è¿‘æœŸåƒè€ƒæ–‡ç»ã€‚', 'notebook':'é›†ä¸­ç®¡ç†æ‰€æœ‰ç­†è¨˜ã€‚' };
            
            const titleEl = document.getElementById('page-title');
            const descEl = document.getElementById('page-desc');
            if(titleEl) titleEl.innerText = titles[t];
            if(descEl) descEl.innerHTML = `<span>${descs[t]}</span>`; 

            if(t==='planner') renderCalendar(); 
            if(t==='drinks') renderDrinkCalendar();
            if(t==='dashboard') { renderDashboard(); renderSchedule('dash-schedule-container'); }
            if(t==='academia') { renderAcademia(); }
            if(t==='resources') { renderDriveFiles(); }
            if(t==='notebook') { renderNotebook(); }
            
            hideMoreMenu();
        }

        // Toggle Collapse Generic
        function toggleCollapse(c, i) { 
            const el=document.getElementById(c); 
            const ic=document.getElementById(i); 
            if(!el) return; 
            if(el.classList.contains('open')){
                el.classList.remove('open');
                if(ic) ic.style.transform='rotate(0deg)';
            }else{
                el.classList.add('open');
                if(ic) ic.style.transform='rotate(180deg)';
            } 
        }

        // --- DASHBOARD ---
        function renderDashboard() {
            const todayStr = new Date().toISOString().split('T')[0];
            
            // Tasks
            const dashTasks = document.getElementById('dashboard-tasks');
            if(dashTasks) {
                dashTasks.innerHTML = '';
                const todayTasks = appData.tasks.filter(t => t.date === todayStr && !t.completed);
                const q1Tasks = appData.tasks.filter(t => t.quadrant === 'q1' && !t.completed && t.date !== todayStr);
                const combinedTasks = [...todayTasks, ...q1Tasks].slice(0, 5); 
                
                if(combinedTasks.length === 0) dashTasks.innerHTML = '<div class="text-sm text-notion-dim pl-2 italic">ç„¡ç·Šæ€¥å¾…è¾¦</div>';
                else {
                    combinedTasks.forEach(t => {
                        const isToday = t.date === todayStr;
                        dashTasks.innerHTML += `
                        <div class="flex items-start gap-2 p-1 hover:bg-notion-hover rounded cursor-default">
                            <input type="checkbox" onclick="toggleTask(${t.id}); renderDashboard()" class="mt-1 cursor-pointer">
                            <div class="flex-1 min-w-0">
                                <div class="text-sm font-medium ${isToday ? 'text-black' : 'text-red-600'} truncate">${t.title}</div>
                                <div class="text-[10px] text-notion-dim">${t.date} ${t.time || ''}</div>
                            </div>
                        </div>`;
                    });
                }
            }

            // --- Course Notes (New Logic) ---
            const noteList = document.getElementById('dash-course-list-notes');
            if(noteList) {
                noteList.innerHTML = '';
                if(appData.courses.length === 0) {
                    noteList.innerHTML = '<div class="text-sm text-notion-dim pl-2 italic">è«‹å…ˆè‡³ã€Œå­¸æ¥­èˆ‡èª²è¡¨ã€æ–°å¢èª²ç¨‹</div>';
                } else {
                    appData.courses.forEach(c => {
                        noteList.innerHTML += `
                            <div onclick="openCourseNote(${c.id})" class="cursor-pointer p-2 hover:bg-notion-hover rounded flex items-center group transition">
                                <span class="text-lg mr-2">ğŸ““</span>
                                <span class="text-sm font-medium text-notion-text group-hover:underline flex-1">${c.name}</span>
                                <span class="text-[10px] text-notion-dim bg-white border border-notion-border px-1 rounded">Edit</span>
                            </div>
                        `;
                    });
                }
            }

            // Bookmarks
            renderBookmarks();

            // Upcoming
            const dueList = document.getElementById('dash-due-dates');
            if(dueList) {
                dueList.innerHTML = '';
                const upcomingTasks = appData.tasks.filter(t => !t.completed && t.date >= todayStr).sort((a,b) => new Date(a.date) - new Date(b.date)).slice(0, 5); 
                if(upcomingTasks.length === 0) dueList.innerHTML = '<div class="text-sm text-notion-dim pl-2 italic">ç„¡è¿‘æœŸäº‹é …</div>';
                else {
                    upcomingTasks.forEach(t => {
                        const diffTime = new Date(t.date) - new Date(todayStr);
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                        let badgeText = diffDays === 0 ? 'ä»Šå¤©' : (diffDays === 1 ? 'æ˜å¤©' : `${diffDays}å¤©å¾Œ`);
                        dueList.innerHTML += `
                        <div class="flex justify-between items-center text-sm p-1">
                            <span class="truncate pr-2">${t.title}</span>
                            <span class="text-xs bg-notion-gray-bg text-notion-dim px-1.5 py-0.5 rounded whitespace-nowrap">${badgeText}</span>
                        </div>`;
                    });
                }
            }

            // Subscription (Header)
            const dashNextSubHeader = document.getElementById('dash-next-sub-content');
            if(dashNextSubHeader) {
                const currentDay = new Date().getDate();
                let nextSub = null;
                let minDiff = 999;
                appData.subs.forEach(s => {
                    if(!s.date) return;
                    const day = new Date(s.date).getDate();
                    let diff = day - currentDay;
                    if (diff < 0) diff += 30; 
                    if (diff < minDiff) { minDiff = diff; nextSub = s; }
                });
                if (nextSub) dashNextSubHeader.innerHTML = `<span class="font-bold text-gray-800">${nextSub.name}</span> <span class="text-xs text-gray-500">($${nextSub.price})</span>`;
                else dashNextSubHeader.innerText = "ç„¡";
            }

            // Drive Log
            renderDriveFiles();
            
            // Recent Sources
            const sourceList = document.getElementById('dash-recent-sources');
            if(sourceList) {
                sourceList.innerHTML = '';
                const recentLits = [...appData.literature].sort((a,b) => b.id - a.id).slice(0, 5);
                if(recentLits.length === 0) {
                    sourceList.innerHTML = '<div class="text-xs text-gray-400 italic">å°šç„¡æ–‡ç»è³‡æ–™</div>';
                } else {
                    recentLits.forEach(l => {
                        sourceList.innerHTML += `
                        <div class="text-xs border-b border-notion-border pb-1 mb-1 last:border-0">
                            <div class="font-bold text-notion-text truncate">${l.title}</div>
                            <div class="text-[10px] text-notion-dim truncate">${l.author}</div>
                        </div>`;
                    });
                }
            }
        }
        
        // --- COURSE NOTE MODAL ---
        function openCourseNote(id) {
            const course = appData.courses.find(c => c.id === id);
            if(course) {
                currentEditingCourseId = id;
                document.getElementById('modal-course-title').innerText = `${course.name} - ç­†è¨˜`;
                document.getElementById('modal-course-content').value = course.note || "";
                document.getElementById('course-note-modal').classList.remove('hidden');
            }
        }
        function closeCourseNote() {
            document.getElementById('course-note-modal').classList.add('hidden');
            currentEditingCourseId = null;
        }
        function saveCurrentCourseNote() {
            if(currentEditingCourseId) {
                const course = appData.courses.find(c => c.id === currentEditingCourseId);
                if(course) {
                    course.note = document.getElementById('modal-course-content').value;
                    saveData(); 
                    showToast("ç­†è¨˜å·²å„²å­˜"); 
                    closeCourseNote();
                    // If in notebook tab, refresh it
                    if(!document.getElementById('tab-notebook').classList.contains('hidden')) {
                        renderNotebook();
                    }
                }
            }
        }

        // --- BOOKMARKS ---
        function renderBookmarks() {
            const list = document.getElementById('dash-bookmarks'); if(!list) return;
            list.innerHTML = '';
            if(appData.bookmarks.length === 0) list.innerHTML = '<li class="text-sm text-notion-dim pl-2">æš«ç„¡æ›¸ç±¤</li>';
            appData.bookmarks.forEach(b => {
                list.innerHTML += `<li class="flex justify-between items-center group p-1 hover:bg-notion-hover rounded"><a href="${b.url}" target="_blank" class="flex items-center text-sm text-blue-600 hover:underline truncate"><i class="fas fa-link text-xs mr-2 text-gray-400"></i>${b.title}</a><button onclick="deleteBookmark(${b.id})" class="text-gray-300 hover:text-red-400 opacity-0 group-hover:opacity-100 px-2"><i class="fas fa-times"></i></button></li>`;
            });
        }
        function addBookmark() {
            const title = prompt("ç¶²ç«™åç¨±ï¼š"); if(!title) return;
            const url = prompt("ç¶²å€ï¼š", "https://"); if(!url) return;
            appData.bookmarks.push({ id: Date.now(), title, url }); saveData(); renderBookmarks();
        }
        function deleteBookmark(id) { if(confirm("ç§»é™¤æ­¤æ›¸ç±¤ï¼Ÿ")) { appData.bookmarks = appData.bookmarks.filter(b => b.id !== id); saveData(); renderBookmarks(); } }
        function saveCourseNotes() { appData.courseNotes = document.getElementById('dash-course-note').value; saveData(); }

        // --- PLANNER ---
        function toggleTimeInput(){document.getElementById('task-time').disabled=document.getElementById('task-allday').checked;}
        function toggleTaskForm(){
            const p=document.getElementById('task-form-panel'); 
            p.classList.toggle('hidden');
        }
        function addTask(){
            const d=document.getElementById('task-date').value; 
            const t=document.getElementById('task-title').value; 
            if(!t.trim()||!d)return showToast("è«‹è¼¸å…¥æ—¥æœŸèˆ‡æ¨™é¡Œ"); 
            appData.tasks.push({
                id:Date.now(),date:d, time:document.getElementById('task-time').value, isAllDay:document.getElementById('task-allday').checked,
                quadrant:document.getElementById('task-priority').value, title:t,text:t,
                content:document.getElementById('task-content').value, location:document.getElementById('task-location').value, url:document.getElementById('task-url').value, completed:false
            }); 
            saveData(); renderTasks(); renderCalendar(); showToast("å·²æ–°å¢"); toggleTaskForm();
        }
        function renderTasks(){
            const list = document.getElementById('all-tasks-list'); if(!list) return;
            list.innerHTML = '';
            if(appData.tasks.length === 0) { document.getElementById('empty-tasks-msg').classList.remove('hidden'); return; }
            document.getElementById('empty-tasks-msg').classList.add('hidden');
            const sortedTasks = [...appData.tasks].sort((a,b) => { if (a.completed !== b.completed) return a.completed ? 1 : -1; return new Date(a.date) - new Date(b.date); });
            sortedTasks.forEach(t => {
                const qLabels = { q1: "ğŸ”¥", q2: "â­", q3: "âš¡", q4: "â˜•" };
                const li = document.createElement('li');
                li.className = `p-3 hover:bg-notion-hover transition flex gap-3 items-start ${t.completed ? 'opacity-50 line-through' : ''}`;
                li.innerHTML = `<input type="checkbox" ${t.completed ? 'checked' : ''} onchange="toggleTask(${t.id})" class="mt-1 cursor-pointer"><div class="flex-1"><div class="text-sm font-medium text-notion-text">${qLabels[t.quadrant]||''} ${t.title}</div><div class="text-xs text-notion-dim mt-0.5"><i class="far fa-clock"></i> ${t.date} ${t.time || ''}</div>${t.content ? `<div class="text-xs text-gray-500 mt-1">${t.content}</div>` : ''}</div><button onclick="deleteTask(${t.id})" class="text-gray-300 hover:text-red-400"><i class="fas fa-trash-alt"></i></button>`;
                list.appendChild(li);
            });
        }
        function toggleTask(id){ const t=appData.tasks.find(x=>x.id===id); if(t){t.completed=!t.completed; saveData(); renderTasks(); renderDashboard();}}
        function deleteTask(id){ if(confirm("åˆªé™¤ï¼Ÿ")){appData.tasks=appData.tasks.filter(x=>x.id!==id); saveData(); renderTasks(); renderCalendar(); renderDashboard();}}
        function renderCalendar(){
            const g=document.getElementById('calendar-grid'); if(!g)return; g.innerHTML=''; 
            const d=new Date(currentCalendarDate.getFullYear(),currentCalendarDate.getMonth(),1); const m=d.getMonth(); 
            document.getElementById('calendar-month-year').textContent=`${d.getFullYear()} / ${m+1}`; 
            for(let i=0;i<d.getDay();i++){g.innerHTML+='<div></div>';} 
            while(d.getMonth()===m){ 
                const dateStr=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; 
                const hasTask=appData.tasks.some(t=>t.date===dateStr && !t.completed); 
                g.innerHTML+=`<div class="h-16 border border-notion-border rounded p-1 text-xs relative ${hasTask?'bg-notion-yellow-bg':''}"><span class="font-bold">${d.getDate()}</span>${hasTask ? '<div class="w-1.5 h-1.5 bg-red-400 rounded-full absolute top-1.5 right-1.5"></div>' : ''}</div>`; 
                d.setDate(d.getDate()+1); 
            } 
        }
        function changeMonth(d){currentCalendarDate.setMonth(currentCalendarDate.getMonth()+d); renderCalendar();}

        // --- ACADEMIA ---
        function toggleCourseForm(){ const p=document.getElementById('course-form-panel'); p.classList.toggle('hidden'); 
            // Set form semester to current view semester
            if(document.getElementById('course-semester')) {
                document.getElementById('course-semester').value = currentSemester;
            }
        }
        
        // Updated Academia Selects for Time Ranges
        function initAcademiaSelects() {
            const start=document.getElementById('course-start'), end=document.getElementById('course-end');
            if(!start) return;
            let ops=''; 
            // TIME_SLOTS is 0-indexed array, so we map index+1 to value
            TIME_SLOTS.forEach((time, index) => {
                ops += `<option value="${index+1}">${time}</option>`;
            });
            start.innerHTML=ops; end.innerHTML=ops;
        }
        
        // NEW: Switch Semester Logic
        function switchSemester(sem) {
            currentSemester = sem;
            // Update Tab UI
            ['114-1', '114-2', '115-1', '115-2'].forEach(s => {
                const btn = document.getElementById(`sem-btn-${s}`);
                if(btn) {
                    if(s === sem) {
                        btn.className = "px-3 py-1 rounded text-sm font-bold bg-white shadow-sm text-notion-text transition";
                    } else {
                        btn.className = "px-3 py-1 rounded text-sm font-bold text-notion-dim hover:bg-white/50 transition";
                    }
                }
            });
            renderAcademia();
        }

        function renderAcademia() {
             renderSchedule('schedule-container'); 
             renderCourseList(); 
             renderCoursePlanning(); // NEW
             updateAcademicStats();
        }

        function addCourse() {
            const n=document.getElementById('course-name').value;
            if(!n) return showToast("è«‹è¼¸å…¥åç¨±");
            appData.courses.push({
                id:Date.now(), name:n, credits:parseInt(document.getElementById('course-credits').value)||0,
                grade:parseFloat(document.getElementById('course-grade').value)||0, 
                target:parseFloat(document.getElementById('course-target-grade').value)||0, // NEW field
                day:parseInt(document.getElementById('course-day').value),
                start:parseInt(document.getElementById('course-start').value), end:parseInt(document.getElementById('course-end').value),
                semester: currentSemester, // Use global current semester
                type: document.getElementById('course-type').value // NEW Field
            });
            saveData(); renderAcademia(); toggleCourseForm();
        }
        function deleteCourse(id){ if(confirm("åˆªé™¤ï¼Ÿ")){appData.courses=appData.courses.filter(c=>c.id!==id); saveData(); renderAcademia();} }
        
        // Updated Render Schedule to accept target container
        function renderSchedule(containerId) {
            const c=document.getElementById(containerId); if(!c)return;
            
            let h=''; 
            
            // Loop through defined time slots
            TIME_SLOTS.forEach((timeRange, index) => {
                const periodIndex = index + 1;
                // Grid columns: 1 for time + 5 for days (Mon-Fri) = 6 columns
                h += `<div class="grid-schedule border-b border-notion-border text-center">
                        <div class="text-[10px] text-notion-dim py-2 border-r border-notion-border flex items-center justify-center bg-notion-gray-bg/30 px-1 leading-tight">${timeRange.replace('~', '<br>~<br>')}</div>`;
                
                // Days 1 to 5 (Mon to Fri)
                for(let d=1; d<=5; d++){
                    h+=`<div class="schedule-cell relative" data-d="${d}" data-p="${periodIndex}"></div>`;
                }
                h+='</div>';
            });

            c.innerHTML=h;
            
            const colors=['bg-red-100 text-red-800','bg-blue-100 text-blue-800','bg-green-100 text-green-800','bg-purple-100 text-purple-800','bg-yellow-100 text-yellow-800'];
            
            // Filter courses by global currentSemester
            const filteredCourses = appData.courses.filter(c => c.semester === currentSemester || !c.semester); 

            filteredCourses.forEach((co, idx)=>{
                // Skip if day is Saturday (6) or Sunday (0) just in case old data exists
                if(co.day > 5) return;

                const cells = c.querySelectorAll(`.schedule-cell[data-d="${co.day}"]`);
                cells.forEach(cell => {
                    if(parseInt(cell.dataset.p) === co.start) {
                        const dur = co.end - co.start + 1;
                        const rowHeight = 61; // 60px min-height + 1px border
                        
                        const block = document.createElement('div');
                        block.className = `course-block absolute inset-1 rounded p-1 text-[10px] font-bold leading-tight flex flex-col justify-center items-center z-10 ${colors[idx%colors.length]}`;
                        block.style.height = `${(rowHeight * dur) - 4}px`; // -4 for margin/inset
                        block.style.zIndex = '20';
                        
                        block.innerHTML = co.name;
                        cell.appendChild(block);
                    }
                });
            });
        }
        
        // NEW: Course Planning Render
        function renderCoursePlanning() {
            const types = {
                'required': { id: 'plan-required', label: 'å¿…ä¿®' },
                'comp-elective': { id: 'plan-comp-elective', label: 'å¿…é¸ä¿®' },
                'elective': { id: 'plan-elective', label: 'é¸ä¿®' }
            };

            // Clear lists
            for (let t in types) {
                const el = document.getElementById(types[t].id);
                if(el) el.innerHTML = '';
            }

            // Loop all courses (Planning view shows ALL semesters usually)
            appData.courses.forEach(c => {
                let targetId = null;
                // Normalize type checking
                const cType = c.type || '';
                if (cType === 'å¿…ä¿®') targetId = types['required'].id;
                else if (cType === 'å¿…é¸ä¿®') targetId = types['comp-elective'].id;
                else if (cType === 'é¸ä¿®') targetId = types['elective'].id;
                
                if (targetId) {
                    const el = document.getElementById(targetId);
                    if(el) {
                        el.innerHTML += `<li class="flex justify-between border-b border-notion-border last:border-0 py-1">
                            <span>${c.name}</span>
                            <span class="text-notion-dim text-xs">${c.credits}å­¸åˆ†</span>
                        </li>`;
                    }
                }
            });
        }
        
        // Updated Course List (Table)
        function renderCourseList(){
            const tbody = document.getElementById('course-list-body'); 
            if(!tbody) return; 
            tbody.innerHTML='';
            
            // Show ALL courses, sorted by semester descending then id
            const allCourses = [...appData.courses].sort((a,b) => {
                // simple string compare for semester is fine for 114-1, 114-2 etc
                if (a.semester !== b.semester) return (a.semester || '') > (b.semester || '') ? -1 : 1; 
                return b.id - a.id;
            });

            allCourses.forEach(c=>{
                tbody.innerHTML+=`
                <tr class="hover:bg-notion-hover border-b border-notion-border last:border-0">
                    <td class="p-3 font-bold text-notion-dim">${c.semester || '-'}</td>
                    <td class="p-3 font-medium text-notion-text">${c.name}</td>
                    <td class="p-3 text-xs text-notion-dim">${c.type || 'æœªåˆ†é¡'}</td>
                    <td class="p-3 text-sm">${c.credits}</td>
                    <td class="p-3 text-sm font-mono text-notion-dim">${c.target > 0 ? c.target : '-'}</td>
                    <td class="p-3 text-sm font-mono font-bold">${c.grade > 0 ? c.grade : '-'}</td>
                    <td class="p-3 text-right">
                        <div class="flex justify-end gap-2">
                             <button onclick="openCourseNote(${c.id})" class="text-gray-400 hover:text-notion-text" title="ç­†è¨˜"><i class="fas fa-edit"></i></button>
                             <button onclick="deleteCourse(${c.id})" class="text-gray-300 hover:text-red-500" title="åˆªé™¤"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                </tr>`;
            });
        }
        
        function updateAcademicStats(){
            // Stats calculation: Cumulative (All Semesters) as requested
            let tc=0, ws=0, vc=0;
            // Use ALL appData.courses regardless of semester
            appData.courses.forEach(c=>{ 
                const cred = parseInt(c.credits) || 0;
                tc += cred; 
                if(c.grade > 0){
                    ws += (c.grade * cred); 
                    vc += cred;
                } 
            });
            document.getElementById('acad-total-credits').innerText=tc;
            document.getElementById('acad-gpa').innerText=vc>0?(ws/vc).toFixed(2):"0.0";
        }

        // --- DRINKS ---
        function toggleDrinkForm(){ document.getElementById('drink-form-panel').classList.toggle('hidden'); }
        function toggleDrinkPriceState(){const dis=document.getElementById('drink-treat').checked||document.getElementById('drink-meal').checked; const p=document.getElementById('drink-price'); p.disabled=dis; if(dis)p.value='';}
        function updateSugarDisplay(){document.getElementById('drink-sugar-display').innerText = SUGAR_LEVELS[document.getElementById('drink-sugar').value];}
        function addDrink(){
            const d=document.getElementById('drink-date').value; const s=document.getElementById('drink-shop').value; const n=document.getElementById('drink-name').value;
            if(!d||!s||!n) return showToast("è«‹è¼¸å…¥å®Œæ•´è³‡è¨Š");
            let p=parseFloat(document.getElementById('drink-price').value)||0;
            const tr=document.getElementById('drink-treat').checked; const m=document.getElementById('drink-meal').checked;
            if(tr||m) p=0;
            appData.drinks.unshift({id:Date.now(),date:d,shop:s,name:n,ice:document.getElementById('drink-ice').value,sugar:SUGAR_LEVELS[document.getElementById('drink-sugar').value],price:p,isTreat:tr,isMeal:m,isEco:document.getElementById('drink-eco').checked});
            saveData(); renderDrinks(); updateStats(); toggleDrinkForm(); renderDrinkCalendar();
        }
        function renderDrinks(){
            const b=document.getElementById('drink-list-body'); if(!b)return; b.innerHTML='';
            appData.drinks.slice(0,20).forEach(d=>{
                b.innerHTML+=`<tr class="hover:bg-notion-hover"><td class="p-2 border-b border-notion-border">${d.date}</td><td class="p-2 border-b border-notion-border font-medium">${d.shop}</td><td class="p-2 border-b border-notion-border text-notion-dim">${d.name}</td><td class="p-2 border-b border-notion-border font-bold">${d.isTreat?'ğŸ':d.isMeal?'ğŸ±':d.price}</td><td class="p-2 border-b border-notion-border"><button onclick="deleteDrink(${d.id})" class="text-gray-300 hover:text-red-500"><i class="fas fa-trash"></i></button></td></tr>`;
            });
        }
        function deleteDrink(id){if(confirm("åˆªé™¤ï¼Ÿ")){appData.drinks=appData.drinks.filter(d=>d.id!==id); saveData(); renderDrinks(); updateStats(); renderDrinkCalendar();}}
        function updateStats(){
            const y=new Date().getFullYear(); const ds=appData.drinks.filter(d=>new Date(d.date).getFullYear()===y);
            document.getElementById('stat-total-cost').innerText = `NT$ ${ds.reduce((a,b)=>a+b.price,0)}`;
            document.getElementById('stat-total-cups').innerText = `${ds.length} æ¯`;
        }
        function renderDrinkCalendar(){
            const g=document.getElementById('drink-calendar-grid'); if(!g)return; g.innerHTML=''; 
            const d=new Date(currentDrinkCalendarDate.getFullYear(),currentDrinkCalendarDate.getMonth(),1); 
            const m=d.getMonth(); 
            document.getElementById('drink-calendar-month-year').textContent=`${d.getFullYear()} / ${m+1}`; 
            for(let i=0;i<d.getDay();i++){g.innerHTML+='<div></div>';} 
            while(d.getMonth()===m){ 
                const dateStr=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; 
                const cups=appData.drinks.filter(dr=>dr.date===dateStr).length; 
                g.innerHTML+=`<div class="h-12 border border-notion-border rounded p-1 text-xs relative flex items-center justify-center hover:bg-notion-hover ${cups>0?'bg-notion-blue-bg':''}"><span class="${cups>0?'font-bold text-blue-600':''}">${d.getDate()}</span>${cups>0 ? `<span class="absolute bottom-0.5 right-1 text-[8px] text-notion-dim">ğŸ¥¤${cups}</span>` : ''}</div>`; 
                d.setDate(d.getDate()+1); 
            } 
        }
        function changeDrinkMonth(d){currentDrinkCalendarDate.setMonth(currentDrinkCalendarDate.getMonth()+d); renderDrinkCalendar();}

        // --- PURCHASING ---
        function toggleOrderForm(){ document.getElementById('order-form-panel').classList.toggle('hidden'); renderStatusOptions(); }
        function renderStatusOptions(){ const s=document.getElementById('order-status'); if(s && s.children.length===0) s.innerHTML=ORDER_STATUSES.map(o=>`<option>${o}</option>`).join(''); }
        function addOrderItemRow(){ 
            const c=document.getElementById('order-items-container');
            const d=document.createElement('div'); d.className="grid grid-cols-4 gap-2 mb-2 item-row";
            d.innerHTML=`<input class="col-span-2 item-name" placeholder="å“å"><input type="number" class="item-qty" placeholder="æ•¸" value="1" oninput="calcProfit()"><input type="number" class="item-krw" placeholder="â‚©" oninput="calcProfit()">`;
            c.appendChild(d);
        }
        function calcProfit(){
            const rate=parseFloat(document.getElementById('order-rate').value)||38;
            let tk=0; document.querySelectorAll('.item-row').forEach(r=>{ tk+= (parseFloat(r.querySelector('.item-krw').value)||0) * (parseFloat(r.querySelector('.item-qty').value)||0); });
            const cost = Math.ceil(tk/rate);
            document.getElementById('order-twd-cost').innerText = cost;
        }
        function addOrder(){
             const d=document.getElementById('order-date').value;
             if(!d) return showToast("è«‹è¼¸å…¥æ—¥æœŸ");
             let items = [];
             document.querySelectorAll('.item-row').forEach(row => {
                 items.push({name: row.querySelector('.item-name').value, qty: row.querySelector('.item-qty').value, krw: row.querySelector('.item-krw').value});
             });
             appData.orders.unshift({
                 id:Date.now(), date:d, 
                 code:document.getElementById('order-code').value,
                 shop:document.getElementById('order-shop').value,
                 status:document.getElementById('order-status').value,
                 items: items,
                 sell: parseFloat(document.getElementById('order-sell-price')?.value) || 0,
                 paid: document.getElementById('order-paid').checked
             });
             saveData(); renderOrders(); updatePurchasingStats(); toggleOrderForm();
        }
        function renderOrders(){
            const b=document.getElementById('order-list-body'); if(!b)return; b.innerHTML='';
            appData.orders.slice(0,20).forEach(o=>{
                 b.innerHTML+=`<tr class="hover:bg-notion-hover"><td class="p-2 border-b border-notion-border"><div class="font-medium">${o.date}</div><div class="text-xs text-notion-dim">${o.code||''}</div></td><td class="p-2 border-b border-notion-border text-sm">${o.items?o.items.map(i=>i.name).join(', '):o.name}</td><td class="p-2 border-b border-notion-border"><span class="bg-notion-gray-bg px-2 py-0.5 rounded text-xs">${o.status}</span></td><td class="p-2 border-b border-notion-border text-sm">${o.paid?'å·²æ”¶':'<span class="text-red-500">æœªæ”¶</span>'}</td><td class="p-2 border-b border-notion-border font-bold text-green-600">${o.profit||0}</td><td class="p-2 border-b border-notion-border"><button onclick="deleteOrder(${o.id})" class="text-gray-300 hover:text-red-500"><i class="fas fa-trash"></i></button></td></tr>`;
            });
        }
        function updatePurchasingStats(){
            const unpaid = appData.orders.filter(o=>!o.paid).reduce((a,b)=>a+(b.sell||0),0);
            document.getElementById('stats-unpaid').innerText = unpaid;
        }
        function deleteOrder(id){ if(confirm("åˆªé™¤ï¼Ÿ")){appData.orders=appData.orders.filter(o=>o.id!==id); saveData(); renderOrders(); updatePurchasingStats();} }

        // --- SUBSCRIPTIONS ---
        function toggleSubForm(){ document.getElementById('sub-form-panel').classList.toggle('hidden'); }
        function addSub(){
             appData.subs.push({
                 id:Date.now(),
                 name:document.getElementById('sub-name').value,
                 price:parseFloat(document.getElementById('sub-price').value),
                 person:document.getElementById('sub-person').value,
                 cycle:document.getElementById('sub-cycle').value,
                 date:document.getElementById('sub-date').value
             });
             saveData(); renderSubs('service'); toggleSubForm();
        }
        function renderSubs(view){
            const c=document.getElementById('sub-list-container'); c.innerHTML='';
            const groups = {};
            appData.subs.forEach(s => {
                const k = view === 'service' ? s.name : s.person;
                if(!groups[k]) groups[k] = [];
                groups[k].push(s);
            });
            const b1=document.getElementById('btn-view-service'), b2=document.getElementById('btn-view-person');
            if(view==='service') { b1.classList.add('text-black','font-bold'); b2.classList.remove('text-black','font-bold'); }
            else { b2.classList.add('text-black','font-bold'); b1.classList.remove('text-black','font-bold'); }
            for(let k in groups){
                let html = `<div class="mb-4 border border-notion-border rounded bg-white"><div class="p-3 bg-notion-gray-bg font-bold text-sm border-b border-notion-border flex justify-between"><span>${k||'æœªå‘½å'}</span><span>$${groups[k].reduce((a,b)=>a+b.price,0)}</span></div>`;
                groups[k].forEach(s=>{
                    html += `<div class="p-3 text-sm flex justify-between items-center border-b border-notion-border last:border-0"><div>${view==='service'?s.person:s.name} <span class="text-xs text-notion-dim bg-gray-100 px-1 rounded">${s.cycle}</span></div><div class="flex gap-3"><span>$${s.price}</span><button onclick="deleteSub(${s.id})" class="text-gray-300 hover:text-red-500"><i class="fas fa-times"></i></button></div></div>`;
                });
                html += '</div>';
                c.innerHTML += html;
            }
        }
        function deleteSub(id){ if(confirm("åˆªé™¤ï¼Ÿ")){appData.subs=appData.subs.filter(s=>s.id!==id); saveData(); renderSubs('service');} }

        // --- INVESTMENT ---
        function saveLedgerEntry(){
             const type = document.getElementById('ledger-type').value || (document.getElementById('ledger-category').value === 'general' ? 'expense' : 'deposit');
             const amount = parseFloat(document.getElementById('ledger-amount').value);
             const item = {id:Date.now(), date:document.getElementById('ledger-date').value, desc:document.getElementById('ledger-desc').value, amount: amount, type: type};
             
             if(document.getElementById('ledger-category').value === 'general') appData.debts.unshift(item);
             else appData.cameraFund.entries.unshift(item);
             
             saveData(); renderDebts(); renderCameraFund(); 
             document.getElementById('ledger-desc').value=''; document.getElementById('ledger-amount').value='';
        }
        function renderDebts(){
            const l=document.getElementById('debt-list'); l.innerHTML='';
            appData.debts.forEach(d=>{
                l.innerHTML+=`<li class="flex justify-between p-2 border-b border-notion-border text-sm"><span>${d.desc||d.person}</span><span class="${(d.type=='expense'||d.type=='owe')?'text-red-500':'text-green-600'}">$${d.amount}</span><button onclick="deleteDebt(${d.id})" class="text-gray-300 hover:text-red-500 ml-2"><i class="fas fa-trash"></i></button></li>`;
            });
        }
        function deleteDebt(id){ if(confirm("åˆªé™¤ï¼Ÿ")){appData.debts=appData.debts.filter(d=>d.id!==id); saveData(); renderDebts();} }
        function renderCameraFund(){
            const l=document.getElementById('fund-list'); l.innerHTML='';
            let total=0;
            appData.cameraFund.entries.forEach(e=>{
                total += (e.type==='withdraw' ? -e.amount : e.amount);
                l.innerHTML+=`<li class="flex justify-between p-2 border-b border-notion-border text-sm"><span>${e.desc}</span><span class="${e.type=='withdraw'?'text-red-500':'text-green-600'}">$${e.amount}</span></li>`;
            });
            document.getElementById('camera-bar').style.width = Math.min((total/50000)*100, 100) + '%';
            document.getElementById('camera-header-balance').innerText = `å­˜: $${total}`;
        }

        // --- LITERATURE ---
        function addLit(){
            appData.literature.unshift({
                id:Date.now(),
                title:document.getElementById('lit-title').value,
                author:document.getElementById('lit-author').value,
                status:document.getElementById('lit-status').value
            });
            saveData(); renderLiterature(); document.getElementById('lit-form-panel').classList.add('hidden');
        }
        function renderLiterature(){
            const c=document.getElementById('lit-list-container'); c.innerHTML='';
            appData.literature.forEach(l=>{
                c.innerHTML+=`<div class="bg-white border border-notion-border rounded p-4 mb-2"><div class="font-bold text-lg">${l.title}</div><div class="text-sm text-notion-dim">${l.author} Â· <span class="bg-notion-gray-bg px-2 rounded text-xs">${l.status}</span></div></div>`;
            });
        }
        function renderRecentSources() {
             const sourceList = document.getElementById('dash-recent-sources');
            if(sourceList) {
                sourceList.innerHTML = '';
                const recentLits = [...appData.literature].sort((a,b) => b.id - a.id).slice(0, 5);
                if(recentLits.length === 0) {
                    sourceList.innerHTML = '<div class="text-xs text-gray-400 italic">å°šç„¡æ–‡ç»è³‡æ–™</div>';
                } else {
                    recentLits.forEach(l => {
                        sourceList.innerHTML += `<div class="text-xs border-b border-notion-border pb-1 mb-1 last:border-0"><div class="font-bold text-notion-text truncate">${l.title}</div><div class="text-[10px] text-notion-dim truncate">${l.author}</div></div>`;
                    });
                }
            }
        }

        // --- FILES & BACKUP ---
        function initDragAndDrop() {
            const z = document.getElementById('drop-zone'); if(!z) return;
            z.addEventListener('dragover', e => { e.preventDefault(); z.classList.add('dragover'); });
            z.addEventListener('dragleave', e => { e.preventDefault(); z.classList.remove('dragover'); });
            z.addEventListener('drop', e => {
                e.preventDefault(); z.classList.remove('dragover');
                [...e.dataTransfer.files].forEach(f => {
                    appData.driveFiles.unshift({id:Date.now(), name:f.name, date:new Date().toLocaleDateString(), url:''});
                });
                saveData(); renderDriveFiles();
            });
        }
        function renderDriveFiles(){
            const l=document.getElementById('dash-drive-files'); if(!l)return; l.innerHTML='';
            appData.driveFiles.forEach(f=>{
                l.innerHTML+=`<li class="flex justify-between items-center p-1 hover:bg-notion-hover rounded"><div class="truncate flex-1"><i class="fas fa-file text-notion-dim mr-2"></i><a href="${f.url||'#'}" target="_blank" class="hover:underline cursor-pointer" onclick="if(!'${f.url}') editDriveFileUrl(${f.id})">${f.name}</a></div><div class="flex gap-1"><button onclick="editDriveFileUrl(${f.id})" class="text-gray-400 hover:text-black"><i class="fas fa-link"></i></button><button onclick="deleteDriveFile(${f.id})" class="text-gray-300 hover:text-red-500"><i class="fas fa-times"></i></button></div></li>`;
            });
        }
        function editDriveFileUrl(id){
             const f=appData.driveFiles.find(x=>x.id===id);
             const u=prompt("è¼¸å…¥é€£çµ URL:", f.url||"");
             if(u!==null){ f.url=u; saveData(); renderDriveFiles(); }
        }
        function deleteDriveFile(id){ if(confirm("ç§»é™¤?")){ appData.driveFiles=appData.driveFiles.filter(f=>f.id!==id); saveData(); renderDriveFiles(); } }
        
        function backupAllData() {
            const a = document.createElement('a');
            a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(appData));
            a.download = "Notion_Backup_" + new Date().toISOString().split('T')[0] + ".json";
            a.click();
        }
        function importAllData(input) {
            const f = input.files[0]; if(!f) return;
            const r = new FileReader();
            r.onload = e => {
                try {
                    const d = JSON.parse(e.target.result);
                    if(d.debts && Array.isArray(d.debts) && !d.tasks) {
                         if(d.debts) appData.debts = [...d.debts.map(x=>({...x, person:x.item, status:'unsettled'})), ...appData.debts];
                         if(d.cameraFund) appData.cameraFund.entries = [...d.cameraFund.map(x=>({...x, desc:x.item})), ...appData.cameraFund.entries];
                    } else {
                        appData = { ...appData, ...d };
                    }
                    saveData(); location.reload();
                } catch(err) { alert("åŒ¯å…¥å¤±æ•—"); }
            };
            r.readAsText(f);
        }
        
        // Mobile Menu
        function showMoreMenu(){ document.getElementById('mobile-more-menu').classList.remove('hidden'); }
        function hideMoreMenu(){ document.getElementById('mobile-more-menu').classList.add('hidden'); }

        // --- COVER IMAGE UPLOAD ---
        function uploadCover(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const base64 = e.target.result;
                appData.coverImage = base64;
                saveData();
                renderCover();
            }
            reader.readAsDataURL(file);
            input.value = ''; 
        }

        function removeCover() {
            if(confirm("ç¢ºå®šè¦ç§»é™¤å°é¢ç…§ç‰‡å—ï¼Ÿ")) {
                appData.coverImage = null;
                saveData();
                renderCover();
            }
        }

        function renderCover() {
            const container = document.getElementById('page-cover-container');
            const removeBtn = container.querySelector('button[title="ç§»é™¤å°é¢"]'); 
            
            if (appData.coverImage) {
                container.style.backgroundImage = `url('${appData.coverImage}')`;
                container.classList.remove('bg-gradient-to-r'); 
                if(removeBtn) removeBtn.classList.remove('hidden');
            } else {
                container.style.backgroundImage = '';
                container.classList.add('bg-gradient-to-r'); 
                if(removeBtn) removeBtn.classList.add('hidden');
            }
        }

        const originalLoadData = loadData;
        loadData = function() {
            originalLoadData();
            if (!appData.coverImage) appData.coverImage = null;
            renderCover();
        };

        // --- INITIALIZATION ---
        // Ensure functions are defined before running init logic if script order matters
        // All functions are defined above.
    </script>
</body>
</html>