<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- Google Fonts: Cinzel for headers, Lora for body -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Lora:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        morandi: {
                            bg: '#F4F1EA',      /* èƒŒæ™¯ï¼šç±³ç™½ */
                            paper: '#EAE5DE',   /* å´é‚Šæ¬„ï¼šç°ç±³ */
                            green: '#8F9E8B',   /* ç¶  */
                            blue: '#8CA0A8',    /* è— */
                            pink: '#C4A8A6',    /* ç²‰ */
                            brown: '#8D7F71',   /* æ·ºæ£• */
                            dark: '#4A4238',    /* æ·±æ£• (é‚Šæ¡†/æ–‡å­—) */
                            accent: '#A67F78'   /* ç£šç´… */
                        }
                    },
                    fontFamily: {
                        serif: ['Lora', 'serif'],
                        display: ['Cinzel', 'serif'],
                    },
                    boxShadow: {
                        'retro': '4px 4px 0px 0px #4A4238',
                        'retro-sm': '2px 2px 0px 0px #4A4238',
                        'retro-hover': '1px 1px 0px 0px #4A4238',
                        'retro-deep': '8px 8px 0px 0px #4A4238',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Lora', serif;
            color: #4A4238;
            background-color: #F4F1EA;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.05'/%3E%3C/svg%3E");
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #EAE5DE;
        }
        ::-webkit-scrollbar-thumb {
            background: #8D7F71; 
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #4A4238;
        }

        /* Animations */
        .fade-in {
            animation: fadeIn 0.4s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Interactive Elements Transition */
        .btn-retro {
            transition: all 0.1s;
        }
        .btn-retro:active {
            transform: translate(2px, 2px);
            box-shadow: 1px 1px 0px 0px #4A4238;
        }

        /* Tab Active State */
        .tab-btn {
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .tab-btn:hover {
            background-color: rgba(141, 127, 113, 0.1);
        }
        .tab-btn.active {
            background-color: #4A4238;
            color: #F4F1EA;
            border: 2px solid #4A4238;
            box-shadow: 3px 3px 0px 0px rgba(141, 127, 113, 0.5);
            transform: translate(-1px, -1px);
        }
        
        /* Input Styles */
        input, select, textarea {
            background-color: #FCFAF8;
            border: 2px solid #4A4238;
            color: #4A4238;
            outline: none;
            transition: all 0.2s;
            box-shadow: 2px 2px 0px 0px transparent;
            font-size: 16px; 
        }
        input:focus, select:focus, textarea:focus {
            box-shadow: 4px 4px 0px 0px #A67F78;
            transform: translate(-2px, -2px);
        }
        input:disabled {
            background-color: #EAE5DE;
            cursor: not-allowed;
            opacity: 0.6;
            color: #8D7F71;
        }
        
        input[readonly] {
            background-color: #EAE5DE;
            color: #8D7F71;
            cursor: not-allowed;
        }

        /* Range Slider Styling */
        input[type=range] {
            -webkit-appearance: none;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #4A4238;
            border: 2px solid #F4F1EA;
            cursor: pointer;
            margin-top: -8px; 
            box-shadow: 1px 1px 3px rgba(0,0,0,0.3);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #8D7F71;
            border-radius: 2px;
        }

        /* Checkbox Customization */
        input[type="checkbox"] {
            appearance: none;
            width: 1.2rem;
            height: 1.2rem;
            border: 2px solid #4A4238;
            background-color: white;
            cursor: pointer;
            display: grid;
            place-content: center;
        }
        input[type="checkbox"]::before {
            content: "";
            width: 0.65em;
            height: 0.65em;
            transform: scale(0);
            transition: 120ms transform ease-in-out;
            box-shadow: inset 1em 1em #4A4238;
        }
        input[type="checkbox"]:checked::before {
            transform: scale(1);
        }

        /* Collapse Transition */
        .collapse-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            border-top: 0px solid #4A4238;
        }
        .collapse-content.open {
            max-height: 3000px; /* Increased for longer literature forms */
            border-top: 2px solid #4A4238;
        }
        
        /* Specific transitions */
        #task-form-panel, #drink-form-panel, #order-form-panel, #sub-form-panel, #lit-form-panel {
            transition: max-height 0.4s ease-in-out, opacity 0.4s ease-in-out, margin 0.4s;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            margin-bottom: 0;
        }
        #task-form-panel.open, #drink-form-panel.open, #order-form-panel.open, #sub-form-panel.open, #lit-form-panel.open {
            max-height: 3000px;
            opacity: 1;
            margin-bottom: 1.5rem;
        }

        /* Calendar Styles */
        .calendar-day {
            min-height: 60px; /* Mobile */
            transition: all 0.2s;
        }
        @media (min-width: 768px) {
            .calendar-day {
                min-height: 100px; /* Desktop */
            }
        }
        .calendar-day:hover {
            background-color: rgba(141, 127, 113, 0.1);
        }
        .calendar-day.today {
            background-color: rgba(234, 229, 222, 0.5);
            border: 2px solid #A67F78;
        }
        
        /* Mobile Sticky Nav Shadow */
        .mobile-nav-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        /* Hide Scrollbar */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col md:flex-row max-w-7xl mx-auto md:my-8 bg-morandi-bg">

    <!-- Sidebar / Topbar Navigation -->
    <nav class="w-full md:w-24 bg-morandi-paper border-b-2 md:border-b-0 md:border-2 border-morandi-dark md:shadow-retro-deep p-2 md:p-4 flex flex-col gap-2 md:gap-6 shrink-0 z-50 sticky top-0 md:relative md:h-[calc(100vh-4rem)] md:top-8 mobile-nav-shadow md:shadow-none transition-all duration-300">
        
        <!-- Header (Logo) -->
        <div class="flex justify-between items-center md:flex-col md:text-center md:pb-6 md:border-b-2 md:border-morandi-dark md:border-dashed px-2 md:px-0">
            <!-- Desktop: Compact Logo -->
            <div class="border-2 border-morandi-dark p-1 bg-white shadow-retro-sm md:w-full md:aspect-square md:flex md:items-center md:justify-center md:p-1">
                <p class="text-xs text-center font-bold text-morandi-dark font-display tracking-wider leading-tight">
                    <span class="md:hidden"><i class="fas fa-quote-left mr-1"></i>Carpe Diem<i class="fas fa-quote-right ml-1"></i></span>
                    <span class="hidden md:block text-[10px]">Carpe<br>Diem</span>
                </p>
            </div>
            <!-- Mobile Only Year -->
            <div class="md:hidden ml-3 text-[10px] text-morandi-brown font-bold tracking-widest border border-morandi-brown px-1 rounded">2025</div>
        </div>

        <!-- Menu Items (Emoji Style) -->
        <div class="flex flex-row md:flex-col gap-2 md:gap-4 overflow-x-auto md:overflow-visible pb-1 md:pb-0 scrollbar-hide no-scrollbar items-center md:items-center px-1 md:px-0 h-full">
            <button onclick="switchTab('planner')" id="btn-planner" class="tab-btn active p-2 rounded-lg flex items-center justify-center transition-all md:w-14 md:h-14 md:text-2xl" title="æ—¥ç¨‹èˆ‡æé†’">
                <span class="md:hidden flex items-center gap-2"><span class="text-lg">ğŸ“…</span><span class="text-xs font-bold">æ—¥ç¨‹</span></span>
                <span class="hidden md:inline">ğŸ“…</span>
            </button>

            <button onclick="switchTab('drinks')" id="btn-drinks" class="tab-btn p-2 rounded-lg flex items-center justify-center transition-all md:w-14 md:h-14 md:text-2xl" title="é£²å“ç´€éŒ„">
                <span class="md:hidden flex items-center gap-2"><span class="text-lg">ğŸ§‹</span><span class="text-xs font-bold">é£²å“</span></span>
                <span class="hidden md:inline">ğŸ§‹</span>
            </button>
            
            <button onclick="switchTab('purchasing')" id="btn-purchasing" class="tab-btn p-2 rounded-lg flex items-center justify-center transition-all md:w-14 md:h-14 md:text-2xl" title="ä»£è³¼ç®¡ç†">
                <span class="md:hidden flex items-center gap-2"><span class="text-lg">ğŸ›ï¸</span><span class="text-xs font-bold">ä»£è³¼</span></span>
                <span class="hidden md:inline">ğŸ›ï¸</span>
            </button>

            <button onclick="switchTab('subs')" id="btn-subs" class="tab-btn p-2 rounded-lg flex items-center justify-center transition-all md:w-14 md:h-14 md:text-2xl" title="è¨‚é–±ç®¡ç†">
                <span class="md:hidden flex items-center gap-2"><span class="text-lg">ğŸ’³</span><span class="text-xs font-bold">è¨‚é–±</span></span>
                <span class="hidden md:inline">ğŸ’³</span>
            </button>
            
            <button onclick="switchTab('debt')" id="btn-debt" class="tab-btn p-2 rounded-lg flex items-center justify-center transition-all md:w-14 md:h-14 md:text-2xl" title="å…¨çƒç™¾å¤§ä¼æ¥­æŠ•è³‡">
                <span class="md:hidden flex items-center gap-2"><span class="text-lg">ğŸ’°</span><span class="text-xs font-bold">æŠ•è³‡</span></span>
                <span class="hidden md:inline">ğŸ’°</span>
            </button>

            <button onclick="switchTab('literature')" id="btn-literature" class="tab-btn p-2 rounded-lg flex items-center justify-center transition-all md:w-14 md:h-14 md:text-2xl" title="æ–‡ç»çµ±æ•´">
                <span class="md:hidden flex items-center gap-2"><span class="text-lg">ğŸ“š</span><span class="text-xs font-bold">æ–‡ç»</span></span>
                <span class="hidden md:inline">ğŸ“š</span>
            </button>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="flex-1 p-3 md:p-4 overflow-y-auto relative min-h-screen md:min-h-0 md:h-auto mt-0 md:mt-0 pb-24 md:pb-4">
        
        <!-- Tab 1: Planner -->
        <div id="tab-planner" class="section-content fade-in space-y-4 md:space-y-8 pb-10">
             <header class="flex flex-col md:flex-row justify-between items-start md:items-end border-b-4 border-morandi-dark pb-2 mb-2 md:mb-4 gap-2"><div><h2 class="text-2xl md:text-4xl font-display font-bold text-morandi-dark">æ—¥ç¨‹èˆ‡æé†’</h2><p class="text-xs md:text-sm font-bold text-morandi-brown mt-1 uppercase tracking-widest">Planner & Calendar</p></div><div class="flex flex-row-reverse md:flex-col items-end gap-2 w-full md:w-auto justify-between md:justify-start"><div id="current-date" class="font-display text-xs md:text-base text-morandi-dark font-bold bg-morandi-paper px-2 md:px-3 py-1 border-2 border-morandi-dark shadow-retro-sm flex items-center gap-2 tracking-wide"></div>
             
             <!-- Moved Add Button Here -->
             <div class="flex gap-2">
                 <button onclick="toggleTaskForm()" class="btn-retro px-2 md:px-3 py-1 text-[10px] md:text-xs bg-morandi-dark text-white font-bold shadow-retro-sm hover:bg-gray-700"><i class="fas fa-plus mr-1"></i> æ–°å¢</button>
                 <button onclick="exportTasks()" class="btn-retro px-2 md:px-3 py-1 text-[10px] md:text-xs bg-white border-2 border-morandi-dark text-morandi-dark font-bold shadow-retro-sm hover:bg-gray-50"><i class="fas fa-file-export"></i> <span class="hidden md:inline">åŒ¯å‡º</span></button>
                 <label class="btn-retro px-2 md:px-3 py-1 text-[10px] md:text-xs bg-morandi-brown border-2 border-morandi-dark text-white font-bold shadow-retro-sm hover:bg-morandi-brown/80 cursor-pointer flex items-center"><i class="fas fa-file-import mr-1"></i> <span class="hidden md:inline">åŒ¯å…¥</span><input type="file" class="hidden" onchange="importTasks(this)"></label>
             </div>
             
             </div></header>
             
             <!-- Collapsible Task Form Panel (Moved to top) -->
             <div id="task-form-panel" class="bg-white border-2 border-morandi-dark shadow-retro mb-4 md:mb-6 overflow-hidden">
                <div class="p-4 md:p-6 bg-morandi-bg">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3 md:gap-4">
                        <div class="flex flex-col"><label class="text-xs font-bold text-morandi-dark mb-1">æ—¥æœŸ</label><input type="date" id="task-date" class="p-2 w-full text-sm"></div>
                        <div class="flex flex-col"><label class="text-xs font-bold text-morandi-dark mb-1">æ™‚é–“</label><div class="flex items-center gap-2"><input type="time" id="task-time" class="p-2 w-full text-sm"><label class="flex items-center gap-1 whitespace-nowrap text-xs font-bold text-morandi-dark cursor-pointer"><input type="checkbox" id="task-allday" onchange="toggleTimeInput()"> å…¨æ—¥</label></div></div>
                        <div class="flex flex-col md:col-span-2"><label class="text-xs font-bold text-morandi-dark mb-1">é¡å‹</label><select id="task-priority" class="p-2 w-full text-sm font-bold bg-white cursor-pointer"><option value="q1">ğŸ”¥ ç·Šæ€¥ä¸”é‡è¦</option><option value="q2">â­ é‡è¦ä½†ä¸ç·Šæ€¥</option><option value="q3">âš¡ ç·Šæ€¥ä½†ä¸é‡è¦</option><option value="q4">â˜• ä¸é‡è¦ä¸ç·Šæ€¥</option></select></div>
                        <div class="flex flex-col md:col-span-4"><label class="text-xs font-bold text-morandi-dark mb-1">æ¨™é¡Œ</label><input type="text" id="task-title" placeholder="ä»»å‹™æ¨™é¡Œ..." class="p-2 w-full text-lg font-bold"></div>
                        <div class="flex flex-col md:col-span-4"><label class="text-xs font-bold text-morandi-dark mb-1">å…§å®¹</label><textarea id="task-content" rows="3" placeholder="è©³ç´°å…§å®¹..." class="p-2 w-full text-sm"></textarea></div>
                        <div class="flex flex-col md:col-span-2"><label class="text-xs font-bold text-morandi-dark mb-1">åœ°é»</label><input type="text" id="task-location" placeholder="è¼¸å…¥åœ°é»" class="p-2 w-full text-sm"></div>
                        <div class="flex flex-col md:col-span-2"><label class="text-xs font-bold text-morandi-dark mb-1">ç¶²å€</label><input type="text" id="task-url" placeholder="ç›¸é—œé€£çµ..." class="p-2 w-full text-sm"></div>
                        <div class="md:col-span-4 mt-2 text-right">
                            <button onclick="toggleTaskForm()" class="btn-retro px-4 py-2 bg-gray-200 text-gray-700 font-bold rounded mr-2 hover:bg-gray-300">å–æ¶ˆ</button>
                            <button onclick="addTask()" class="btn-retro px-6 py-2 bg-morandi-dark text-white border-2 border-morandi-dark font-bold hover:bg-gray-800 shadow-retro-sm"><i class="fas fa-feather-alt mr-2"></i> æ–°å¢</button>
                        </div>
                    </div>
                </div>
             </div>

             <div class="bg-white border-2 border-morandi-dark shadow-retro mb-4 md:mb-6"><div class="p-3 md:p-6 bg-morandi-bg"><div class="flex justify-between items-center mb-4"><button onclick="changeMonth(-1)" class="btn-retro px-3 py-1 bg-white border border-morandi-dark rounded"><i class="fas fa-chevron-left"></i></button><h3 id="calendar-month-year" class="text-lg md:text-xl font-display font-bold text-morandi-dark">Month Year</h3><button onclick="changeMonth(1)" class="btn-retro px-3 py-1 bg-white border border-morandi-dark rounded"><i class="fas fa-chevron-right"></i></button></div><div class="grid grid-cols-7 gap-1 text-center font-bold text-morandi-brown text-xs md:text-sm mb-2"><div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div></div><div id="calendar-grid" class="grid grid-cols-7 gap-1 border-t-2 border-morandi-dark pt-2"></div></div></div>
             
             <!-- List View Matrix -->
             <div class="bg-white border-2 border-morandi-dark shadow-retro mt-4 md:mt-6">
                <button onclick="toggleCollapse('matrix-content', 'icon-matrix-view')" class="w-full flex justify-between items-center p-3 md:p-5 bg-morandi-paper hover:bg-morandi-brown/20 transition text-left group">
                    <span class="font-bold text-base md:text-lg text-morandi-dark"><i class="fas fa-list-ul mr-2"></i> å¾…è¾¦æ¸…å–®</span>
                    <i id="icon-matrix-view" class="fas fa-chevron-down transition-transform border-2 border-morandi-dark rounded-full p-1 w-6 h-6 md:w-8 md:h-8 flex items-center justify-center bg-white text-xs md:text-base"></i>
                </button>
                <div id="matrix-content" class="collapse-content bg-white open">
                    <div class="p-3 md:p-6 bg-morandi-bg">
                        <div class="bg-white border-2 border-morandi-dark shadow-retro-sm">
                            <div class="p-3 bg-morandi-paper border-b-2 border-morandi-dark flex justify-between items-center">
                                 <span class="font-bold text-morandi-dark">æ‰€æœ‰å¾…è¾¦äº‹é …</span>
                                 <span class="text-xs text-morandi-brown font-bold">æŒ‰å„ªå…ˆç´šæ’åº</span>
                            </div>
                            <ul id="all-tasks-list" class="divide-y divide-morandi-dark/10"></ul>
                            <div id="empty-tasks-msg" class="hidden p-8 text-center text-morandi-brown text-sm font-bold">ç›®å‰æ²’æœ‰å¾…è¾¦äº‹é …ï¼Œå»æ–°å¢ä¸€äº›å§ï¼</div>
                        </div>
                    </div>
                </div>
             </div>
        </div>

        <!-- Tab 2: Drinks Tracker -->
        <div id="tab-drinks" class="section-content hidden fade-in space-y-4 md:space-y-8 pb-10">
            <!-- Drinks content preserved -->
            <header class="flex flex-col md:flex-row justify-between items-start md:items-end border-b-4 border-morandi-dark pb-2 mb-4 gap-2"><div><h2 class="text-2xl md:text-4xl font-display font-bold text-morandi-dark">é£²å“ç´€éŒ„</h2><p class="text-xs md:text-sm font-bold text-morandi-brown mt-1 uppercase tracking-widest">Beverage Log</p></div><div class="flex flex-wrap gap-2 justify-end w-full md:w-auto"><button onclick="toggleDrinkForm()" class="btn-retro px-2 md:px-3 py-1 text-[10px] md:text-xs bg-morandi-dark text-white font-bold shadow-retro-sm hover:bg-gray-700"><i class="fas fa-plus mr-1"></i> æ–°å¢</button><button onclick="exportDrinks()" class="btn-retro px-2 md:px-3 py-1 text-[10px] md:text-xs bg-white border-2 border-morandi-dark text-morandi-dark font-bold shadow-retro-sm hover:bg-gray-50"><i class="fas fa-file-export"></i> <span class="hidden md:inline">åŒ¯å‡º</span></button><label class="btn-retro px-2 md:px-3 py-1 text-[10px] md:text-xs bg-morandi-brown border-2 border-morandi-dark text-white font-bold shadow-retro-sm hover:bg-morandi-brown/80 cursor-pointer flex items-center"><i class="fas fa-file-import mr-1"></i> <span class="hidden md:inline">åŒ¯å…¥</span><input type="file" class="hidden" onchange="importDrinks(this)"></label></div></header>
            <div id="drink-form-panel" class="bg-white border-2 border-morandi-dark shadow-retro mb-4 md:mb-6 overflow-hidden"><div class="p-4 md:p-6 bg-morandi-bg"><h4 class="font-bold text-lg text-morandi-dark mb-4 border-b border-morandi-brown/30 pb-2">æ–°å¢é£²å“ç´€éŒ„</h4><div class="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-6 mb-4"><div class="flex flex-col"><label class="text-xs font-bold text-morandi-dark mb-1">æ—¥æœŸ</label><input type="date" id="drink-date" class="p-3 w-full text-sm"></div><div class="flex flex-col"><label class="text-xs font-bold text-morandi-dark mb-1">åº—å®¶</label><input type="text" id="drink-shop" placeholder="ä¾‹ï¼š50åµ" class="p-3 w-full text-sm"></div><div class="flex flex-col md:col-span-2"><label class="text-xs font-bold text-morandi-dark mb-1">é£²æ–™åç¨±</label><input type="text" id="drink-name" placeholder="ä¾‹ï¼šå››å­£æ˜¥çæ³¢æ¤°" class="p-3 w-full text-sm"></div><div class="flex flex-col"><label class="text-xs font-bold text-morandi-dark mb-1">å†°å¡Š</label><select id="drink-ice" class="p-3 w-full text-sm font-bold bg-white"><option value="æ­£å¸¸">æ­£å¸¸</option><option value="å°‘å†°">å°‘å†°</option><option value="å¾®å†°">å¾®å†°</option><option value="å»å†°">å»å†°</option><option value="å¸¸æº«">å¸¸æº«</option><option value="æº«">æº«</option><option value="ç„¡">ç„¡æ³•èª¿æ•´/ç„¡</option></select></div><div class="flex flex-col"><div class="flex justify-between items-end mb-2"><label class="text-xs font-bold text-morandi-dark">ç”œåº¦</label><span id="drink-sugar-display" class="text-xs font-bold text-morandi-brown bg-white px-2 py-1 border border-morandi-dark rounded">ç„¡/ç„¡æ³•èª¿æ•´</span></div><input type="range" id="drink-sugar" min="0" max="6" value="0" step="1" class="w-full h-2 bg-morandi-brown/30 rounded-lg appearance-none cursor-pointer accent-morandi-dark mt-2" oninput="updateSugarDisplay()"><div class="flex justify-between text-[10px] text-gray-400 mt-1"><span>ç„¡</span><span>å…¨</span></div></div><div class="flex flex-col md:col-span-2"><label class="text-xs font-bold text-morandi-dark mb-1">é‡‘é¡ (NT$)</label><div class="flex flex-col md:flex-row items-stretch md:items-center gap-3"><input type="number" id="drink-price" placeholder="50" class="p-3 w-full text-sm flex-1 transition-colors disabled:bg-gray-200 disabled:text-gray-400"><div class="flex gap-2 overflow-x-auto pb-1 md:pb-0 no-scrollbar"><label class="flex items-center gap-1 whitespace-nowrap text-xs font-bold text-morandi-dark cursor-pointer bg-white px-3 py-2 border border-morandi-dark rounded shadow-sm hover:bg-gray-50 flex-shrink-0"><input type="checkbox" id="drink-treat" onchange="toggleDrinkPriceState()"> ğŸ è«‹å®¢</label><label class="flex items-center gap-1 whitespace-nowrap text-xs font-bold text-morandi-dark cursor-pointer bg-white px-3 py-2 border border-morandi-dark rounded shadow-sm hover:bg-gray-50 flex-shrink-0"><input type="checkbox" id="drink-meal" onchange="toggleDrinkPriceState()"> ğŸ± éš¨é¤</label><label class="flex items-center gap-1 whitespace-nowrap text-xs font-bold text-morandi-dark cursor-pointer bg-white px-3 py-2 border border-morandi-dark rounded shadow-sm hover:bg-gray-50 flex-shrink-0"><input type="checkbox" id="drink-eco"> â™»ï¸ ç’°ä¿</label></div></div></div></div><div class="mt-2 text-right"><button onclick="toggleDrinkForm()" class="btn-retro px-4 py-2 bg-gray-200 text-gray-700 font-bold rounded mr-2 hover:bg-gray-300">å–æ¶ˆ</button><button onclick="addDrink()" class="btn-retro px-6 py-2 bg-morandi-blue text-white border-2 border-morandi-dark font-bold hover:bg-morandi-blue/90 shadow-retro-sm">å„²å­˜</button></div></div></div>
            <div class="bg-white border-2 border-morandi-dark shadow-retro mb-4 md:mb-6"><div class="p-4 md:p-6 bg-morandi-bg"><div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6 text-center"><div class="p-4 md:p-6 bg-morandi-green text-white border-2 border-morandi-dark shadow-retro-sm transform hover:-translate-y-1 transition-transform"><h4 class="font-bold text-sm mb-2 uppercase tracking-wider opacity-80">ç¸½èŠ±è²» (ä»Šå¹´)</h4><p class="text-3xl md:text-4xl font-display font-bold" id="stat-total-cost">NT$ 0</p><p class="text-xs md:text-sm mt-2 font-bold bg-white/20 inline-block px-3 py-1 rounded-full" id="stat-total-cups">å…± 0 æ¯</p></div><div class="p-4 md:p-6 bg-morandi-blue text-white border-2 border-morandi-dark shadow-retro-sm transform hover:-translate-y-1 transition-transform"><h4 class="font-bold text-sm mb-2 uppercase tracking-wider opacity-80">æœ€å¸¸å»</h4><p class="text-xl md:text-2xl font-display font-bold mt-2 break-words leading-tight" id="stat-fav-shop">-</p></div><div class="p-4 md:p-6 bg-morandi-pink text-white border-2 border-morandi-dark shadow-retro-sm transform hover:-translate-y-1 transition-transform"><h4 class="font-bold text-sm mb-2 uppercase tracking-wider opacity-80">æœ€æ„›å–</h4><p class="text-xl md:text-2xl font-display font-bold mt-2 break-words leading-tight" id="stat-fav-drink">-</p></div></div></div></div>
            <div class="bg-white border-2 border-morandi-dark shadow-retro mb-4 md:mb-6"><div class="p-3 md:p-6 bg-morandi-bg"><div class="flex justify-between items-center mb-4"><button onclick="changeDrinkMonth(-1)" class="btn-retro px-3 py-1 bg-white border border-morandi-dark rounded"><i class="fas fa-chevron-left"></i></button><h3 id="drink-calendar-month-year" class="text-lg md:text-xl font-display font-bold text-morandi-dark">Month Year</h3><button onclick="changeDrinkMonth(1)" class="btn-retro px-3 py-1 bg-white border border-morandi-dark rounded"><i class="fas fa-chevron-right"></i></button></div><div class="grid grid-cols-7 gap-1 text-center font-bold text-morandi-brown text-xs md:text-sm mb-2"><div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div></div><div id="drink-calendar-grid" class="grid grid-cols-7 gap-1 border-t-2 border-morandi-dark pt-2"></div></div></div>
            
            <!-- Records and Chart Merged Row -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6 mt-4 md:mt-6">
                <!-- Recent Records (Span 2) -->
                <div class="lg:col-span-2 bg-white border-2 border-morandi-dark shadow-retro p-0 h-full flex flex-col">
                    <h3 class="font-bold text-morandi-dark p-3 md:p-4 bg-morandi-paper border-b-2 border-morandi-dark">æœ€è¿‘ç´€éŒ„</h3>
                    <div class="overflow-x-auto p-2 md:p-4 flex-1 max-h-[400px] overflow-y-auto custom-scroll">
                        <table class="w-full text-sm text-left border-collapse min-w-[400px] md:min-w-0">
                            <thead class="text-morandi-dark sticky top-0 bg-white shadow-sm">
                                <tr>
                                    <th class="p-2 md:p-3 border-b-2 border-morandi-dark whitespace-nowrap">æ—¥æœŸ</th>
                                    <th class="p-2 md:p-3 border-b-2 border-morandi-dark whitespace-nowrap">åº—å®¶</th>
                                    <th class="p-2 md:p-3 border-b-2 border-morandi-dark whitespace-nowrap">å“é …</th>
                                    <th class="p-2 md:p-3 border-b-2 border-morandi-dark whitespace-nowrap">é‡‘é¡</th>
                                    <th class="p-2 md:p-3 border-b-2 border-morandi-dark w-10"></th>
                                </tr>
                            </thead>
                            <tbody id="drink-list-body"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Pie Chart (Span 1) -->
                <div class="lg:col-span-1 bg-white border-2 border-morandi-dark shadow-retro h-full flex flex-col">
                    <h3 class="font-bold text-morandi-dark p-3 md:p-4 bg-morandi-paper border-b-2 border-morandi-dark">æ¶ˆè²»è¶¨å‹¢</h3>
                    <div class="p-4 md:p-6 bg-morandi-bg flex-1 flex items-center justify-center">
                        <div class="flex flex-col items-center justify-center gap-4 p-4 bg-white/50 border border-morandi-dark/20 rounded w-full h-full">
                            <div id="chart-pie" class="w-32 h-32 md:w-36 md:h-36 rounded-full border-2 border-morandi-dark shadow-sm bg-gray-100 flex items-center justify-center text-xs text-gray-400">ç„¡è³‡æ–™</div>
                            <div id="chart-legend" class="text-xs space-y-2 font-bold text-morandi-dark"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tab 3: Purchasing -->
        <div id="tab-purchasing" class="section-content hidden fade-in space-y-4 md:space-y-8 pb-10">
            <header class="flex flex-col md:flex-row justify-between items-start md:items-end border-b-4 border-morandi-dark pb-2 mb-4 gap-2"><div><h2 class="text-2xl md:text-4xl font-display font-bold text-morandi-dark">ä»£è³¼ç®¡ç†</h2><p class="text-xs md:text-sm font-bold text-morandi-brown mt-1 uppercase tracking-widest">Purchasing</p></div><div class="flex gap-2"><button onclick="exportOrders()" class="btn-retro px-2 md:px-3 py-1 text-[10px] md:text-xs bg-white border-2 border-morandi-dark text-morandi-dark font-bold shadow-retro-sm hover:bg-gray-50"><i class="fas fa-file-export"></i> <span class="hidden md:inline">åŒ¯å‡º</span></button><label class="btn-retro px-2 md:px-3 py-1 text-[10px] md:text-xs bg-morandi-brown border-2 border-morandi-dark text-white font-bold shadow-retro-sm hover:bg-morandi-brown/80 cursor-pointer flex items-center"><i class="fas fa-file-import mr-1"></i> <span class="hidden md:inline">åŒ¯å…¥</span><input type="file" class="hidden" onchange="importOrders(this)"></label></div></header>
            <div class="bg-white border-2 border-morandi-dark shadow-retro"><button onclick="toggleOrderForm()" class="w-full flex justify-between items-center p-3 md:p-5 bg-morandi-paper hover:bg-morandi-brown/20 transition text-left group"><span class="font-bold text-base md:text-lg text-morandi-dark"><i class="fas fa-calculator mr-2"></i> æ–°å¢è¨‚å–®</span><i id="icon-purchasing" class="fas fa-chevron-down transition-transform border-2 border-morandi-dark rounded-full p-1 w-6 h-6 md:w-8 md:h-8 flex items-center justify-center bg-white text-xs md:text-base"></i></button></div>
            
            <div id="order-form-panel" class="bg-white border-2 border-morandi-dark shadow-retro mb-4 md:mb-6 overflow-hidden">
                <div class="p-4 md:p-6 bg-morandi-bg">
                    <h4 class="font-bold text-lg text-morandi-dark mb-4 border-b border-morandi-brown/30 pb-2">æ–°å¢è¨‚å–®</h4>
                    
                    <!-- Form Grid: Single column on mobile (grid-cols-1), 4 columns on desktop (md:grid-cols-4) -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                        <div class="flex flex-col"><label class="text-xs font-bold text-morandi-dark mb-1">æ—¥æœŸ</label><input type="date" id="order-date" class="p-2 w-full text-sm"></div>
                        <div class="flex flex-col"><label class="text-xs font-bold text-morandi-dark mb-1">ä»£è™Ÿ</label><input type="text" id="order-code" class="p-2 w-full text-sm"></div>
                        <div class="flex flex-col md:col-span-2"><label class="text-xs font-bold text-morandi-dark mb-1">åº—å®¶</label><input type="text" id="order-shop" class="p-2 w-full text-sm"></div>
                        <div class="flex flex-col bg-yellow-50 p-2 border border-morandi-brown/30 rounded"><label class="text-xs font-bold text-morandi-dark mb-1">åŒ¯ç‡</label><input type="number" id="order-rate" placeholder="38" value="38" oninput="calcProfit()" class="p-2 w-full text-sm"></div>
                        <div class="flex flex-col md:col-span-3"><label class="text-xs font-bold text-morandi-dark mb-1">ç‹€æ…‹</label><select id="order-status" class="p-2 w-full text-sm font-bold bg-white text-morandi-dark"></select></div>
                    </div>

                    <!-- Dynamic Items Section -->
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-sm font-bold text-morandi-dark">è¨‚è³¼å“é …</label>
                            <button onclick="addOrderItemRow()" class="text-xs bg-morandi-paper hover:bg-morandi-brown/20 text-morandi-dark px-2 py-1 rounded border border-morandi-dark font-bold"><i class="fas fa-plus"></i> å¢åŠ å“é …</button>
                        </div>
                        <div id="order-items-container" class="space-y-2">
                            <!-- Items will be injected here via JS -->
                        </div>
                    </div>

                    <!-- Profit Summary -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4 border-t border-morandi-brown/20 pt-4">
                        <div class="flex flex-col bg-red-50 p-2 border border-red-200 rounded"><label class="text-xs font-bold text-red-800 mb-1">ç¸½æˆæœ¬ (TWD)</label><input type="text" id="order-twd-cost" readonly class="p-2 w-full text-sm bg-gray-100 font-bold text-red-800" value="0"></div>
                        <div class="flex flex-col bg-blue-50 p-2 border border-blue-200 rounded"><label class="text-xs font-bold text-blue-800 mb-1">ç¸½å”®åƒ¹ (TWD)</label><input type="text" id="order-sell-price" readonly class="p-2 w-full text-sm bg-gray-100 font-bold text-blue-800" value="0"></div>
                        <div class="flex flex-col md:col-span-2 bg-morandi-green p-2 border-2 border-morandi-dark rounded"><label class="text-xs font-bold text-white mb-1">é ä¼°åˆ©æ½¤</label><input type="text" id="order-profit" readonly class="p-2 w-full text-xl font-display font-bold text-right bg-white/90 text-morandi-dark" value="0"></div>
                    </div>

                    <!-- Additional Info -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div class="flex flex-col"><label class="text-xs font-bold text-morandi-dark mb-1">å‚™è¨»</label><input type="text" id="order-note" class="p-2 w-full text-sm"></div>
                        <div class="flex items-center gap-4 pt-4">
                            <div class="flex items-center gap-2"><input type="checkbox" id="order-paid"><label for="order-paid" class="text-sm font-bold">å•†å“å·²æ”¶</label></div>
                            <div class="flex items-center gap-2"><input type="checkbox" id="order-shipping"><label for="order-shipping" class="text-sm font-bold">é‹è²»å·²åŒ¯</label></div>
                        </div>
                    </div>

                    <div class="mt-2 text-right">
                        <button onclick="toggleOrderForm()" class="btn-retro px-4 py-2 bg-gray-200 text-gray-700 font-bold rounded mr-2 hover:bg-gray-300">å–æ¶ˆ</button>
                        <button onclick="addOrder()" class="btn-retro px-6 py-2 bg-morandi-dark text-white border-2 border-morandi-dark font-bold hover:bg-gray-800 shadow-retro-sm">å„²å­˜</button>
                    </div>
                </div>
            </div>

            <div class="bg-white border-2 border-morandi-dark shadow-retro mt-4 md:mt-6"><button onclick="toggleCollapse('purchasing-stats-content', 'icon-purchasing-stats')" class="w-full flex justify-between items-center p-3 md:p-5 bg-morandi-blue text-white hover:opacity-90 transition text-left group border-b-2 border-morandi-dark"><span class="font-bold text-base md:text-lg group-hover:translate-x-1 transition-transform"><i class="fas fa-chart-line mr-2"></i> ç‡Ÿé‹å„€è¡¨æ¿</span><i id="icon-purchasing-stats" class="fas fa-chevron-down transition-transform border-2 border-white rounded-full p-1 w-6 h-6 md:w-8 md:h-8 flex items-center justify-center text-xs md:text-base"></i></button><div id="purchasing-stats-content" class="collapse-content bg-white"><div class="p-4 md:p-6 bg-morandi-bg"><div class="grid grid-cols-2 md:grid-cols-3 gap-3 md:gap-4 mb-6"><div class="p-3 bg-white border-2 border-morandi-dark shadow-retro-sm"><div class="text-[10px] font-bold text-morandi-brown uppercase">æ·¨åˆ©æ½¤</div><div class="text-lg md:text-2xl font-display font-bold text-morandi-green mt-1" id="stats-net-profit">NT$ 0</div></div><div class="p-3 bg-white border-2 border-morandi-dark shadow-retro-sm"><div class="text-[10px] font-bold text-morandi-brown uppercase">ç¸½ç‡Ÿæ”¶</div><div class="text-lg md:text-2xl font-display font-bold text-morandi-dark mt-1" id="stats-revenue">NT$ 0</div></div><div class="p-3 bg-white border-2 border-morandi-dark shadow-retro-sm"><div class="text-[10px] font-bold text-morandi-brown uppercase">ç¸½æˆæœ¬</div><div class="text-lg md:text-2xl font-display font-bold text-red-400 mt-1" id="stats-cost">NT$ 0</div></div><div class="p-2 bg-morandi-paper border border-morandi-brown/30 rounded text-center"><div class="text-xs text-morandi-brown font-bold">åˆ©æ½¤ç‡</div><div class="text-base font-bold text-morandi-dark" id="stats-margin">0%</div></div><div class="p-2 bg-morandi-paper border border-morandi-brown/30 rounded text-center"><div class="text-xs text-morandi-brown font-bold">è¨‚å–®æ•¸</div><div class="text-base font-bold text-morandi-dark" id="stats-total-orders">0</div></div><div class="p-2 bg-morandi-paper border border-morandi-brown/30 rounded text-center"><div class="text-xs text-morandi-brown font-bold">æœªæ”¶æ¬¾ (è²¨æ¬¾)</div><div class="text-base font-bold text-red-500" id="stats-unpaid">NT$ 0</div></div></div><h4 class="text-sm font-bold text-morandi-dark mb-4 border-b-2 border-dashed border-morandi-dark pb-2">ç‹€æ…‹åˆ†å¸ƒ</h4><div id="stats-status-dist" class="space-y-3"></div></div></div></div>
            <div class="bg-white border-2 border-morandi-dark shadow-retro mt-4 md:mt-6"><div class="flex flex-col md:flex-row justify-between items-start md:items-center p-3 md:p-5 bg-morandi-paper border-b-2 border-morandi-dark gap-3"><h3 class="font-bold text-base md:text-lg text-morandi-dark uppercase tracking-wider"><i class="fas fa-list-alt mr-2"></i> è¨‚å–®å¸³æœ¬</h3><div class="flex flex-col md:flex-row gap-2 w-full md:w-auto"><div class="flex items-center gap-2"><select id="order-sort-select" onchange="updateOrderDisplaySettings()" class="p-1 text-xs border border-morandi-dark rounded bg-white font-bold cursor-pointer"><option value="desc">æ–° â†’ èˆŠ</option><option value="asc">èˆŠ â†’ æ–°</option></select><label class="flex items-center cursor-pointer bg-white px-2 py-1 border border-morandi-dark rounded shadow-sm hover:bg-gray-50 select-none"><input type="checkbox" id="order-filter-unfinished" onchange="updateOrderDisplaySettings()" class="mr-2"><span class="text-xs font-bold text-morandi-dark">åƒ…æœªå®Œæˆ</span></label></div></div></div><div class="p-3 md:p-6 bg-morandi-bg"><div class="overflow-x-auto border-2 border-morandi-dark shadow-retro-sm bg-white"><table class="w-full text-sm text-left border-collapse min-w-[700px] md:min-w-0"><thead class="bg-morandi-paper text-morandi-dark font-bold border-b-2 border-morandi-dark"><tr><th class="p-2 md:p-3 border-r border-morandi-dark/20 whitespace-nowrap">æ—¥æœŸ/ä»£è™Ÿ</th><th class="p-2 md:p-3 border-r border-morandi-dark/20 whitespace-nowrap">å•†å“è©³æƒ…</th><th class="p-2 md:p-3 border-r border-morandi-dark/20 whitespace-nowrap">ç‹€æ…‹</th><th class="p-2 md:p-3 border-r border-morandi-dark/20 whitespace-nowrap">è²¡å‹™</th><th class="p-2 md:p-3 border-r border-morandi-dark/20 whitespace-nowrap">åˆ©æ½¤</th><th class="p-2 md:p-3 w-10 text-center">åˆª</th></tr></thead><tbody id="order-list-body" class="divide-y divide-morandi-dark/10"></tbody></table></div><div class="mt-4 flex justify-end gap-4 text-xs font-bold text-morandi-dark"><div class="bg-white px-3 py-1 border border-morandi-dark rounded shadow-retro-sm">é¡¯ç¤ºï¼š<span id="order-count-display">0</span></div></div></div></div>
        </div>

        <!-- Tab 4: Subscriptions -->
        <div id="tab-subs" class="section-content hidden fade-in space-y-4 md:space-y-8 pb-10">
            <header class="flex justify-between items-end border-b-4 border-morandi-dark pb-2 mb-4"><div><h2 class="text-2xl md:text-4xl font-display font-bold text-morandi-dark">è¨‚é–±ç®¡ç†</h2><p class="text-xs md:text-sm font-bold text-morandi-brown mt-1 uppercase tracking-widest">Subscriptions</p></div><div class="flex gap-2"><button onclick="exportSubs()" class="btn-retro px-2 md:px-3 py-1 text-[10px] md:text-xs bg-white border-2 border-morandi-dark text-morandi-dark font-bold shadow-retro-sm hover:bg-gray-50"><i class="fas fa-file-export"></i> <span class="hidden md:inline">åŒ¯å‡º</span></button><label class="btn-retro px-2 md:px-3 py-1 text-[10px] md:text-xs bg-morandi-brown border-2 border-morandi-dark text-white font-bold shadow-retro-sm hover:bg-morandi-brown/80 cursor-pointer flex items-center"><i class="fas fa-file-import mr-1"></i> <span class="hidden md:inline">åŒ¯å…¥</span><input type="file" class="hidden" onchange="importSubs(this)"></label></div></header>
            <div class="bg-white border-2 border-morandi-dark shadow-retro"><button onclick="toggleSubForm()" class="w-full flex justify-between items-center p-4 md:p-5 bg-morandi-paper hover:bg-morandi-brown/20 transition text-left group"><span class="font-bold text-base md:text-lg text-morandi-dark"><i class="fas fa-plus-circle mr-2"></i> æ–°å¢è¨‚é–±</span><i id="icon-add-sub" class="fas fa-chevron-down transition-transform border-2 border-morandi-dark rounded-full p-1 w-6 h-6 md:w-8 md:h-8 flex items-center justify-center bg-white text-xs md:text-base"></i></button></div>
            <div id="sub-form-panel" class="bg-white border-2 border-morandi-dark shadow-retro mb-4 md:mb-6 overflow-hidden"><div class="p-4 md:p-6 bg-morandi-bg"><div class="grid grid-cols-1 md:grid-cols-4 gap-3 md:gap-4 mb-4"><div class="flex flex-col md:col-span-2"><label class="text-xs font-bold text-morandi-dark mb-1">åç¨±</label><input type="text" id="sub-name" class="p-2 w-full text-sm"></div><div class="flex flex-col"><label class="text-xs font-bold text-morandi-dark mb-1">é‡‘é¡</label><input type="number" id="sub-price" class="p-2 w-full text-sm"></div><div class="flex flex-col"><label class="text-xs font-bold text-morandi-dark mb-1">åˆ†æ“”äºº</label><input type="text" id="sub-person" class="p-2 w-full text-sm"></div><div class="flex flex-col"><label class="text-xs font-bold text-morandi-dark mb-1">é€±æœŸ</label><select id="sub-cycle" class="p-2 w-full text-sm bg-white font-bold"><option value="monthly">æ¯æœˆ</option><option value="quarterly">æ¯å­£</option><option value="yearly">æ¯å¹´</option></select></div><div class="flex flex-col"><label class="text-xs font-bold text-morandi-dark mb-1">æ‰£æ¬¾æ—¥</label><input type="date" id="sub-date" class="p-2 w-full text-sm"></div></div><div class="mt-2 text-right"><button onclick="toggleSubForm()" class="btn-retro px-4 py-2 bg-gray-200 text-gray-700 font-bold rounded mr-2 hover:bg-gray-300">å–æ¶ˆ</button><button onclick="addSub()" class="btn-retro px-6 py-2 bg-morandi-green text-white border-2 border-morandi-dark font-bold hover:opacity-90 shadow-retro-sm">å„²å­˜</button></div></div></div>
            <div class="bg-white border-2 border-morandi-dark shadow-retro mt-4 md:mt-6">
                <!-- Added IDs for easier toggle handling -->
                <div class="flex p-2 bg-morandi-paper border-b-2 border-morandi-dark gap-2">
                    <button id="btn-view-service" onclick="renderSubs('service')" class="flex-1 py-2 font-bold text-sm md:text-base text-morandi-dark border-2 border-transparent hover:border-morandi-dark rounded bg-white transition shadow-sm">ä¾æœå‹™</button>
                    <button id="btn-view-person" onclick="renderSubs('person')" class="flex-1 py-2 font-bold text-sm md:text-base text-morandi-dark border-2 border-transparent hover:border-morandi-dark rounded bg-white transition shadow-sm">ä¾äººå“¡</button>
                </div>
                <div id="sub-list-container" class="p-4 md:p-6 bg-morandi-bg"></div>
            </div>
        </div>

        <!-- Tab 5: Ledger -->
        <div id="tab-debt" class="section-content hidden fade-in space-y-4 md:space-y-8 pb-10">
            <header class="flex justify-between items-end border-b-4 border-morandi-dark pb-2 mb-4"><div><h2 class="text-xl md:text-4xl font-display font-bold text-morandi-dark">å…¨çƒç™¾å¤§ä¼æ¥­æŠ•è³‡æ”¶ç›Šç®¡ç†</h2><p class="text-[10px] md:text-sm font-bold text-morandi-brown mt-1 uppercase tracking-widest">Investment</p></div><div class="flex gap-2"><button onclick="exportTracker()" class="btn-retro px-2 md:px-3 py-1 text-[10px] md:text-xs bg-white border-2 border-morandi-dark text-morandi-dark font-bold shadow-retro-sm hover:bg-gray-50"><i class="fas fa-file-export"></i> <span class="hidden md:inline">åŒ¯å‡º</span></button><label class="btn-retro px-2 md:px-3 py-1 text-[10px] md:text-xs bg-morandi-brown border-2 border-morandi-dark text-white font-bold shadow-retro-sm hover:bg-morandi-brown/80 cursor-pointer flex items-center"><i class="fas fa-file-import mr-1"></i> <span class="hidden md:inline">åŒ¯å…¥</span><input type="file" class="hidden" onchange="importTracker(this)"></label></div></header>
            
            <!-- Update Form Section -->
            <div class="bg-white border-2 border-morandi-dark shadow-retro" id="ledger-form-container">
                <div class="p-3 md:p-5 bg-morandi-paper border-b-2 border-morandi-dark">
                    <h3 class="font-bold text-base md:text-lg text-morandi-dark"><i class="fas fa-pen-nib mr-2"></i> æ–°å¢å¸³å‹™ç´€éŒ„</h3>
                </div>
                <div class="p-4 md:p-6 bg-morandi-bg">
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-3 p-3 md:p-4 border border-morandi-brown/30 bg-white/50 rounded">
                        <div class="md:col-span-2 flex gap-2">
                            <select id="ledger-category" class="w-1/2 p-2 text-sm font-bold bg-white" onchange="updateLedgerTypeOptions()">
                                <option value="general">ä¸€èˆ¬å¸³å‹™</option>
                                <option value="camera">ç›¸æ©Ÿå¤¢</option>
                            </select>
                            <select id="ledger-type" class="w-1/2 p-2 text-sm font-bold bg-white"></select>
                        </div>
                        <input type="date" id="ledger-date" class="p-2 text-sm border-morandi-dark">
                        <input type="text" id="ledger-desc" placeholder="é …ç›®" class="p-2 text-sm">
                        <input type="number" id="ledger-amount" placeholder="é‡‘é¡" class="p-2 text-sm">
                        
                        <div class="md:col-span-5 flex gap-2 mt-2">
                            <button id="btn-save-ledger" onclick="saveLedgerEntry()" class="btn-retro bg-morandi-dark text-white font-bold py-2 flex-1 border-2 border-morandi-dark hover:opacity-90">æ–°å¢</button>
                            <button id="btn-cancel-ledger" onclick="resetLedgerForm()" class="btn-retro bg-gray-200 text-gray-700 font-bold py-2 px-4 border border-gray-300 hover:bg-gray-300 hidden">å–æ¶ˆ</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- General Ledger List -->
            <div class="bg-white border-2 border-morandi-dark shadow-retro mt-4 md:mt-6">
                <button onclick="toggleCollapse('debt-list-content', 'icon-debt-list')" class="w-full flex justify-between items-center p-4 md:p-5 bg-morandi-paper hover:bg-morandi-brown/20 transition text-left group">
                    <span class="font-bold text-base md:text-lg text-morandi-dark group-hover:translate-x-1 transition-transform">
                        <i class="fas fa-hand-holding-usd mr-2"></i> ä¸€èˆ¬å¸³å‹™æ˜ç´° 
                        <span id="debt-header-balance" class="text-xs ml-2 font-normal text-morandi-brown"></span>
                    </span>
                    <i id="icon-debt-list" class="fas fa-chevron-down transition-transform border-2 border-morandi-dark rounded-full p-1 w-6 h-6 md:w-8 md:h-8 flex items-center justify-center bg-white text-xs md:text-base"></i>
                </button>
                <div id="debt-list-content" class="collapse-content bg-white">
                    <div class="p-4 md:p-6 bg-morandi-bg">
                        <ul id="debt-list" class="space-y-2"></ul>
                    </div>
                </div>
            </div>

            <!-- Camera Fund List -->
            <div class="bg-white border-2 border-morandi-dark shadow-retro mt-4 md:mt-6">
                <button onclick="toggleCollapse('camera-fund-content', 'icon-camera-fund')" class="w-full flex justify-between items-center p-4 md:p-5 bg-morandi-paper hover:bg-morandi-brown/20 transition text-left group">
                    <span class="font-bold text-base md:text-lg text-morandi-dark group-hover:translate-x-1 transition-transform">
                        <i class="fas fa-camera-retro mr-2"></i> ç²¿ç²¿å‹æ–¯ã®ç›¸æ©Ÿå¤¢ 
                        <span id="camera-header-balance" class="text-xs ml-2 font-normal text-morandi-green"></span>
                    </span>
                    <i id="icon-camera-fund" class="fas fa-chevron-down transition-transform border-2 border-morandi-dark rounded-full p-1 w-6 h-6 md:w-8 md:h-8 flex items-center justify-center bg-white text-xs md:text-base"></i>
                </button>
                <div id="camera-fund-content" class="collapse-content bg-white">
                    <div class="p-4 md:p-6 bg-morandi-bg">
                        <div class="flex justify-between items-center mb-2">
                            <div class="text-xs font-bold text-morandi-brown bg-white px-2 py-1 border border-morandi-brown rounded">Target: NT$ <span id="camera-target-display">50000</span></div>
                        </div>
                        <div class="mb-6">
                            <div class="flex justify-between text-xs font-bold mb-1">
                                <span>å­˜é¡: NT$ <span id="camera-current">0</span></span>
                                <span id="camera-percent">0%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-4 border border-morandi-dark overflow-hidden">
                                <div id="camera-bar" class="bg-morandi-green h-full transition-all duration-500" style="width: 0%"></div>
                            </div>
                        </div>
                        <ul id="fund-list" class="max-h-60 overflow-y-auto custom-scroll space-y-1 text-sm bg-white p-4 border border-morandi-brown/20 rounded"></ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 6: Literature (NEW) -->
        <div id="tab-literature" class="section-content hidden fade-in space-y-4 md:space-y-8 pb-10">
            <header class="flex justify-between items-end border-b-4 border-morandi-dark pb-2 mb-4">
                <div><h2 class="text-2xl md:text-4xl font-display font-bold text-morandi-dark">æ–‡ç»çµ±æ•´</h2><p class="text-xs md:text-sm font-bold text-morandi-brown mt-1 uppercase tracking-widest">Reference & Bibliography</p></div>
                <div class="flex gap-2"><button onclick="exportLit()" class="btn-retro px-2 md:px-3 py-1 text-[10px] md:text-xs bg-white border-2 border-morandi-dark text-morandi-dark font-bold shadow-retro-sm hover:bg-gray-50"><i class="fas fa-file-export"></i> <span class="hidden md:inline">åŒ¯å‡º</span></button><label class="btn-retro px-2 md:px-3 py-1 text-[10px] md:text-xs bg-morandi-brown border-2 border-morandi-dark text-white font-bold shadow-retro-sm hover:bg-morandi-brown/80 cursor-pointer flex items-center"><i class="fas fa-file-import mr-1"></i> <span class="hidden md:inline">åŒ¯å…¥</span><input type="file" class="hidden" onchange="importLit(this)"></label></div>
            </header>

            <!-- Add Literature Form -->
            <div class="bg-white border-2 border-morandi-dark shadow-retro">
                <button onclick="toggleCollapse('lit-form-panel', 'icon-add-lit')" class="w-full flex justify-between items-center p-4 md:p-5 bg-morandi-paper hover:bg-morandi-brown/20 transition text-left group">
                    <span class="font-bold text-base md:text-lg text-morandi-dark"><i class="fas fa-book-open mr-2"></i> æ–°å¢æ–‡ç»</span>
                    <i id="icon-add-lit" class="fas fa-chevron-down transition-transform border-2 border-morandi-dark rounded-full p-1 w-6 h-6 md:w-8 md:h-8 flex items-center justify-center bg-white text-xs md:text-base"></i>
                </button>
                <div id="lit-form-panel" class="collapse-content bg-white">
                    <div class="p-4 md:p-6 bg-morandi-bg">
                        <!-- å€å¡Š1: åŸºæœ¬è³‡è¨Š -->
                        <div class="mb-4 border-b border-morandi-brown/20 pb-4">
                            <h4 class="text-xs font-bold text-morandi-brown uppercase tracking-widest mb-3">åŸºæœ¬è³‡è¨Š (Basic Info)</h4>
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-3 md:gap-4">
                                <div class="flex flex-col md:col-span-2"><label class="text-xs font-bold text-morandi-dark mb-1">æ¨™é¡Œ</label><input type="text" id="lit-title" class="p-2 w-full text-sm"></div>
                                <div class="flex flex-col"><label class="text-xs font-bold text-morandi-dark mb-1">ä½œè€…</label><input type="text" id="lit-author" class="p-2 w-full text-sm"></div>
                                <div class="flex flex-col"><label class="text-xs font-bold text-morandi-dark mb-1">å¹´ä»½/æ—¥æœŸ</label><input type="text" id="lit-date" class="p-2 w-full text-sm" placeholder="2023"></div>
                                <div class="flex flex-col"><label class="text-xs font-bold text-morandi-dark mb-1">é¡å‹</label><select id="lit-type" class="p-2 w-full text-sm bg-white font-bold"><option>æœŸåˆŠè«–æ–‡</option><option>æ›¸ç±</option><option>å­¸ä½è«–æ–‡</option><option>ç ”è¨æœƒè«–æ–‡</option><option>ç¶²è·¯æ–‡ç« </option><option>å…¶ä»–</option></select></div>
                                <div class="flex flex-col"><label class="text-xs font-bold text-morandi-dark mb-1">ç‹€æ…‹</label><select id="lit-status" class="p-2 w-full text-sm bg-white font-bold"><option>å·²è®€</option><option>é–±è®€ä¸­</option><option>æƒ³è®€</option></select></div>
                                <div class="flex flex-col md:col-span-2"><label class="text-xs font-bold text-morandi-dark mb-1">æ¶‰åŠé ˜åŸŸ</label><input type="text" id="lit-field" class="p-2 w-full text-sm"></div>
                                <div class="flex flex-col md:col-span-4"><label class="text-xs font-bold text-morandi-dark mb-1">é—œéµå­—</label><input type="text" id="lit-keywords" class="p-2 w-full text-sm" placeholder="ä»¥é€—è™Ÿåˆ†éš”"></div>
                                <div class="flex flex-col"><label class="text-xs font-bold text-morandi-dark mb-1">DOI</label><input type="text" id="lit-doi" class="p-2 w-full text-sm"></div>
                                <div class="flex flex-col md:col-span-3"><label class="text-xs font-bold text-morandi-dark mb-1">ç›¸é—œç†è«–</label><input type="text" id="lit-theories" class="p-2 w-full text-sm"></div>
                            </div>
                        </div>

                        <!-- å€å¡Š2: è®Šæ•¸æ¨¡å‹ -->
                        <div class="mb-4 border-b border-morandi-brown/20 pb-4 bg-gray-50 p-3 rounded">
                            <h4 class="text-xs font-bold text-morandi-dark uppercase tracking-widest mb-3"><i class="fas fa-project-diagram mr-1"></i> è®Šæ•¸æ¨¡å‹ (Methodology)</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4">
                                <div class="flex flex-col"><label class="text-xs font-bold text-blue-800 mb-1">è‡ªè®Šæ•¸ (IV)</label><input type="text" id="lit-method-iv" class="p-2 w-full text-sm"></div>
                                <div class="flex flex-col"><label class="text-xs font-bold text-red-800 mb-1">å› è®Šæ•¸ (DV)</label><input type="text" id="lit-method-dv" class="p-2 w-full text-sm"></div>
                                <div class="flex flex-col"><label class="text-xs font-bold text-green-800 mb-1">ä¸­ä»‹è®Šæ•¸ (Mediator)</label><input type="text" id="lit-method-med" class="p-2 w-full text-sm"></div>
                                <div class="flex flex-col"><label class="text-xs font-bold text-purple-800 mb-1">èª¿ç¯€è®Šæ•¸ (Moderator)</label><input type="text" id="lit-method-mod" class="p-2 w-full text-sm"></div>
                            </div>
                        </div>

                        <!-- å€å¡Š3: ç ”ç©¶æ ¸å¿ƒ -->
                        <div class="mb-4">
                            <h4 class="text-xs font-bold text-morandi-brown uppercase tracking-widest mb-3">ç ”ç©¶æ ¸å¿ƒ (Core)</h4>
                            <div class="space-y-3">
                                <div class="flex flex-col"><label class="text-xs font-bold text-morandi-dark mb-1">ç ”ç©¶èƒŒæ™¯</label><textarea id="lit-background" class="p-2 w-full text-sm h-20" placeholder="å•é¡Œæ„è­˜..."></textarea></div>
                                <div class="flex flex-col"><label class="text-xs font-bold text-morandi-dark mb-1">ç ”ç©¶ç›®çš„</label><textarea id="lit-purpose" class="p-2 w-full text-sm h-16"></textarea></div>
                                <div class="flex flex-col"><label class="text-xs font-bold text-morandi-dark mb-1">ç ”ç©¶çµè«–</label><textarea id="lit-conclusion" class="p-2 w-full text-sm h-24" placeholder="ä¸»è¦ç™¼ç¾..."></textarea></div>
                                <div class="flex flex-col"><label class="text-xs font-bold text-morandi-dark mb-1">ç­†è¨˜</label><textarea id="lit-note" class="p-2 w-full text-sm h-16"></textarea></div>
                                <div class="flex flex-col"><label class="text-xs font-bold text-morandi-dark mb-1">é€£çµ</label><input type="text" id="lit-link" class="p-2 w-full text-sm"></div>
                            </div>
                        </div>

                        <div class="text-right"><button onclick="addLit()" class="btn-retro px-6 py-2 bg-morandi-dark text-white border-2 border-morandi-dark font-bold hover:bg-gray-800 shadow-retro-sm">å„²å­˜</button></div>
                    </div>
                </div>
            </div>

            <!-- Library List -->
            <div id="lit-list-container" class="grid grid-cols-1 gap-4 mt-6">
                <!-- JS Injected Cards -->
            </div>
        </div>

    </main>

    <div id="toast" class="fixed bottom-6 right-6 bg-morandi-dark text-white px-6 py-4 border-2 border-white shadow-retro font-bold transform translate-y-32 opacity-0 transition-all duration-300 z-50">Notification</div>

    <script>
        let appData = { tasks: [], drinks: [], orders: [], subs: [], debts: [], cameraFund: { target: 50000, entries: [] }, literature: [] };
        let currentCalendarDate = new Date();
        let currentDrinkCalendarDate = new Date();
        let orderSort = 'desc';
        let orderFilterUnfinished = false;
        let editingLedgerId = null; // Track ID being edited
        
        const ORDER_STATUSES = ["ç¢ºèªä¸­", "å·²åŒ¯æ¬¾", "å°å¸³å®Œæˆ", "éŸ“åœ‹ç«¯ä¸‹å–®", "éŸ“åœ‹ç«¯å‡ºè²¨", "å¾…é›†é‹å›å°", "å·²æŠµå°", "æŠµå°æ•´ç†ä¸­", "å¾…é¢äº¤", "å·²å¯„å‡º", "è¨‚å–®å®Œæˆ"];
        const SUGAR_LEVELS = ['ç„¡/ç„¡æ³•èª¿æ•´', 'ä¸€åˆ†ç³–', 'äºŒåˆ†ç³–', 'å¾®ç³–', 'åŠç³–', 'å°‘ç³–', 'å…¨ç³–'];

        document.addEventListener('DOMContentLoaded', () => {
            loadData(); 
            updateDate(); 
            renderTasks(); 
            renderCalendar(); 
            renderDrinks(); 
            renderDrinkCalendar(); 
            renderStatusOptions();
            renderOrders(); 
            updateStats(); 
            updatePurchasingStats(); 
            renderSubs('service'); 
            renderDebts(); 
            renderCameraFund(); 
            updateLedgerTypeOptions(); 
            renderLiterature(); 
            toggleCollapse('matrix-content', 'icon-matrix-view');

            const today = new Date();
        });

        function loadData() { const s=localStorage.getItem('retroDashboardData'); if(s){ const p=JSON.parse(s); appData={...appData,...p}; ['tasks','drinks','orders','subs','debts','literature'].forEach(k=>{if(!appData[k])appData[k]=[]}); if(!appData.cameraFund)appData.cameraFund={target:50000,entries:[]}; } }
        function saveData() { localStorage.setItem('retroDashboardData', JSON.stringify(appData)); }
        function showToast(m) { const t=document.getElementById('toast'); t.textContent=m; t.classList.remove('translate-y-32','opacity-0'); setTimeout(()=>{t.classList.add('translate-y-32','opacity-0');},3000); }
        function updateDate() { const n=new Date(); document.getElementById('current-date').innerHTML = `<span class="mr-2">${n.getFullYear()}.${String(n.getMonth()+1).padStart(2,'0')}.${String(n.getDate()).padStart(2,'0')}</span><span class="text-xs bg-morandi-brown text-white px-1 rounded">${['SUN','MON','TUE','WED','THU','FRI','SAT'][n.getDay()]}</span>`; }
        function switchTab(t) { document.querySelectorAll('.tab-btn').forEach(b=>{b.classList.remove('active');if(b.id===`btn-${t}`)b.classList.add('active');}); document.querySelectorAll('.section-content').forEach(s=>{s.classList.add('hidden');if(s.id===`tab-${t}`)s.classList.remove('hidden');}); if(t==='planner')renderCalendar(); if(t==='drinks')renderDrinkCalendar(); }
        function toggleCollapse(c,i) { const el=document.getElementById(c); const ic=document.getElementById(i); if(!el) return; if(el.classList.contains('open')){el.classList.remove('open');if(ic)ic.style.transform='rotate(0deg)';}else{el.classList.add('open');if(ic)ic.style.transform='rotate(180deg)';} }

        // Planner
        function toggleTimeInput(){document.getElementById('task-time').disabled=document.getElementById('task-allday').checked;}
        // ADDED: Toggle function for new planner form
        function toggleTaskForm(){const p=document.getElementById('task-form-panel'); if(p.classList.contains('open'))p.classList.remove('open'); else p.classList.add('open');}
        
        function addTask(){const d=document.getElementById('task-date').value; const t=document.getElementById('task-title').value; if(!t.trim()||!d)return showToast("è«‹è¼¸å…¥"); appData.tasks.push({id:Date.now(),date:d,time:document.getElementById('task-time').value,isAllDay:document.getElementById('task-allday').checked,quadrant:document.getElementById('task-priority').value,title:t,text:t,content:document.getElementById('task-content').value,location:document.getElementById('task-location').value,url:document.getElementById('task-url').value,completed:false}); saveData(); renderTasks(); renderCalendar(); showToast("OK"); toggleTaskForm();}
        
        // --- Updated renderTasks for List View ---
        function renderTasks(){
            const list = document.getElementById('all-tasks-list');
            const emptyMsg = document.getElementById('empty-tasks-msg');
            if(!list) return;
            
            list.innerHTML = '';
            
            if(appData.tasks.length === 0) {
                if(emptyMsg) emptyMsg.classList.remove('hidden');
                return;
            } else {
                if(emptyMsg) emptyMsg.classList.add('hidden');
            }

            // Sort: Uncompleted first, then by Quadrant (q1, q2, q3, q4), then by Date
            const sortedTasks = [...appData.tasks].sort((a,b) => {
                if (a.completed !== b.completed) return a.completed ? 1 : -1;
                const qOrder = {q1:1, q2:2, q3:3, q4:4};
                if (qOrder[a.quadrant] !== qOrder[b.quadrant]) return qOrder[a.quadrant] - qOrder[b.quadrant];
                return new Date(a.date) - new Date(b.date);
            });

            const qLabels = {
                q1: { text: "ğŸ”¥ ç·Šæ€¥é‡è¦", color: "bg-red-200 text-red-900 border border-red-300" },
                q2: { text: "â­ é‡è¦ä¸æ€¥", color: "bg-blue-200 text-blue-900 border border-blue-300" },
                q3: { text: "âš¡ ç·Šæ€¥ä¸é‡", color: "bg-yellow-200 text-yellow-900 border border-yellow-300" },
                q4: { text: "â˜• ä¸æ€¥ä¸é‡", color: "bg-gray-200 text-gray-800 border border-gray-300" }
            };

            sortedTasks.forEach(t => {
                const q = t.quadrant || 'q1';
                const label = qLabels[q];
                const li = document.createElement('li');
                li.className = `flex justify-between items-start p-3 md:p-4 hover:bg-gray-50 transition group ${t.completed ? 'opacity-50 bg-gray-50' : ''}`;
                
                li.innerHTML = `
                    <div class="flex items-start gap-3 w-full">
                        <input type="checkbox" ${t.completed ? 'checked' : ''} onchange="toggleTask(${t.id})" class="cursor-pointer mt-1.5 w-5 h-5 accent-morandi-dark">
                        <div class="flex-1 min-w-0">
                            <div class="flex flex-wrap items-center gap-2 mb-1">
                                <span class="text-[10px] px-2 py-0.5 rounded shadow-sm font-bold tracking-wide ${label.color}">${label.text}</span>
                                <span class="text-xs text-morandi-brown font-bold bg-morandi-paper/50 px-1 rounded"><i class="far fa-clock mr-1"></i>${t.date} ${t.time || ''}</span>
                                ${t.location ? `<span class="text-[10px] text-gray-500 bg-gray-100 px-1 rounded"><i class="fas fa-map-marker-alt mr-1"></i>${t.location}</span>` : ''}
                            </div>
                            <span class="text-base font-bold text-morandi-dark block break-words ${t.completed ? 'line-through text-gray-400' : ''}">${t.title}</span>
                            ${t.content ? `<p class="text-sm text-gray-600 mt-1 break-words">${t.content}</p>` : ''}
                            ${t.url ? `<a href="${t.url}" target="_blank" class="text-xs text-blue-500 hover:underline mt-1 inline-block"><i class="fas fa-link mr-1"></i>ç›¸é—œé€£çµ</a>` : ''}
                        </div>
                    </div>
                    <button onclick="deleteTask(${t.id})" class="text-gray-300 hover:text-red-500 p-2 transition-colors"><i class="fas fa-trash-alt"></i></button>
                `;
                list.appendChild(li);
            });
        }

        function toggleTask(id){const t=appData.tasks.find(x=>x.id===id); if(t){t.completed=!t.completed;saveData();renderTasks();}}
        function deleteTask(id){if(confirm("åˆªé™¤ï¼Ÿ")){appData.tasks=appData.tasks.filter(x=>x.id!==id);saveData();renderTasks();renderCalendar();}}
        function renderCalendar(){/* Simplified for brevity */ const g=document.getElementById('calendar-grid'); if(!g)return; g.innerHTML=''; const d=new Date(currentCalendarDate.getFullYear(),currentCalendarDate.getMonth(),1); const m=d.getMonth(); document.getElementById('calendar-month-year').textContent=`${d.getFullYear()} / ${m+1}`; for(let i=0;i<d.getDay();i++){g.innerHTML+='<div></div>';} while(d.getMonth()===m){ const today=new Date(); const isToday=d.getDate()===today.getDate()&&d.getMonth()===today.getMonth()&&d.getFullYear()===today.getFullYear(); const dateStr=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; const hasTask=appData.tasks.some(t=>t.date===dateStr); g.innerHTML+=`<div class="calendar-day p-1 border border-morandi-brown/10 rounded flex flex-col items-center ${isToday?'today':''} ${hasTask?'bg-yellow-50':''}"><span class="text-xs font-bold">${d.getDate()}</span>${hasTask?'<span class="w-1 h-1 bg-red-400 rounded-full mt-1"></span>':''}</div>`; d.setDate(d.getDate()+1); } }
        function changeMonth(d){currentCalendarDate.setMonth(currentCalendarDate.getMonth()+d); renderCalendar();}

        // Drinks
        function toggleDrinkForm(){const p=document.getElementById('drink-form-panel'); if(p.classList.contains('open'))p.classList.remove('open'); else p.classList.add('open');}
        function updateSugarDisplay(){document.getElementById('drink-sugar-display').textContent=SUGAR_LEVELS[document.getElementById('drink-sugar').value];}
        function toggleDrinkPriceState(){const dis=document.getElementById('drink-treat').checked||document.getElementById('drink-meal').checked; const p=document.getElementById('drink-price'); p.disabled=dis; p.placeholder=dis?'ä¸ç”¨éŒ¢':'50'; if(dis)p.value='';}
        function addDrink(){ const d=document.getElementById('drink-date').value; const s=document.getElementById('drink-shop').value; const n=document.getElementById('drink-name').value; let p=Math.round(parseFloat(document.getElementById('drink-price').value)); const tr=document.getElementById('drink-treat').checked; const m=document.getElementById('drink-meal').checked; if(!d||!s||!n)return showToast("è«‹è¼¸å…¥"); if(tr||m)p=0; appData.drinks.unshift({id:Date.now(),date:d,price:p,shop:s,name:n,ice:document.getElementById('drink-ice').value,sugar:SUGAR_LEVELS[document.getElementById('drink-sugar').value],isTreat:tr,isMeal:m,isEco:document.getElementById('drink-eco').checked}); saveData(); renderDrinks(); updateStats(); toggleDrinkForm(); showToast("OK"); }
        
        // --- Updated renderDrinks for Simplified Columns ---
        function renderDrinks(){ 
            const tb=document.getElementById('drink-list-body'); 
            if(!tb)return; 
            tb.innerHTML=''; 
            appData.drinks.slice(0,50).forEach(d=>{ 
                const tr=document.createElement('tr'); 
                let p=`NT$${d.price}`; 
                if(d.isTreat)p='ğŸ'; 
                else if(d.isMeal)p='ğŸ±'; 
                // Columns: Date, Shop, Name, Price, Delete
                tr.innerHTML=`
                    <td class="p-2 text-xs border-b border-morandi-dark/10">${d.date}</td>
                    <td class="p-2 border-b border-morandi-dark/10 text-sm font-bold text-morandi-dark">${d.shop}</td>
                    <td class="p-2 border-b border-morandi-dark/10 text-sm">${d.name}</td>
                    <td class="p-2 border-b border-morandi-dark/10 font-bold">${p}</td>
                    <td class="p-2 border-b border-morandi-dark/10 text-center"><button onclick="deleteDrink(${d.id})" class="text-gray-300 hover:text-red-400"><i class="fas fa-times"></i></button></td>`; 
                tb.appendChild(tr); 
            }); 
        }
        
        // --- Updated updateStats & renderChart for Pie Chart ---
        function updateStats(){ 
            const y=new Date().getFullYear(); 
            const ds=appData.drinks.filter(d=>new Date(d.date).getFullYear()===y); 
            document.getElementById('stat-total-cost').textContent=`NT$ ${ds.reduce((a,b)=>a+(b.isTreat||b.isMeal?0:b.price),0)}`; 
            document.getElementById('stat-total-cups').textContent=`å…± ${ds.length} æ¯`; 
            // Pass all drinks from this year to renderChart
            renderChart(ds); 
        }

        function renderChart(data){ 
            const pie = document.getElementById('chart-pie');
            const legend = document.getElementById('chart-legend');
            if(!pie || !legend) return;

            let counts = { self: 0, treat: 0, meal: 0 };
            data.forEach(d => {
                if (d.isTreat) counts.treat++;
                else if (d.isMeal) counts.meal++;
                else counts.self++;
            });

            const total = data.length;
            
            if (total === 0) {
                pie.style.background = '#f3f4f6'; // gray-100
                pie.innerHTML = 'ç„¡è³‡æ–™';
                legend.innerHTML = '';
                return;
            } else {
                pie.innerHTML = '';
            }

            const pSelf = (counts.self / total) * 100;
            const pTreat = (counts.treat / total) * 100;
            const pMeal = (counts.meal / total) * 100;

            const endSelf = pSelf;
            const endTreat = endSelf + pTreat;

            // Using Tailwind colors: morandi-green (#8F9E8B), morandi-pink (#C4A8A6), morandi-blue (#8CA0A8)
            const gradient = `conic-gradient(
                #8F9E8B 0% ${endSelf}%,
                #C4A8A6 ${endSelf}% ${endTreat}%,
                #8CA0A8 ${endTreat}% 100%
            )`;

            pie.style.background = gradient;

            legend.innerHTML = `
                <div class="flex items-center gap-2"><span class="w-3 h-3 bg-[#8F9E8B] rounded-full shadow-sm"></span> <span>è‡ªè²» (${counts.self}) ${Math.round(pSelf)}%</span></div>
                <div class="flex items-center gap-2"><span class="w-3 h-3 bg-[#C4A8A6] rounded-full shadow-sm"></span> <span>è«‹å®¢ (${counts.treat}) ${Math.round(pTreat)}%</span></div>
                <div class="flex items-center gap-2"><span class="w-3 h-3 bg-[#8CA0A8] rounded-full shadow-sm"></span> <span>éš¨é¤ (${counts.meal}) ${Math.round(pMeal)}%</span></div>
            `;
        }
        
        function renderDrinkCalendar(){/* Simplified */ const g=document.getElementById('drink-calendar-grid'); if(!g)return; g.innerHTML=''; const d=new Date(currentDrinkCalendarDate.getFullYear(),currentDrinkCalendarDate.getMonth(),1); const m=d.getMonth(); document.getElementById('drink-calendar-month-year').textContent=`${d.getFullYear()} / ${m+1}`; for(let i=0;i<d.getDay();i++){g.innerHTML+='<div></div>';} while(d.getMonth()===m){ const dateStr=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; const cups=appData.drinks.filter(dr=>dr.date===dateStr).length; g.innerHTML+=`<div class="calendar-day p-1 border border-morandi-brown/10 rounded flex flex-col items-center ${cups>0?'bg-morandi-blue/10':''}"><span class="text-xs font-bold">${d.getDate()}</span>${cups>0?`<span class="text-[10px] font-bold mt-1">ğŸ¥¤${cups}</span>`:''}</div>`; d.setDate(d.getDate()+1); } }
        function changeDrinkMonth(d){currentDrinkCalendarDate.setMonth(currentDrinkCalendarDate.getMonth()+d); renderDrinkCalendar();}

        // Purchasing
        
        // --- Updated: Dynamic Item Rows ---
        function toggleOrderForm(){
            const p=document.getElementById('order-form-panel'); 
            if(p.classList.contains('open')){
                p.classList.remove('open');
            } else {
                p.classList.add('open');
                // Check if items container is empty, if so add one row
                const c = document.getElementById('order-items-container');
                if(c && c.children.length === 0) addOrderItemRow();
                renderStatusOptions(); // Ensure status options are populated
            }
        }

        function renderStatusOptions(){
            if(document.getElementById('order-status')) {
                // If it's empty, populate it
                if (document.getElementById('order-status').children.length === 0) {
                    document.getElementById('order-status').innerHTML=ORDER_STATUSES.map(s=>`<option>${s}</option>`).join('');
                }
            }
        }

        function addOrderItemRow() {
            const container = document.getElementById('order-items-container');
            const div = document.createElement('div');
            div.className = "item-row grid grid-cols-1 md:grid-cols-12 gap-2 mb-2 bg-gray-50 p-2 rounded relative border border-morandi-brown/10";
            div.innerHTML = `
                <input class="p-2 text-sm border-morandi-dark col-span-1 md:col-span-3 item-name" placeholder="å•†å“åç¨±">
                <input class="p-2 text-sm border-morandi-dark col-span-1 md:col-span-3 item-spec" placeholder="è¦æ ¼">
                <div class="flex col-span-1 md:col-span-2 items-center">
                    <button onclick="changeItemQty(this, -1)" class="w-8 h-full bg-gray-200 text-gray-600 font-bold border border-r-0 border-morandi-dark rounded-l">-</button>
                    <input type="number" class="p-2 text-sm border-y border-morandi-dark w-full text-center item-qty" value="1" oninput="calcProfit()">
                    <button onclick="changeItemQty(this, 1)" class="w-8 h-full bg-gray-200 text-gray-600 font-bold border border-l-0 border-morandi-dark rounded-r">+</button>
                </div>
                <input type="number" class="p-2 text-sm border-morandi-dark col-span-1 md:col-span-2 item-krw" placeholder="éŸ“å¹£å–®åƒ¹" oninput="calcProfit()">
                <input type="number" class="p-2 text-sm border-morandi-dark col-span-1 md:col-span-2 item-sell" placeholder="å°å¹£å–®åƒ¹" oninput="calcProfit()">
                <button onclick="removeOrderItemRow(this)" class="absolute -top-2 -right-2 bg-red-400 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs shadow-sm hover:bg-red-600">x</button>
            `;
            container.appendChild(div);
        }

        function removeOrderItemRow(btn) {
            const row = btn.closest('.item-row');
            const container = document.getElementById('order-items-container');
            if(container.children.length > 1) {
                row.remove();
                calcProfit();
            } else {
                showToast("è‡³å°‘éœ€æœ‰ä¸€å€‹å“é …");
            }
        }

        function changeItemQty(btn, delta) {
            const input = btn.parentElement.querySelector('input');
            let val = parseInt(input.value) || 0;
            val += delta;
            if(val < 1) val = 1;
            input.value = val;
            calcProfit();
        }
        
        // --- Updated: calcProfit to iterate rows ---
        function calcProfit() {
            const rows = document.querySelectorAll('.item-row');
            const rate = parseFloat(document.getElementById('order-rate').value) || 38;
            
            let totalKrw = 0;
            let totalSell = 0;
            let totalTwdCost = 0;

            rows.forEach(row => {
                const qty = parseInt(row.querySelector('.item-qty').value) || 0;
                const krw = parseInt(row.querySelector('.item-krw').value) || 0;
                const sell = parseInt(row.querySelector('.item-sell').value) || 0;

                totalKrw += (krw * qty);
                totalSell += (sell * qty);
                
                // Cost for this item
                totalTwdCost += Math.ceil((krw / rate) * qty);
            });
            
            const profit = totalSell - totalTwdCost;
            
            document.getElementById('order-twd-cost').value = totalTwdCost;
            document.getElementById('order-sell-price').value = totalSell;
            document.getElementById('order-profit').value = profit;
        }

        function addOrder(){ 
            const d = document.getElementById('order-date').value;
            const shop = document.getElementById('order-shop').value;
            if(!d) return showToast("è«‹è¼¸å…¥æ—¥æœŸ");

            // Gather items
            const itemRows = document.querySelectorAll('.item-row');
            let items = [];
            let hasError = false;

            itemRows.forEach(row => {
                const name = row.querySelector('.item-name').value;
                if(!name) hasError = true;
                items.push({
                    name: name,
                    spec: row.querySelector('.item-spec').value,
                    qty: parseInt(row.querySelector('.item-qty').value) || 1,
                    krw: parseInt(row.querySelector('.item-krw').value) || 0,
                    sell: parseInt(row.querySelector('.item-sell').value) || 0
                });
            });

            if(hasError) return showToast("è«‹è¼¸å…¥å•†å“åç¨±");

            const rate = parseFloat(document.getElementById('order-rate').value) || 38;
            const twdCost = parseInt(document.getElementById('order-twd-cost').value) || 0;
            const sell = parseInt(document.getElementById('order-sell-price').value) || 0;
            const profit = parseInt(document.getElementById('order-profit').value) || 0;

            appData.orders.unshift({
                id: Date.now(),
                date: d,
                code: document.getElementById('order-code').value,
                shop: shop,
                // Store array of items
                items: items,
                // Legacy fields fallback (take first item or summary)
                name: items.map(i => i.name).join(', '), 
                spec: items.length > 1 ? `å…± ${items.length} å“é …` : items[0].spec,
                qty: items.reduce((a,b)=>a+b.qty,0),
                
                status: document.getElementById('order-status').value,
                rate: rate,
                twdCost: twdCost,
                sell: sell,
                profit: profit,
                paid: document.getElementById('order-paid').checked,
                shipping: document.getElementById('order-shipping').checked,
                note: document.getElementById('order-note').value
            }); 
            saveData(); 
            renderOrders(); 
            updatePurchasingStats();
            toggleOrderForm();
            
            // Reset items
            document.getElementById('order-items-container').innerHTML = '';
            addOrderItemRow();
        }

        function updateOrderDisplaySettings() {
            orderSort = document.getElementById('order-sort-select').value;
            orderFilterUnfinished = document.getElementById('order-filter-unfinished').checked;
            renderOrders();
        }

        function renderOrders(){ 
            const tb=document.getElementById('order-list-body'); 
            if(!tb)return; 
            tb.innerHTML=''; 
            
            let orders = [...appData.orders];
            
            if(orderFilterUnfinished) {
                orders = orders.filter(o => o.status !== "è¨‚å–®å®Œæˆ");
            }
            
            if(orderSort === 'asc') {
                orders.sort((a,b) => new Date(a.date) - new Date(b.date));
            } else {
                orders.sort((a,b) => new Date(b.date) - new Date(a.date));
            }

            document.getElementById('order-count-display').innerText = orders.length;

            orders.forEach(o=>{ 
                const profitClass = o.profit >= 0 ? 'text-morandi-green' : 'text-red-400';
                
                // Construct items display string
                let itemsHtml = '';
                if (o.items && Array.isArray(o.items)) {
                    o.items.forEach(i => {
                        itemsHtml += `<div class="text-xs mb-1">â€¢ ${i.name} ${i.spec ? `(${i.spec})` : ''} x${i.qty}</div>`;
                    });
                } else {
                    // Fallback for old data
                    itemsHtml = `<div class="text-xs">â€¢ ${o.name} ${o.spec ? `(${o.spec})` : ''} x${o.qty}</div>`;
                }

                tb.innerHTML+=`
                <tr>
                    <td class="p-2 border-r border-morandi-dark/10 align-top">
                        <div class="font-bold">${o.date}</div>
                        <div class="text-xs text-morandi-brown">${o.code || '-'}</div>
                        <div class="text-xs font-bold text-morandi-dark mt-1">${o.shop}</div>
                    </td>
                    <td class="p-2 border-r border-morandi-dark/10 align-top">
                        ${itemsHtml}
                        ${o.note ? `<div class="text-[10px] text-gray-400 mt-1 italic">è¨»: ${o.note}</div>` : ''}
                    </td>
                    <td class="p-2 border-r border-morandi-dark/10 align-top"><span class="px-2 py-1 bg-morandi-paper rounded text-xs font-bold whitespace-nowrap">${o.status}</span></td>
                    <td class="p-2 border-r border-morandi-dark/10 text-xs align-top">
                        <div>å”®: ${o.sell}</div>
                        <div>æˆ: ${o.twdCost}</div>
                        <div class="${o.paid ? 'text-green-600' : 'text-red-400'} font-bold mt-1">${o.paid ? 'å·²æ”¶' : 'æœªæ”¶'}</div>
                    </td>
                    <td class="p-2 border-r border-morandi-dark/10 font-bold ${profitClass} align-top">${o.profit}</td>
                    <td class="p-2 text-center align-top"><button onclick="deleteOrder(${o.id})" class="text-red-400 hover:text-red-600"><i class="fas fa-times"></i></button></td>
                </tr>`; 
            }); 
        }
        
        // --- FIXED: updatePurchasingStats ---
        function updatePurchasingStats() {
            let netProfit = 0;
            let revenue = 0;
            let cost = 0;
            let unpaid = 0;
            let statusCount = {};

            ORDER_STATUSES.forEach(s => statusCount[s] = 0);

            appData.orders.forEach(o => {
                netProfit += (o.profit || 0);
                revenue += (o.sell || 0);
                cost += (o.twdCost || 0);
                // é€™è£¡çš„é‚è¼¯æ˜¯ï¼šåªè¦ã€Œå•†å“å·²æ”¶ã€æ²’æ‰“å‹¾ï¼Œå°±åˆ—å…¥æœªæ”¶æ¬¾ï¼Œå®Œå…¨ä¸ç®¡ã€Œé‹è²»å·²åŒ¯ã€æœ‰æ²’æœ‰æ‰“å‹¾
                if(!o.paid) unpaid += (o.sell || 0);
                
                if(statusCount[o.status] !== undefined) statusCount[o.status]++;
                else statusCount[o.status] = 1;
            });

            document.getElementById('stats-net-profit').innerText = `NT$ ${netProfit}`;
            document.getElementById('stats-revenue').innerText = `NT$ ${revenue}`;
            document.getElementById('stats-cost').innerText = `NT$ ${cost}`;
            document.getElementById('stats-total-orders').innerText = appData.orders.length;
            document.getElementById('stats-unpaid').innerText = `NT$ ${unpaid}`;
            
            const margin = revenue > 0 ? Math.round((netProfit / revenue) * 100) : 0;
            document.getElementById('stats-margin').innerText = `${margin}%`;

            // Update Status Distribution
            const distContainer = document.getElementById('stats-status-dist');
            distContainer.innerHTML = '';
            
            // Only show statuses with count > 0
            Object.keys(statusCount).forEach(status => {
                if(statusCount[status] > 0) {
                    const percent = Math.round((statusCount[status] / appData.orders.length) * 100);
                    distContainer.innerHTML += `
                    <div>
                        <div class="flex justify-between text-xs font-bold mb-1">
                            <span>${status} (${statusCount[status]})</span>
                            <span>${percent}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-morandi-blue h-2 rounded-full" style="width: ${percent}%"></div>
                        </div>
                    </div>`;
                }
            });
        }

        // Subs
        function toggleSubForm(){const p=document.getElementById('sub-form-panel'); if(p.classList.contains('open'))p.classList.remove('open'); else p.classList.add('open');}
        function addSub(){ appData.subs.push({id:Date.now(),name:document.getElementById('sub-name').value,price:parseFloat(document.getElementById('sub-price').value),person:document.getElementById('sub-person').value,cycle:document.getElementById('sub-cycle').value,date:document.getElementById('sub-date').value,isPaid:false}); saveData(); renderSubs('service'); toggleSubForm(); }
        
        // --- Updated: renderSubs with Collapsible Logic & Grouping ---
        function renderSubs(viewType){ 
            const container=document.getElementById('sub-list-container'); 
            if(!container)return; 
            container.innerHTML=''; 
            
            // Set active button styles
            const btnService = document.getElementById('btn-view-service');
            const btnPerson = document.getElementById('btn-view-person');
            if(btnService && btnPerson) {
                if(viewType === 'service') {
                    btnService.classList.add('border-morandi-dark', 'bg-morandi-paper');
                    btnService.classList.remove('border-transparent', 'bg-white');
                    btnPerson.classList.add('border-transparent', 'bg-white');
                    btnPerson.classList.remove('border-morandi-dark', 'bg-morandi-paper');
                } else {
                    btnPerson.classList.add('border-morandi-dark', 'bg-morandi-paper');
                    btnPerson.classList.remove('border-transparent', 'bg-white');
                    btnService.classList.add('border-transparent', 'bg-white');
                    btnService.classList.remove('border-morandi-dark', 'bg-morandi-paper');
                }
            }

            // Grouping Logic
            const groups = {};
            appData.subs.forEach(sub => {
                // Key determines grouping: 'service' -> name, 'person' -> person
                const rawKey = viewType === 'service' ? sub.name : sub.person;
                const key = rawKey || (viewType === 'service' ? 'æœªå‘½åæœå‹™' : 'æœªæŒ‡å®šäººå“¡');
                
                if (!groups[key]) groups[key] = { total: 0, items: [] };
                groups[key].items.push(sub);
                groups[key].total += sub.price;
            });

            // Helper to get cycle label
            const getCycleLabel = (c) => {
                if(c === 'quarterly') return 'æ¯å­£';
                if(c === 'yearly') return 'æ¯å¹´';
                return 'æ¯æœˆ';
            };

            // Helper to format date MM/DD
            const formatDateMMDD = (dateStr) => {
                if(!dateStr) return '';
                const parts = dateStr.split('-');
                if(parts.length < 3) return dateStr;
                return `${parts[1]}/${parts[2]}`;
            };

            const keys = Object.keys(groups);
            if(keys.length === 0) {
                container.innerHTML = '<div class="p-4 text-center text-morandi-brown text-sm">ç›®å‰æ²’æœ‰è¨‚é–±è³‡æ–™</div>';
                return;
            }

            keys.forEach((key, index) => {
                const group = groups[key];
                const groupId = `sub-group-${index}`;
                const iconId = `icon-sub-${index}`;
                
                // Create Collapsible Card
                const card = document.createElement('div');
                card.className = "border-2 border-morandi-dark shadow-retro-sm bg-white mb-3 overflow-hidden";
                
                let itemsHtml = '';
                group.items.forEach(item => {
                    // If viewing by service, list shows person; if by person, list shows service
                    const mainText = viewType === 'service' ? (item.person || 'æœªæŒ‡å®š') : item.name;
                    itemsHtml += `
                        <div class="flex justify-between items-center border-b border-morandi-brown/10 pb-2 mb-2 last:border-0 last:mb-0 last:pb-0 hover:bg-gray-50 p-2 rounded transition">
                            <div>
                                <div class="text-sm font-bold text-morandi-dark">${mainText}</div>
                                <div class="text-xs text-morandi-brown flex items-center gap-2">
                                    <span class="bg-morandi-paper px-1 rounded">${formatDateMMDD(item.date)}</span>
                                    <span>${getCycleLabel(item.cycle)}</span>
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="font-bold text-morandi-dark">$${item.price}</span>
                                <button onclick="deleteSub(${item.id})" class="text-xs text-gray-300 hover:text-red-400 px-2"><i class="fas fa-times"></i></button>
                            </div>
                        </div>
                    `;
                });

                card.innerHTML = `
                    <button onclick="toggleCollapse('${groupId}', '${iconId}')" class="w-full flex justify-between items-center p-3 bg-morandi-paper border-b-2 border-morandi-dark hover:bg-morandi-brown/20 transition group">
                        <span class="font-bold text-morandi-dark text-base"><i class="fas ${viewType === 'service' ? 'fa-cube' : 'fa-user'} mr-2 text-xs opacity-50"></i>${key}</span>
                        <div class="flex items-center gap-3">
                            <span class="font-bold text-morandi-dark bg-white px-2 py-1 rounded border border-morandi-dark text-xs">ç¸½è¨ˆ $${group.total}</span>
                            <i id="${iconId}" class="fas fa-chevron-down transition-transform duration-300"></i>
                        </div>
                    </button>
                    <div id="${groupId}" class="collapse-content bg-morandi-bg">
                        <div class="p-3">
                            ${itemsHtml}
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // Ledger
        // --- Updated: Ledger & Camera Fund Editing Logic ---
        
        function updateLedgerTypeOptions(){ 
            const c=document.getElementById('ledger-category').value; 
            const t=document.getElementById('ledger-type'); 
            if(c==='general') {
                t.innerHTML='<option value="income">æ”¶å…¥ (Income)</option><option value="expense">æ”¯å‡º (Expense)</option>';
            } else {
                t.innerHTML='<option value="deposit">å­˜å…¥ (Deposit)</option><option value="withdraw">æå– (Withdraw)</option>'; 
            }
        }

        function resetLedgerForm() {
            document.getElementById('ledger-date').value = '';
            document.getElementById('ledger-desc').value = '';
            document.getElementById('ledger-amount').value = '';
            editingLedgerId = null;
            document.getElementById('btn-save-ledger').textContent = 'æ–°å¢';
            document.getElementById('btn-cancel-ledger').classList.add('hidden');
        }

        function editLedgerEntry(id, category) {
            let entry;
            if(category === 'general') {
                entry = appData.debts.find(d => d.id === id);
                if(entry) {
                    document.getElementById('ledger-category').value = 'general';
                    updateLedgerTypeOptions();
                    // Map old 'owe'/'lend' to new 'expense'/'income' if needed, or stick to new schema
                    let type = entry.type;
                    if(type === 'owe') type = 'expense';
                    if(type === 'lend') type = 'income';
                    document.getElementById('ledger-type').value = type;
                    document.getElementById('ledger-date').value = entry.date;
                    document.getElementById('ledger-desc').value = entry.person; // legacy field mapping
                    document.getElementById('ledger-amount').value = entry.amount;
                }
            } else {
                entry = appData.cameraFund.entries.find(e => e.id === id);
                if(entry) {
                    document.getElementById('ledger-category').value = 'camera';
                    updateLedgerTypeOptions();
                    // Infer type based on sign if not explicitly stored (though for now assume all old are deposits)
                    // New entries will have 'type' field hopefully or handled by sign.
                    // Let's assume stored amount is signed? No, stored as positive usually.
                    // For now, let's look at the object properties.
                    // Actually, let's just assume deposit for old entries unless we have a 'type' field.
                    const type = entry.type || (entry.amount < 0 ? 'withdraw' : 'deposit');
                    document.getElementById('ledger-type').value = type;
                    document.getElementById('ledger-amount').value = Math.abs(entry.amount);
                    document.getElementById('ledger-date').value = entry.date;
                    document.getElementById('ledger-desc').value = entry.desc;
                }
            }

            if(entry) {
                editingLedgerId = { id: id, category: category };
                document.getElementById('btn-save-ledger').textContent = 'æ›´æ–°';
                document.getElementById('btn-cancel-ledger').classList.remove('hidden');
                // Scroll to top of form
                document.getElementById('ledger-form-container').scrollIntoView({ behavior: 'smooth' });
            }
        }

        function saveLedgerEntry(){ 
            const category = document.getElementById('ledger-category').value;
            const type = document.getElementById('ledger-type').value;
            const date = document.getElementById('ledger-date').value; // Optional
            const desc = document.getElementById('ledger-desc').value;
            const amount = parseFloat(document.getElementById('ledger-amount').value);

            if(!desc || isNaN(amount)) return showToast("è«‹è¼¸å…¥é …ç›®èˆ‡é‡‘é¡");

            if (editingLedgerId) {
                // UPDATE Existing
                if(editingLedgerId.category === 'general') {
                    const idx = appData.debts.findIndex(d => d.id === editingLedgerId.id);
                    if(idx !== -1) {
                        appData.debts[idx] = { ...appData.debts[idx], date, type, person: desc, amount };
                    }
                } else {
                    const idx = appData.cameraFund.entries.findIndex(e => e.id === editingLedgerId.id);
                    if(idx !== -1) {
                        // For camera fund, maybe store signed amount or keep positive + type
                        // Let's keep consistent: type + positive amount for display, signed for calc
                        appData.cameraFund.entries[idx] = { ...appData.cameraFund.entries[idx], date, type, desc, amount };
                    }
                }
                showToast("å·²æ›´æ–°");
            } else {
                // CREATE New
                if(category === 'general') {
                    appData.debts.unshift({id:Date.now(), date, type, person: desc, amount, status: 'unsettled'}); 
                } else {
                    appData.cameraFund.entries.unshift({id:Date.now(), date, type, desc, amount});
                }
                showToast("å·²æ–°å¢");
            }

            saveData(); 
            renderDebts(); 
            renderCameraFund(); 
            resetLedgerForm();
        }

        function deleteLedgerEntry(id, category) {
            if(!confirm("ç¢ºå®šåˆªé™¤æ­¤ç­†ç´€éŒ„ï¼Ÿ")) return;
            if(category === 'general') {
                appData.debts = appData.debts.filter(d => d.id !== id);
            } else {
                appData.cameraFund.entries = appData.cameraFund.entries.filter(e => e.id !== id);
            }
            saveData();
            renderDebts();
            renderCameraFund();
        }

        function renderDebts(){ 
            const ul=document.getElementById('debt-list'); 
            if(!ul)return; 
            ul.innerHTML=''; 
            let income=0, expense=0; 
            
            appData.debts.forEach(d=>{ 
                // Normalize legacy types
                const isExpense = (d.type === 'owe' || d.type === 'expense');
                if(isExpense) expense += d.amount;
                else income += d.amount;

                const colorClass = isExpense ? 'text-red-500' : 'text-green-600';
                const sign = isExpense ? '-' : '+';
                
                ul.innerHTML+=`
                    <li class="p-3 bg-white border border-morandi-brown/20 rounded shadow-sm flex justify-between items-center group">
                        <div class="flex-1">
                            <div class="font-bold text-morandi-dark text-sm">${d.person}</div>
                            <div class="text-xs text-gray-400">${d.date || 'ç„¡æ—¥æœŸ'}</div>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="${colorClass} font-bold text-sm">${sign}$${d.amount}</span>
                            <div class="flex gap-1">
                                <button onclick="editLedgerEntry(${d.id}, 'general')" class="text-xs bg-gray-100 p-1 rounded hover:bg-gray-200 text-gray-600"><i class="fas fa-pen"></i></button>
                                <button onclick="deleteLedgerEntry(${d.id}, 'general')" class="text-xs bg-red-50 p-1 rounded hover:bg-red-100 text-red-400"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    </li>`; 
            }); 
            document.getElementById('debt-header-balance').innerText = `(é¤˜é¡: $${income - expense})`; 
        }

        function renderCameraFund(){ 
            let total = 0;
            const l=document.getElementById('fund-list'); 
            l.innerHTML=''; 
            
            appData.cameraFund.entries.forEach(e=>{ 
                // Determine if withdraw or deposit
                // Legacy data might rely on 'amount' sign, new data uses 'type'
                const isWithdraw = (e.type === 'withdraw');
                const val = parseFloat(e.amount);
                
                if(isWithdraw) total -= val;
                else total += val;

                const colorClass = isWithdraw ? 'text-red-500' : 'text-morandi-green';
                const sign = isWithdraw ? '-' : '+';

                l.innerHTML+=`
                    <li class="flex justify-between items-center border-b border-dashed border-gray-200 py-2 last:border-0 hover:bg-gray-50 px-2 rounded transition">
                        <div class="flex-1">
                            <span class="text-sm font-bold text-morandi-dark block">${e.desc}</span>
                            <span class="text-[10px] text-gray-400 block">${e.date || ''}</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="font-bold ${colorClass}">${sign}$${val}</span>
                            <div class="flex gap-1">
                                <button onclick="editLedgerEntry(${e.id}, 'camera')" class="text-xs text-gray-400 hover:text-gray-600"><i class="fas fa-pen"></i></button>
                                <button onclick="deleteLedgerEntry(${e.id}, 'camera')" class="text-xs text-gray-300 hover:text-red-400"><i class="fas fa-times"></i></button>
                            </div>
                        </div>
                    </li>`; 
            }); 
            
            document.getElementById('camera-current').textContent=total; 
            document.getElementById('camera-bar').style.width=Math.min(total/50000*100,100)+'%'; 
            document.getElementById('camera-percent').textContent=Math.round(total/50000*100)+'%'; 
            document.getElementById('camera-header-balance').textContent=`(å­˜$${total})`; 
        }

        // Literature
        function addLit(){
            appData.literature.unshift({
                id: Date.now(),
                title: document.getElementById('lit-title').value,
                author: document.getElementById('lit-author').value,
                date: document.getElementById('lit-date').value,
                type: document.getElementById('lit-type').value,
                status: document.getElementById('lit-status').value,
                link: document.getElementById('lit-link').value,
                note: document.getElementById('lit-note').value,
                
                // New Fields
                field: document.getElementById('lit-field').value,
                keywords: document.getElementById('lit-keywords').value,
                doi: document.getElementById('lit-doi').value,
                theories: document.getElementById('lit-theories').value,
                
                // Methodology
                iv: document.getElementById('lit-method-iv').value,
                dv: document.getElementById('lit-method-dv').value,
                med: document.getElementById('lit-method-med').value,
                mod: document.getElementById('lit-method-mod').value,
                
                // Core
                background: document.getElementById('lit-background').value,
                purpose: document.getElementById('lit-purpose').value,
                conclusion: document.getElementById('lit-conclusion').value
            });
            saveData();
            renderLiterature();
            toggleCollapse('lit-form-panel','icon-add-lit');
        }

        function deleteLit(id){if(confirm("åˆªé™¤ï¼Ÿ")){appData.literature=appData.literature.filter(x=>x.id!==id);saveData();renderLiterature();}}
        
        function renderLiterature(){ 
            const c=document.getElementById('lit-list-container'); 
            if(!c)return; 
            c.innerHTML=''; 
            
            appData.literature.forEach(l=>{ 
                const cardId = `lit-card-${l.id}`;
                const detailId = `lit-detail-${l.id}`;
                
                const d=document.createElement('div'); 
                d.className="bg-white border-2 border-morandi-dark shadow-retro-sm overflow-hidden"; 
                
                // Content Construction
                d.innerHTML = `
                    <div class="p-4 border-b border-morandi-dark/10">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h4 class="font-bold text-lg text-morandi-dark leading-snug">${l.title}</h4>
                                <p class="text-xs text-morandi-brown mt-1">${l.author} Â· ${l.date}</p>
                            </div>
                            <div class="flex flex-col items-end gap-1">
                                <span class="px-2 py-1 bg-morandi-paper rounded text-xs whitespace-nowrap font-bold">${l.type}</span>
                                <span class="px-2 py-1 bg-morandi-green text-white rounded text-xs whitespace-nowrap font-bold">${l.status}</span>
                            </div>
                        </div>
                        
                        <div class="flex flex-wrap gap-2 mb-3">
                            ${l.field ? `<span class="text-[10px] border border-morandi-dark rounded-full px-2 py-0.5 text-morandi-dark bg-white"><i class="fas fa-tag mr-1"></i>${l.field}</span>` : ''}
                            ${l.keywords ? l.keywords.split(/,|ï¼Œ/).map(k => `<span class="text-[10px] bg-gray-100 rounded px-2 py-0.5 text-gray-600">#${k.trim()}</span>`).join('') : ''}
                        </div>

                        <div class="flex justify-between items-center mt-4">
                            <button onclick="toggleCollapse('${detailId}', 'icon-${detailId}')" class="text-xs font-bold text-morandi-dark hover:text-morandi-accent flex items-center group">
                                <i id="icon-${detailId}" class="fas fa-book-reader mr-2 transition-transform"></i> ğŸ“– æŸ¥çœ‹è©³æƒ…
                            </button>
                            <div class="flex gap-3">
                                ${l.link ? `<a href="${l.link}" target="_blank" class="text-morandi-blue text-xs hover:underline"><i class="fas fa-external-link-alt"></i></a>` : ''}
                                <button onclick="deleteLit(${l.id})" class="text-red-400 text-xs hover:text-red-600"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    </div>

                    <div id="${detailId}" class="collapse-content bg-morandi-bg/30">
                        <div class="p-4 space-y-4 text-sm text-gray-700">
                            
                            <!-- Methodology Grid -->
                            ${ (l.iv || l.dv || l.med || l.mod) ? `
                            <div class="bg-white p-3 border border-morandi-dark/20 rounded shadow-sm">
                                <h5 class="text-xs font-bold text-morandi-brown uppercase mb-2 border-b border-gray-100 pb-1">è®Šæ•¸æ¨¡å‹</h5>
                                <div class="grid grid-cols-2 gap-2 text-xs">
                                    ${l.iv ? `<div><span class="font-bold text-blue-800">IV:</span> ${l.iv}</div>` : ''}
                                    ${l.dv ? `<div><span class="font-bold text-red-800">DV:</span> ${l.dv}</div>` : ''}
                                    ${l.med ? `<div><span class="font-bold text-green-800">Med:</span> ${l.med}</div>` : ''}
                                    ${l.mod ? `<div><span class="font-bold text-purple-800">Mod:</span> ${l.mod}</div>` : ''}
                                </div>
                            </div>` : ''}

                            <!-- Core Content -->
                            ${l.background ? `<div><h5 class="font-bold text-xs text-morandi-dark mb-1">èƒŒæ™¯</h5><p class="bg-white p-2 rounded border border-gray-100">${l.background}</p></div>` : ''}
                            ${l.purpose ? `<div><h5 class="font-bold text-xs text-morandi-dark mb-1">ç›®çš„</h5><p class="bg-white p-2 rounded border border-gray-100">${l.purpose}</p></div>` : ''}
                            ${l.conclusion ? `<div><h5 class="font-bold text-xs text-morandi-dark mb-1">çµè«–</h5><p class="bg-white p-2 rounded border border-gray-100">${l.conclusion}</p></div>` : ''}
                            
                            <!-- Meta -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-xs text-gray-500 pt-2 border-t border-gray-200">
                                ${l.doi ? `<div><strong>DOI:</strong> ${l.doi}</div>` : ''}
                                ${l.theories ? `<div><strong>ç†è«–:</strong> ${l.theories}</div>` : ''}
                            </div>

                            ${l.note ? `<div class="bg-yellow-50 p-3 text-xs italic border-l-4 border-yellow-200 text-gray-600 mt-2">"${l.note}"</div>` : ''}
                        </div>
                    </div>
                `;
                c.appendChild(d); 
            }); 
        }

        function exportLit(){ const a=document.createElement('a'); a.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(appData.literature)); a.download="literature.json"; a.click(); }
        function importLit(input){ const f=input.files[0]; if(!f)return; const r=new FileReader(); r.onload=e=>{ appData.literature=[...JSON.parse(e.target.result),...appData.literature]; saveData(); renderLiterature(); }; r.readAsText(f); input.value=''; }

        // Common & Helpers
        function deleteDrink(id){if(confirm("åˆªé™¤ï¼Ÿ")){appData.drinks=appData.drinks.filter(x=>x.id!==id);saveData();renderDrinks();updateStats();}} 
        function deleteOrder(id){if(confirm("åˆªé™¤è¨‚å–®ï¼Ÿ")){appData.orders=appData.orders.filter(x=>x.id!==id);saveData();renderOrders();updatePurchasingStats();}} 
        function deleteSub(id){if(confirm("åˆªé™¤è¨‚é–±ï¼Ÿ")){appData.subs=appData.subs.filter(x=>x.id!==id);saveData();renderSubs();}} 
        function toggleDebtStatus(id){const d=appData.debts.find(x=>x.id===id); if(d){d.status=d.status==='settled'?'unsettled':'settled'; saveData(); renderDebts();}}
        // function deleteDebt(id){if(confirm("åˆªé™¤æ­¤ç­†å¸³å‹™ï¼Ÿ")){appData.debts=appData.debts.filter(x=>x.id!==id);saveData();renderDebts();}} // Replaced by deleteLedgerEntry
        
        // Export/Import Placeholders (Functional)
        function exportData(key, filename) { const a=document.createElement('a'); a.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(appData[key])); a.download=filename; a.click(); }
        function importData(input, key, renderFn) { const f=input.files[0]; if(!f)return; const r=new FileReader(); r.onload=e=>{ appData[key]=[...JSON.parse(e.target.result),...appData[key]]; saveData(); renderFn(); }; r.readAsText(f); input.value=''; }

        function exportTasks(){exportData('tasks','tasks.json')} function importTasks(i){importData(i,'tasks',()=>{renderTasks();renderCalendar();})}
        function exportDrinks(){exportData('drinks','drinks.json')} function importDrinks(i){importData(i,'drinks',()=>{renderDrinks();updateStats();})}
        function exportOrders(){exportData('orders','orders.json')} function importOrders(i){importData(i,'orders',()=>{renderOrders();updatePurchasingStats();})}
        function exportSubs(){exportData('subs','subs.json')} function importSubs(i){importData(i,'subs',()=>{renderSubs('service');})}
        function exportTracker(){/* Exports debt+camera */ const data={debts:appData.debts,cameraFund:appData.cameraFund}; const a=document.createElement('a'); a.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(data)); a.download="investment.json"; a.click();} 
        
        // --- Updated Import Tracker for Legacy Compatibility ---
        function importTracker(i){
            const f=i.files[0];
            if(!f)return;
            const r=new FileReader();
            r.onload=e=>{
                const d=JSON.parse(e.target.result);
                
                // 1. Handle Legacy Debts (General Ledger)
                if(d.debts && Array.isArray(d.debts)) {
                    const newDebts = d.debts.map(old => ({
                        id: old.id || Date.now() + Math.random(),
                        date: old.date || '',
                        type: (old.type === 'debt') ? 'expense' : (old.type === 'repayment' ? 'income' : old.type),
                        person: old.item || old.person, // Map 'item' to 'person' (description)
                        amount: parseFloat(old.amount),
                        status: 'unsettled'
                    }));
                    appData.debts = [...newDebts, ...appData.debts];
                }

                // 2. Handle Legacy Camera Fund
                if(d.cameraFund && Array.isArray(d.cameraFund)) {
                    const newFundEntries = d.cameraFund.map(old => ({
                        id: old.id || Date.now() + Math.random(),
                        date: old.date || '',
                        type: old.type, // 'deposit' or 'withdraw' matches
                        desc: old.item || old.desc, // Map 'item' to 'desc'
                        amount: parseFloat(old.amount)
                    }));
                    // Check if appData.cameraFund is object (new) or array (old logic fallback, though we init as object)
                    if (!appData.cameraFund.entries) appData.cameraFund = { target: 50000, entries: [] };
                    appData.cameraFund.entries = [...newFundEntries, ...appData.cameraFund.entries];
                }

                // 3. Handle Legacy Subs (Flattening) - Optional if user imports full backup here
                if(d.subs && Array.isArray(d.subs)) {
                     const newSubs = [];
                     d.subs.forEach(service => {
                         if(service.members && Array.isArray(service.members)) {
                             service.members.forEach(member => {
                                 newSubs.push({
                                     id: Date.now() + Math.random(),
                                     name: service.name,
                                     price: parseFloat(service.costPerPerson),
                                     person: member.name,
                                     date: member.startDate,
                                     cycle: 'yearly' // Default legacy to yearly
                                 });
                             });
                         }
                     });
                     appData.subs = [...newSubs, ...appData.subs];
                }

                saveData();
                renderDebts();
                renderCameraFund();
                renderSubs('service'); // Refresh subs if any
                showToast("åŒ¯å…¥æˆåŠŸï¼");
            };
            r.readAsText(i);
            i.value='';
        }
    </script>
</body>
</html>