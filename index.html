<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å€‹äººå¾©å¤æ‰‹æœ­</title>
    <!-- Google Fonts: Cinzel for headers, Lora for body -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Lora:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- QR Code Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        morandi: {
                            bg: '#F4F1EA',      /* èƒŒæ™¯ï¼šç±³ç™½ */
                            paper: '#EAE5DE',   /* å´é‚Šæ¬„ï¼šç°ç±³ */
                            green: '#8F9E8B',   /* ç¶  */
                            blue: '#8CA0A8',    /* è— */
                            pink: '#C4A8A6',    /* ç²‰ */
                            brown: '#8D7F71',   /* æ·ºæ£• */
                            dark: '#4A4238',    /* æ·±æ£• (é‚Šæ¡†/æ–‡å­—) */
                            accent: '#A67F78'   /* ç£šç´… */
                        }
                    },
                    fontFamily: {
                        serif: ['Lora', 'serif'],
                        display: ['Cinzel', 'serif'],
                    },
                    boxShadow: {
                        'retro': '4px 4px 0px 0px #4A4238',
                        'retro-sm': '2px 2px 0px 0px #4A4238',
                        'retro-hover': '1px 1px 0px 0px #4A4238',
                        'retro-deep': '8px 8px 0px 0px #4A4238',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Lora', serif;
            color: #4A4238;
            background-color: #F4F1EA;
            /* è¼•å¾®çš„å™ªé»ç´‹ç†å¢åŠ ç´™å¼µæ„Ÿ */
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.05'/%3E%3C/svg%3E");
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #EAE5DE;
        }
        ::-webkit-scrollbar-thumb {
            background: #8D7F71; 
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #4A4238;
        }

        /* Animations */
        .fade-in {
            animation: fadeIn 0.4s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Interactive Elements Transition */
        .btn-retro {
            transition: all 0.1s;
        }
        .btn-retro:active {
            transform: translate(2px, 2px);
            box-shadow: 1px 1px 0px 0px #4A4238;
        }

        /* Tab Active State */
        .tab-btn {
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .tab-btn:hover {
            background-color: rgba(141, 127, 113, 0.1);
        }
        .tab-btn.active {
            background-color: #4A4238;
            color: #F4F1EA;
            border: 2px solid #4A4238;
            box-shadow: 3px 3px 0px 0px rgba(141, 127, 113, 0.5);
            transform: translate(-1px, -1px);
        }
        
        /* Input Styles */
        input, select, textarea {
            background-color: #FCFAF8;
            border: 2px solid #4A4238;
            color: #4A4238;
            outline: none;
            transition: all 0.2s;
            box-shadow: 2px 2px 0px 0px transparent;
            font-size: 16px; /* Prevent iOS zoom */
        }
        input:focus, select:focus, textarea:focus {
            box-shadow: 4px 4px 0px 0px #A67F78;
            transform: translate(-2px, -2px);
        }
        input:disabled {
            background-color: #EAE5DE;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        input[readonly] {
            background-color: #EAE5DE;
            color: #8D7F71;
            cursor: not-allowed;
        }

        /* Checkbox Customization */
        input[type="checkbox"] {
            appearance: none;
            width: 1.2rem;
            height: 1.2rem;
            border: 2px solid #4A4238;
            background-color: white;
            cursor: pointer;
            display: grid;
            place-content: center;
        }
        input[type="checkbox"]::before {
            content: "";
            width: 0.65em;
            height: 0.65em;
            transform: scale(0);
            transition: 120ms transform ease-in-out;
            box-shadow: inset 1em 1em #4A4238;
        }
        input[type="checkbox"]:checked::before {
            transform: scale(1);
        }

        /* Collapse Transition */
        .collapse-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            border-top: 0px solid #4A4238;
        }
        .collapse-content.open {
            max-height: 2000px; 
            border-top: 2px solid #4A4238;
        }
        
        /* Specific transition for the drink form panel */
        #drink-form-panel, #order-form-panel, #sub-form-panel {
            transition: max-height 0.4s ease-in-out, opacity 0.4s ease-in-out, margin 0.4s;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            margin-bottom: 0;
        }
        #drink-form-panel.open, #order-form-panel.open, #sub-form-panel.open {
            max-height: 1000px;
            opacity: 1;
            margin-bottom: 1.5rem;
        }

        /* Calendar Styles */
        .calendar-day {
            min-height: 60px; /* Mobile */
            transition: all 0.2s;
        }
        @media (min-width: 768px) {
            .calendar-day {
                min-height: 100px; /* Desktop */
            }
        }
        .calendar-day:hover {
            background-color: rgba(141, 127, 113, 0.1);
        }
        .calendar-day.today {
            background-color: rgba(234, 229, 222, 0.5);
            border: 2px solid #A67F78;
        }
        
        /* Mobile Sticky Nav Shadow */
        .mobile-nav-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        /* Hide Scrollbar */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col md:flex-row max-w-7xl mx-auto md:my-8 bg-morandi-bg">

    <!-- Sidebar / Topbar Navigation -->
    <nav class="w-full md:w-24 bg-morandi-paper border-b-2 md:border-b-0 md:border-2 border-morandi-dark md:shadow-retro-deep p-2 md:p-4 flex flex-col gap-2 md:gap-6 shrink-0 z-50 sticky top-0 md:relative md:h-[calc(100vh-4rem)] md:top-8 mobile-nav-shadow md:shadow-none transition-all duration-300">
        
        <!-- Header (Logo) -->
        <div class="flex justify-between items-center md:flex-col md:text-center md:pb-6 md:border-b-2 md:border-morandi-dark md:border-dashed px-2 md:px-0">
            <!-- Desktop: Compact Logo -->
            <div class="border-2 border-morandi-dark p-1 bg-white shadow-retro-sm md:w-full md:aspect-square md:flex md:items-center md:justify-center md:p-1">
                <p class="text-xs text-center font-bold text-morandi-dark font-display tracking-wider leading-tight">
                    <span class="md:hidden"><i class="fas fa-quote-left mr-1"></i>Carpe Diem<i class="fas fa-quote-right ml-1"></i></span>
                    <span class="hidden md:block text-[10px]">Carpe<br>Diem</span>
                </p>
            </div>
            <!-- Mobile Only Year -->
            <div class="md:hidden ml-3 text-[10px] text-morandi-brown font-bold tracking-widest border border-morandi-brown px-1 rounded">2025</div>
        </div>

        <!-- Menu Items (Emoji Style) -->
        <div class="flex flex-row md:flex-col gap-2 md:gap-4 overflow-x-auto md:overflow-visible pb-1 md:pb-0 scrollbar-hide no-scrollbar items-center md:items-center px-1 md:px-0 h-full">
            <button onclick="switchTab('planner')" id="btn-planner" class="tab-btn active p-2 rounded-lg flex items-center justify-center transition-all md:w-14 md:h-14 md:text-2xl" title="æ—¥ç¨‹èˆ‡æé†’">
                <span class="md:hidden flex items-center gap-2"><span class="text-lg">ğŸ“…</span><span class="text-xs font-bold">æ—¥ç¨‹</span></span>
                <span class="hidden md:inline">ğŸ“…</span>
            </button>
            <button onclick="switchTab('drinks')" id="btn-drinks" class="tab-btn p-2 rounded-lg flex items-center justify-center transition-all md:w-14 md:h-14 md:text-2xl" title="é£²å“ç´€éŒ„">
                <span class="md:hidden flex items-center gap-2"><span class="text-lg">ğŸ§‹</span><span class="text-xs font-bold">é£²å“</span></span>
                <span class="hidden md:inline">ğŸ§‹</span>
            </button>
            <button onclick="switchTab('purchasing')" id="btn-purchasing" class="tab-btn p-2 rounded-lg flex items-center justify-center transition-all md:w-14 md:h-14 md:text-2xl" title="ä»£è³¼ç®¡ç†">
                <span class="md:hidden flex items-center gap-2"><span class="text-lg">ğŸ›ï¸</span><span class="text-xs font-bold">ä»£è³¼</span></span>
                <span class="hidden md:inline">ğŸ›ï¸</span>
            </button>
            <button onclick="switchTab('subs')" id="btn-subs" class="tab-btn p-2 rounded-lg flex items-center justify-center transition-all md:w-14 md:h-14 md:text-2xl" title="è¨‚é–±ç®¡ç†">
                <span class="md:hidden flex items-center gap-2"><span class="text-lg">ğŸ’³</span><span class="text-xs font-bold">è¨‚é–±</span></span>
                <span class="hidden md:inline">ğŸ’³</span>
            </button>
            <button onclick="switchTab('debt')" id="btn-debt" class="tab-btn p-2 rounded-lg flex items-center justify-center transition-all md:w-14 md:h-14 md:text-2xl" title="å…¨çƒç™¾å¤§ä¼æ¥­æŠ•è³‡">
                <span class="md:hidden flex items-center gap-2"><span class="text-lg">ğŸ’°</span><span class="text-xs font-bold">æŠ•è³‡</span></span>
                <span class="hidden md:inline">ğŸ’°</span>
            </button>
            <button onclick="switchTab('tools')" id="btn-tools" class="tab-btn p-2 rounded-lg flex items-center justify-center transition-all md:w-14 md:h-14 md:text-2xl" title="å°å·¥å…·">
                <span class="md:hidden flex items-center gap-2"><span class="text-lg">ğŸ› ï¸</span><span class="text-xs font-bold">å·¥å…·</span></span>
                <span class="hidden md:inline">ğŸ› ï¸</span>
            </button>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="flex-1 p-3 md:p-4 overflow-y-auto relative min-h-screen md:min-h-0 md:h-auto mt-0 md:mt-0 pb-24 md:pb-4">
        
        <!-- Tab 1: Planner -->
        <div id="tab-planner" class="section-content fade-in space-y-4 md:space-y-8 pb-10">
            <header class="flex flex-col md:flex-row justify-between items-start md:items-end border-b-4 border-morandi-dark pb-2 mb-2 md:mb-4 gap-2">
                <div>
                    <h2 class="text-2xl md:text-4xl font-display font-bold text-morandi-dark">æ—¥ç¨‹èˆ‡æé†’</h2>
                    <p class="text-xs md:text-sm font-bold text-morandi-brown mt-1 uppercase tracking-widest">Planner & Calendar</p>
                </div>
                <div class="flex flex-row-reverse md:flex-col items-end gap-2 w-full md:w-auto justify-between md:justify-start">
                    <div id="current-date" class="font-display text-xs md:text-base text-morandi-dark font-bold bg-morandi-paper px-2 md:px-3 py-1 border-2 border-morandi-dark shadow-retro-sm flex items-center gap-2 tracking-wide"></div>
                    <div class="flex gap-2">
                        <button onclick="exportTasks()" class="btn-retro px-2 md:px-3 py-1 text-[10px] md:text-xs bg-white border-2 border-morandi-dark text-morandi-dark font-bold shadow-retro-sm hover:bg-gray-50"><i class="fas fa-file-export"></i> <span class="hidden md:inline">åŒ¯å‡º</span></button>
                        <label class="btn-retro px-2 md:px-3 py-1 text-[10px] md:text-xs bg-morandi-brown border-2 border-morandi-dark text-white font-bold shadow-retro-sm hover:bg-morandi-brown/80 cursor-pointer flex items-center"><i class="fas fa-file-import mr-1"></i> <span class="hidden md:inline">åŒ¯å…¥</span><input type="file" class="hidden" onchange="importTasks(this)"></label>
                    </div>
                </div>
            </header>
            
            <!-- Calendar View (Responsive Grid) -->
            <div class="bg-white border-2 border-morandi-dark shadow-retro mb-4 md:mb-6">
                <div class="p-3 md:p-6 bg-morandi-bg">
                    <div class="flex justify-between items-center mb-4">
                        <button onclick="changeMonth(-1)" class="btn-retro px-3 py-1 bg-white border border-morandi-dark rounded"><i class="fas fa-chevron-left"></i></button>
                        <h3 id="calendar-month-year" class="text-lg md:text-xl font-display font-bold text-morandi-dark">Month Year</h3>
                        <button onclick="changeMonth(1)" class="btn-retro px-3 py-1 bg-white border border-morandi-dark rounded"><i class="fas fa-chevron-right"></i></button>
                    </div>
                    <div class="grid grid-cols-7 gap-1 text-center font-bold text-morandi-brown text-xs md:text-sm mb-2"><div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div></div>
                    <div id="calendar-grid" class="grid grid-cols-7 gap-1 border-t-2 border-morandi-dark pt-2"></div>
                </div>
            </div>
            
            <!-- Add Task Form -->
            <div class="bg-white border-2 border-morandi-dark shadow-retro scroll-mt-20 md:scroll-mt-4" id="add-task-container">
                <button onclick="toggleCollapse('add-task-content', 'icon-add-task')" class="w-full flex justify-between items-center p-3 md:p-5 bg-morandi-paper hover:bg-morandi-brown/20 transition text-left group">
                    <span class="font-bold text-base md:text-lg text-morandi-dark"><i class="fas fa-plus-circle mr-2"></i> æ–°å¢æ—¥ç¨‹</span>
                    <i id="icon-add-task" class="fas fa-chevron-down transition-transform border-2 border-morandi-dark rounded-full p-1 w-6 h-6 md:w-8 md:h-8 flex items-center justify-center bg-white text-xs md:text-base"></i>
                </button>
                <div id="add-task-content" class="collapse-content bg-white">
                    <div class="p-4 md:p-6 bg-morandi-bg">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3 md:gap-4">
                            <div class="flex flex-col"><label class="text-xs font-bold text-morandi-dark mb-1">æ—¥æœŸ</label><input type="date" id="task-date" class="p-2 w-full text-sm"></div>
                            <div class="flex flex-col"><label class="text-xs font-bold text-morandi-dark mb-1">æ™‚é–“</label><div class="flex items-center gap-2"><input type="time" id="task-time" class="p-2 w-full text-sm"><label class="flex items-center gap-1 whitespace-nowrap text-xs font-bold text-morandi-dark cursor-pointer"><input type="checkbox" id="task-allday" onchange="toggleTimeInput()"> å…¨æ—¥</label></div></div>
                            <div class="flex flex-col md:col-span-2"><label class="text-xs font-bold text-morandi-dark mb-1">é¡å‹</label><select id="task-priority" class="p-2 w-full text-sm font-bold bg-white cursor-pointer"><option value="q1">ğŸ”¥ ç·Šæ€¥ä¸”é‡è¦</option><option value="q2">â­ é‡è¦ä½†ä¸ç·Šæ€¥</option><option value="q3">âš¡ ç·Šæ€¥ä½†ä¸é‡è¦</option><option value="q4">â˜• ä¸é‡è¦ä¸ç·Šæ€¥</option></select></div>
                            <div class="flex flex-col md:col-span-4"><label class="text-xs font-bold text-morandi-dark mb-1">æ¨™é¡Œ</label><input type="text" id="task-title" placeholder="ä»»å‹™æ¨™é¡Œ..." class="p-2 w-full text-lg font-bold"></div>
                            <div class="flex flex-col md:col-span-4"><label class="text-xs font-bold text-morandi-dark mb-1">å…§å®¹</label><textarea id="task-content" rows="3" placeholder="è©³ç´°å…§å®¹..." class="p-2 w-full text-sm"></textarea></div>
                            <div class="flex flex-col md:col-span-2"><label class="text-xs font-bold text-morandi-dark mb-1">åœ°é»</label><input type="text" id="task-location" placeholder="è¼¸å…¥åœ°é»" class="p-2 w-full text-sm"></div>
                            <div class="flex flex-col md:col-span-2"><label class="text-xs font-bold text-morandi-dark mb-1">ç¶²å€</label><input type="text" id="task-url" placeholder="ç›¸é—œé€£çµ..." class="p-2 w-full text-sm"></div>
                            <div class="md:col-span-4 mt-2"><button onclick="addTask()" class="btn-retro w-full bg-morandi-dark text-white py-3 border-2 border-morandi-dark font-bold hover:bg-gray-800 shadow-retro-sm"><i class="fas fa-feather-alt mr-2"></i> æ–°å¢</button></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Matrix -->
            <div class="bg-white border-2 border-morandi-dark shadow-retro mt-4 md:mt-6">
                <button onclick="toggleCollapse('matrix-content', 'icon-matrix-view')" class="w-full flex justify-between items-center p-3 md:p-5 bg-morandi-paper hover:bg-morandi-brown/20 transition text-left group">
                    <span class="font-bold text-base md:text-lg text-morandi-dark"><i class="fas fa-th-large mr-2"></i> å¾…è¾¦çŸ©é™£</span>
                    <i id="icon-matrix-view" class="fas fa-chevron-down transition-transform border-2 border-morandi-dark rounded-full p-1 w-6 h-6 md:w-8 md:h-8 flex items-center justify-center bg-white text-xs md:text-base"></i>
                </button>
                <div id="matrix-content" class="collapse-content bg-white open">
                    <div class="p-3 md:p-6 bg-morandi-bg">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-8">
                            <div class="bg-white border-2 border-morandi-dark shadow-retro-sm flex flex-col relative h-[250px] md:h-[350px]"><div class="bg-morandi-pink border-b-2 border-morandi-dark p-2 md:p-3 flex justify-between items-center"><h3 class="font-bold text-morandi-dark text-sm md:text-base"><i class="fas fa-fire mr-2"></i> ç·Šæ€¥é‡è¦</h3><span class="font-display font-bold text-lg md:text-xl opacity-50">I</span></div><div class="p-2 md:p-4 h-full overflow-y-auto custom-scroll"><ul id="list-q1" class="space-y-3"></ul></div></div>
                            <div class="bg-white border-2 border-morandi-dark shadow-retro-sm flex flex-col relative h-[250px] md:h-[350px]"><div class="bg-morandi-blue border-b-2 border-morandi-dark p-2 md:p-3 flex justify-between items-center"><h3 class="font-bold text-morandi-dark text-sm md:text-base"><i class="fas fa-star mr-2"></i> é‡è¦ä¸æ€¥</h3><span class="font-display font-bold text-lg md:text-xl opacity-50">II</span></div><div class="p-2 md:p-4 h-full overflow-y-auto custom-scroll"><ul id="list-q2" class="space-y-3"></ul></div></div>
                            <div class="bg-white border-2 border-morandi-dark shadow-retro-sm flex flex-col relative h-[250px] md:h-[350px]"><div class="bg-yellow-200 border-b-2 border-morandi-dark p-2 md:p-3 flex justify-between items-center"><h3 class="font-bold text-morandi-dark text-sm md:text-base"><i class="fas fa-bolt mr-2"></i> ç·Šæ€¥ä¸é‡</h3><span class="font-display font-bold text-lg md:text-xl opacity-50">III</span></div><div class="p-2 md:p-4 h-full overflow-y-auto custom-scroll"><ul id="list-q3" class="space-y-3"></ul></div></div>
                            <div class="bg-white border-2 border-morandi-dark shadow-retro-sm flex flex-col relative h-[250px] md:h-[350px]"><div class="bg-gray-200 border-b-2 border-morandi-dark p-2 md:p-3 flex justify-between items-center"><h3 class="font-bold text-morandi-dark text-sm md:text-base"><i class="fas fa-coffee mr-2"></i> ä¸æ€¥ä¸é‡</h3><span class="font-display font-bold text-lg md:text-xl opacity-50">IV</span></div><div class="p-2 md:p-4 h-full overflow-y-auto custom-scroll"><ul id="list-q4" class="space-y-3"></ul></div></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 2: Drinks Tracker -->
        <div id="tab-drinks" class="section-content hidden fade-in space-y-4 md:space-y-8 pb-10">
            <header class="flex flex-col md:flex-row justify-between items-start md:items-end border-b-4 border-morandi-dark pb-2 mb-4 gap-2">
                <div>
                    <h2 class="text-2xl md:text-4xl font-display font-bold text-morandi-dark">é£²å“ç´€éŒ„</h2>
                    <p class="text-xs md:text-sm font-bold text-morandi-brown mt-1 uppercase tracking-widest">Beverage Log</p>
                </div>
                <div class="flex flex-wrap gap-2 justify-end w-full md:w-auto">
                    <button onclick="toggleDrinkForm()" class="btn-retro px-2 md:px-3 py-1 text-[10px] md:text-xs bg-morandi-dark text-white font-bold shadow-retro-sm hover:bg-gray-700"><i class="fas fa-plus mr-1"></i> æ–°å¢</button>
                    <button onclick="exportDrinks()" class="btn-retro px-2 md:px-3 py-1 text-[10px] md:text-xs bg-white border-2 border-morandi-dark text-morandi-dark font-bold shadow-retro-sm hover:bg-gray-50"><i class="fas fa-file-export"></i> <span class="hidden md:inline">åŒ¯å‡º</span></button>
                    <label class="btn-retro px-2 md:px-3 py-1 text-[10px] md:text-xs bg-morandi-brown border-2 border-morandi-dark text-white font-bold shadow-retro-sm hover:bg-morandi-brown/80 cursor-pointer flex items-center"><i class="fas fa-file-import mr-1"></i> <span class="hidden md:inline">åŒ¯å…¥</span><input type="file" class="hidden" onchange="importDrinks(this)"></label>
                </div>
            </header>
            
            <!-- Hidden Slide-down Add Form -->
            <div id="drink-form-panel" class="bg-white border-2 border-morandi-dark shadow-retro mb-4 md:mb-6 overflow-hidden">
                <div class="p-4 md:p-6 bg-morandi-bg">
                    <h4 class="font-bold text-lg text-morandi-dark mb-4 border-b border-morandi-brown/30 pb-2">æ–°å¢é£²å“ç´€éŒ„</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-6 mb-4">
                        <div class="flex flex-col"><label class="text-xs font-bold text-morandi-dark mb-1">æ—¥æœŸ</label><input type="date" id="drink-date" class="p-3 w-full text-sm"></div>
                        <div class="flex flex-col"><label class="text-xs font-bold text-morandi-dark mb-1">åº—å®¶</label><input type="text" id="drink-shop" placeholder="ä¾‹ï¼š50åµ" class="p-3 w-full text-sm"></div>
                        <div class="flex flex-col md:col-span-2"><label class="text-xs font-bold text-morandi-dark mb-1">é£²æ–™åç¨±</label><input type="text" id="drink-name" placeholder="ä¾‹ï¼šå››å­£æ˜¥çæ³¢æ¤°" class="p-3 w-full text-sm"></div>
                        <div class="flex flex-col"><label class="text-xs font-bold text-morandi-dark mb-1">å†°å¡Š</label><select id="drink-ice" class="p-3 w-full text-sm font-bold bg-white"><option value="æ­£å¸¸">æ­£å¸¸</option><option value="å°‘å†°">å°‘å†°</option><option value="å¾®å†°">å¾®å†°</option><option value="å»å†°">å»å†°</option><option value="å¸¸æº«">å¸¸æº«</option><option value="æº«">æº«</option><option value="ç„¡">ç„¡æ³•èª¿æ•´/ç„¡</option></select></div>
                        <div class="flex flex-col"><label class="text-xs font-bold text-morandi-dark mb-1">ç”œåº¦</label><select id="drink-sugar" class="p-3 w-full text-sm font-bold bg-white"><option value="æ­£å¸¸">æ­£å¸¸</option><option value="å°‘ç³–">å°‘ç³–</option><option value="å¾®ç³–">å¾®ç³–</option><option value="ç„¡ç³–">ç„¡ç³–</option><option value="ç„¡">ç„¡æ³•èª¿æ•´/ç„¡</option></select></div>
                        <div class="flex flex-col md:col-span-2">
                            <label class="text-xs font-bold text-morandi-dark mb-1">é‡‘é¡ (NT$)</label>
                            <div class="flex items-center gap-3">
                                <input type="number" id="drink-price" placeholder="50" class="p-3 w-full text-sm flex-1">
                                <label class="flex items-center gap-1 whitespace-nowrap text-xs font-bold text-morandi-dark cursor-pointer bg-white px-3 py-2 border border-morandi-dark rounded shadow-sm hover:bg-gray-50"><input type="checkbox" id="drink-treat"> ğŸ è¢«è«‹å®¢</label>
                                <label class="flex items-center gap-1 whitespace-nowrap text-xs font-bold text-morandi-dark cursor-pointer bg-white px-3 py-2 border border-morandi-dark rounded shadow-sm hover:bg-gray-50"><input type="checkbox" id="drink-eco"> â™»ï¸ ç’°ä¿æ¯</label>
                            </div>
                        </div>
                    </div>
                    <div class="mt-2 text-right">
                        <button onclick="toggleDrinkForm()" class="btn-retro px-4 py-2 bg-gray-200 text-gray-700 font-bold rounded mr-2 hover:bg-gray-300">å–æ¶ˆ</button>
                        <button onclick="addDrink()" class="btn-retro px-6 py-2 bg-morandi-blue text-white border-2 border-morandi-dark font-bold hover:bg-morandi-blue/90 shadow-retro-sm">å„²å­˜</button>
                    </div>
                </div>
            </div>

            <!-- Permanent Stats Section -->
            <div class="bg-white border-2 border-morandi-dark shadow-retro mb-4 md:mb-6">
                <div class="p-4 md:p-6 bg-morandi-bg">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6 text-center mb-6">
                        <div class="p-4 md:p-6 bg-morandi-green text-white border-2 border-morandi-dark shadow-retro-sm transform hover:-translate-y-1 transition-transform"><h4 class="font-bold text-sm mb-2 uppercase tracking-wider opacity-80">ç¸½èŠ±è²» (ä»Šå¹´)</h4><p class="text-3xl md:text-4xl font-display font-bold" id="stat-total-cost">NT$ 0</p><p class="text-xs md:text-sm mt-2 font-bold bg-white/20 inline-block px-3 py-1 rounded-full" id="stat-total-cups">å…± 0 æ¯</p></div>
                        <div class="p-4 md:p-6 bg-morandi-blue text-white border-2 border-morandi-dark shadow-retro-sm transform hover:-translate-y-1 transition-transform"><h4 class="font-bold text-sm mb-2 uppercase tracking-wider opacity-80">æœ€å¸¸å»</h4><p class="text-xl md:text-2xl font-display font-bold mt-2 break-words leading-tight" id="stat-fav-shop">-</p></div>
                        <div class="p-4 md:p-6 bg-morandi-pink text-white border-2 border-morandi-dark shadow-retro-sm transform hover:-translate-y-1 transition-transform"><h4 class="font-bold text-sm mb-2 uppercase tracking-wider opacity-80">æœ€æ„›å–</h4><p class="text-xl md:text-2xl font-display font-bold mt-2 break-words leading-tight" id="stat-fav-drink">-</p></div>
                    </div>
                    <div class="px-2">
                        <h4 class="text-xs font-bold text-morandi-brown mb-4 border-b border-morandi-brown/30 pb-1 inline-block uppercase tracking-widest">æ¶ˆè²»è¶¨å‹¢</h4>
                        <div id="chart-bars" class="h-32 md:h-48 flex items-end justify-around space-x-2 md:space-x-4 px-2 md:px-4 pt-4 border-l-2 border-b-2 border-morandi-dark bg-white/50"><div class="text-xs text-gray-400 w-full text-center flex items-center justify-center h-full">æš«ç„¡è³‡æ–™</div></div>
                    </div>
                </div>
            </div>

             <!-- Permanent Drink Calendar (Moved Below Chart) -->
             <div class="bg-white border-2 border-morandi-dark shadow-retro mb-4 md:mb-6">
                <div class="p-3 md:p-6 bg-morandi-bg">
                    <div class="flex justify-between items-center mb-4">
                        <button onclick="changeDrinkMonth(-1)" class="btn-retro px-3 py-1 bg-white border border-morandi-dark rounded"><i class="fas fa-chevron-left"></i></button>
                        <h3 id="drink-calendar-month-year" class="text-lg md:text-xl font-display font-bold text-morandi-dark">Month Year</h3>
                        <button onclick="changeDrinkMonth(1)" class="btn-retro px-3 py-1 bg-white border border-morandi-dark rounded"><i class="fas fa-chevron-right"></i></button>
                    </div>
                    <div class="grid grid-cols-7 gap-1 text-center font-bold text-morandi-brown text-xs md:text-sm mb-2"><div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div></div>
                    <div id="drink-calendar-grid" class="grid grid-cols-7 gap-1 border-t-2 border-morandi-dark pt-2"></div>
                </div>
            </div>
            
            <div class="bg-white border-2 border-morandi-dark shadow-retro p-0 mt-4 md:mt-6">
                <h3 class="font-bold text-morandi-dark p-3 md:p-4 bg-morandi-paper border-b-2 border-morandi-dark">æœ€è¿‘ç´€éŒ„</h3>
                <div class="overflow-x-auto p-2 md:p-4">
                    <table class="w-full text-sm text-left border-collapse min-w-[500px] md:min-w-0">
                        <thead class="text-morandi-dark"><tr><th class="p-2 md:p-3 border-b-2 border-morandi-dark whitespace-nowrap">æ—¥æœŸ</th><th class="p-2 md:p-3 border-b-2 border-morandi-dark whitespace-nowrap">åº—å®¶/å“é …</th><th class="p-2 md:p-3 border-b-2 border-morandi-dark">å†°ç”œ/å‚™è¨»</th><th class="p-2 md:p-3 border-b-2 border-morandi-dark whitespace-nowrap">é‡‘é¡</th><th class="p-2 md:p-3 border-b-2 border-morandi-dark w-10"></th></tr></thead>
                        <tbody id="drink-list-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Tab 3: Purchasing -->
        <div id="tab-purchasing" class="section-content hidden fade-in space-y-4 md:space-y-8 pb-10">
            <header class="flex flex-col md:flex-row justify-between items-start md:items-end border-b-4 border-morandi-dark pb-2 mb-4 gap-2">
                <div>
                    <h2 class="text-2xl md:text-4xl font-display font-bold text-morandi-dark">ä»£è³¼ç®¡ç†</h2>
                    <p class="text-xs md:text-sm font-bold text-morandi-brown mt-1 uppercase tracking-widest">Purchasing</p>
                </div>
                <div class="flex flex-wrap gap-2 justify-end w-full md:w-auto">
                    <button onclick="toggleOrderForm()" class="btn-retro px-2 md:px-3 py-1 text-[10px] md:text-xs bg-morandi-dark text-white font-bold shadow-retro-sm hover:bg-gray-700"><i class="fas fa-plus mr-1"></i> æ–°å¢</button>
                    <button onclick="exportOrders()" class="btn-retro px-2 md:px-3 py-1 text-[10px] md:text-xs bg-white border-2 border-morandi-dark text-morandi-dark font-bold shadow-retro-sm hover:bg-gray-50"><i class="fas fa-file-export"></i> <span class="hidden md:inline">åŒ¯å‡º</span></button>
                    <label class="btn-retro px-2 md:px-3 py-1 text-[10px] md:text-xs bg-morandi-brown border-2 border-morandi-dark text-white font-bold shadow-retro-sm hover:bg-morandi-brown/80 cursor-pointer flex items-center"><i class="fas fa-file-import mr-1"></i> <span class="hidden md:inline">åŒ¯å…¥</span><input type="file" class="hidden" onchange="importOrders(this)"></label>
                </div>
            </header>
            
            <!-- Hidden Order Form -->
            <div id="order-form-panel" class="bg-white border-2 border-morandi-dark shadow-retro mb-4 md:mb-6 overflow-hidden">
                <div class="p-4 md:p-6 bg-morandi-bg">
                    <h4 class="font-bold text-lg text-morandi-dark mb-4 border-b border-morandi-brown/30 pb-2">æ–°å¢è¨‚å–®</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3 md:gap-4 mb-4">
                            <div class="flex flex-col"><label class="text-xs font-bold text-morandi-dark mb-1">æ—¥æœŸ</label><input type="date" id="order-date" class="p-2 w-full text-sm"></div>
                            <div class="flex flex-col"><label class="text-xs font-bold text-morandi-dark mb-1">ä»£è™Ÿ</label><input type="text" id="order-code" class="p-2 w-full text-sm"></div>
                            <div class="flex flex-col"><label class="text-xs font-bold text-morandi-dark mb-1">åº—å®¶</label><input type="text" id="order-shop" class="p-2 w-full text-sm"></div>
                            <div class="flex flex-col"><label class="text-xs font-bold text-morandi-dark mb-1">å•†å“åç¨±</label><input type="text" id="order-name" class="p-2 w-full text-sm"></div>
                            <div class="flex flex-col"><label class="text-xs font-bold text-morandi-dark mb-1">è¦æ ¼</label><input type="text" id="order-spec" class="p-2 w-full text-sm"></div>
                            <div class="flex flex-col"><label class="text-xs font-bold text-morandi-dark mb-1">æ•¸é‡</label><input type="number" id="order-qty" value="1" oninput="calcProfit()" class="p-2 w-full text-sm"></div>
                            <div class="flex flex-col md:col-span-2"><label class="text-xs font-bold text-morandi-dark mb-1">ç‹€æ…‹</label><select id="order-status" class="p-2 w-full text-sm font-bold bg-white text-morandi-dark"></select></div>
                            <div class="flex flex-col bg-yellow-50 p-2 border border-morandi-brown/30 rounded"><label class="text-xs font-bold text-morandi-dark mb-1">éŸ“å¹£æˆæœ¬</label><input type="number" id="order-krw-cost" oninput="calcProfit()" class="p-2 w-full text-sm"></div>
                            <div class="flex flex-col bg-yellow-50 p-2 border border-morandi-brown/30 rounded"><label class="text-xs font-bold text-morandi-dark mb-1">åŒ¯ç‡</label><input type="number" id="order-rate" placeholder="38" value="38" oninput="calcProfit()" class="p-2 w-full text-sm"></div>
                            <div class="flex flex-col bg-red-50 p-2 border border-red-200 rounded"><label class="text-xs font-bold text-red-800 mb-1">å°å¹£æˆæœ¬</label><input type="text" id="order-twd-cost" readonly class="p-2 w-full text-sm bg-gray-100"></div>
                            <div class="flex flex-col bg-blue-50 p-2 border border-blue-200 rounded"><label class="text-xs font-bold text-blue-800 mb-1">ç¸½å”®åƒ¹</label><input type="number" id="order-sell-price" oninput="calcProfit()" class="p-2 w-full text-sm"></div>
                            <div class="flex flex-col md:col-span-2"><label class="text-xs font-bold text-morandi-dark mb-1">å‚™è¨»</label><input type="text" id="order-note" class="p-2 w-full text-sm"></div>
                            <div class="flex items-center gap-2 pt-2"><input type="checkbox" id="order-paid"><label for="order-paid" class="text-sm font-bold">å•†å“å·²æ”¶</label></div>
                            <div class="flex items-center gap-2 pt-2"><input type="checkbox" id="order-shipping"><label for="order-shipping" class="text-sm font-bold">é‹è²»å·²åŒ¯</label></div>
                            <div class="flex flex-col md:col-span-4 bg-morandi-green p-3 border-2 border-morandi-dark mt-2"><div class="flex justify-between items-center"><label class="text-sm font-bold text-white mb-1">é ä¼°åˆ©æ½¤</label><input type="text" id="order-profit" readonly class="p-2 w-1/2 text-xl font-display font-bold text-right"></div></div>
                    </div>
                    <div class="mt-2 text-right">
                        <button onclick="toggleOrderForm()" class="btn-retro px-4 py-2 bg-gray-200 text-gray-700 font-bold rounded mr-2 hover:bg-gray-300">å–æ¶ˆ</button>
                        <button onclick="addOrder()" class="btn-retro px-6 py-2 bg-morandi-dark text-white border-2 border-morandi-dark font-bold hover:bg-gray-800 shadow-retro-sm">å„²å­˜</button>
                    </div>
                </div>
            </div>

            <!-- Stats -->
            <div class="bg-white border-2 border-morandi-dark shadow-retro mt-4 md:mt-6">
                <button onclick="toggleCollapse('purchasing-stats-content', 'icon-purchasing-stats')" class="w-full flex justify-between items-center p-3 md:p-5 bg-morandi-blue text-white hover:opacity-90 transition text-left group border-b-2 border-morandi-dark">
                    <span class="font-bold text-base md:text-lg group-hover:translate-x-1 transition-transform"><i class="fas fa-chart-line mr-2"></i> ç‡Ÿé‹å„€è¡¨æ¿</span>
                    <i id="icon-purchasing-stats" class="fas fa-chevron-down transition-transform border-2 border-white rounded-full p-1 w-6 h-6 md:w-8 md:h-8 flex items-center justify-center text-xs md:text-base"></i>
                </button>
                <div id="purchasing-stats-content" class="collapse-content bg-white">
                    <div class="p-4 md:p-6 bg-morandi-bg">
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-3 md:gap-4 mb-6">
                            <div class="p-3 bg-white border-2 border-morandi-dark shadow-retro-sm"><div class="text-[10px] font-bold text-morandi-brown uppercase">æ·¨åˆ©æ½¤</div><div class="text-lg md:text-2xl font-display font-bold text-morandi-green mt-1" id="stats-net-profit">NT$ 0</div></div>
                            <div class="p-3 bg-white border-2 border-morandi-dark shadow-retro-sm"><div class="text-[10px] font-bold text-morandi-brown uppercase">ç¸½ç‡Ÿæ”¶</div><div class="text-lg md:text-2xl font-display font-bold text-morandi-dark mt-1" id="stats-revenue">NT$ 0</div></div>
                            <div class="p-3 bg-white border-2 border-morandi-dark shadow-retro-sm"><div class="text-[10px] font-bold text-morandi-brown uppercase">ç¸½æˆæœ¬</div><div class="text-lg md:text-2xl font-display font-bold text-red-400 mt-1" id="stats-cost">NT$ 0</div></div>
                            <!-- Second Row -->
                            <div class="p-2 bg-morandi-paper border border-morandi-brown/30 rounded text-center"><div class="text-xs text-morandi-brown font-bold">åˆ©æ½¤ç‡</div><div class="text-base font-bold text-morandi-dark" id="stats-margin">0%</div></div>
                            <div class="p-2 bg-morandi-paper border border-morandi-brown/30 rounded text-center"><div class="text-xs text-morandi-brown font-bold">è¨‚å–®æ•¸</div><div class="text-base font-bold text-morandi-dark" id="stats-total-orders">0</div></div>
                            <div class="p-2 bg-morandi-paper border border-morandi-brown/30 rounded text-center"><div class="text-xs text-morandi-brown font-bold">æœªæ”¶æ¬¾</div><div class="text-base font-bold text-red-500" id="stats-unpaid">NT$ 0</div></div>
                        </div>
                        <h4 class="text-sm font-bold text-morandi-dark mb-4 border-b-2 border-dashed border-morandi-dark pb-2">ç‹€æ…‹åˆ†å¸ƒ</h4>
                        <div id="stats-status-dist" class="space-y-3"></div>
                    </div>
                </div>
            </div>

            <!-- List -->
            <div class="bg-white border-2 border-morandi-dark shadow-retro mt-4 md:mt-6">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center p-3 md:p-5 bg-morandi-paper border-b-2 border-morandi-dark gap-3">
                    <h3 class="font-bold text-base md:text-lg text-morandi-dark uppercase tracking-wider"><i class="fas fa-list-alt mr-2"></i> è¨‚å–®å¸³æœ¬</h3>
                    <div class="flex flex-col md:flex-row gap-2 w-full md:w-auto">
                        <div class="flex items-center gap-2">
                            <select id="order-sort-select" onchange="updateOrderDisplaySettings()" class="p-1 text-xs border border-morandi-dark rounded bg-white font-bold cursor-pointer"><option value="desc">æ–° â†’ èˆŠ</option><option value="asc">èˆŠ â†’ æ–°</option></select>
                            <label class="flex items-center cursor-pointer bg-white px-2 py-1 border border-morandi-dark rounded shadow-sm hover:bg-gray-50 select-none"><input type="checkbox" id="order-filter-unfinished" onchange="updateOrderDisplaySettings()" class="mr-2"><span class="text-xs font-bold text-morandi-dark">åƒ…æœªå®Œæˆ</span></label>
                        </div>
                    </div>
                </div>
                <div class="p-3 md:p-6 bg-morandi-bg">
                    <div class="overflow-x-auto border-2 border-morandi-dark shadow-retro-sm bg-white">
                        <table class="w-full text-sm text-left border-collapse min-w-[700px] md:min-w-0">
                            <thead class="bg-morandi-paper text-morandi-dark font-bold border-b-2 border-morandi-dark">
                                <tr>
                                    <th class="p-2 md:p-3 border-r border-morandi-dark/20 whitespace-nowrap">æ—¥æœŸ/ä»£è™Ÿ</th>
                                    <th class="p-2 md:p-3 border-r border-morandi-dark/20 whitespace-nowrap">å•†å“è©³æƒ…</th>
                                    <th class="p-2 md:p-3 border-r border-morandi-dark/20 whitespace-nowrap">ç‹€æ…‹</th>
                                    <th class="p-2 md:p-3 border-r border-morandi-dark/20 whitespace-nowrap">è²¡å‹™</th>
                                    <th class="p-2 md:p-3 border-r border-morandi-dark/20 whitespace-nowrap">åˆ©æ½¤</th>
                                    <th class="p-2 md:p-3 w-10 text-center">åˆª</th>
                                </tr>
                            </thead>
                            <tbody id="order-list-body" class="divide-y divide-morandi-dark/10"></tbody>
                        </table>
                    </div>
                    <div class="mt-4 flex justify-end gap-4 text-xs font-bold text-morandi-dark"><div class="bg-white px-3 py-1 border border-morandi-dark rounded shadow-retro-sm">é¡¯ç¤ºï¼š<span id="order-count-display">0</span></div></div>
                </div>
            </div>
        </div>

        <!-- Tab 4: Subscriptions -->
        <div id="tab-subs" class="section-content hidden fade-in space-y-4 md:space-y-8 pb-10">
            <header class="flex justify-between items-end border-b-4 border-morandi-dark pb-2 mb-4">
                <div><h2 class="text-2xl md:text-4xl font-display font-bold text-morandi-dark">è¨‚é–±ç®¡ç†</h2><p class="text-xs md:text-sm font-bold text-morandi-brown mt-1 uppercase tracking-widest">Subscriptions</p></div>
                <div class="flex gap-2">
                    <button onclick="toggleSubForm()" class="btn-retro px-2 md:px-3 py-1 text-[10px] md:text-xs bg-morandi-dark text-white font-bold shadow-retro-sm hover:bg-gray-700"><i class="fas fa-plus mr-1"></i> æ–°å¢</button>
                    <button onclick="exportSubs()" class="btn-retro px-2 md:px-3 py-1 text-[10px] md:text-xs bg-white border-2 border-morandi-dark text-morandi-dark font-bold shadow-retro-sm hover:bg-gray-50"><i class="fas fa-file-export"></i> <span class="hidden md:inline">åŒ¯å‡º</span></button>
                    <label class="btn-retro px-2 md:px-3 py-1 text-[10px] md:text-xs bg-morandi-brown border-2 border-morandi-dark text-white font-bold shadow-retro-sm hover:bg-morandi-brown/80 cursor-pointer flex items-center"><i class="fas fa-file-import mr-1"></i> <span class="hidden md:inline">åŒ¯å…¥</span><input type="file" class="hidden" onchange="importSubs(this)"></label>
                </div>
            </header>
            
            <div id="sub-form-panel" class="bg-white border-2 border-morandi-dark shadow-retro mb-4 md:mb-6 overflow-hidden">
                <div class="p-4 md:p-6 bg-morandi-bg">
                    <h4 class="font-bold text-lg text-morandi-dark mb-4 border-b border-morandi-brown/30 pb-2">æ–°å¢è¨‚é–±æœå‹™</h4>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-3 md:gap-4 mb-4">
                            <div class="flex flex-col md:col-span-2"><label class="text-xs font-bold text-morandi-dark mb-1">åç¨±</label><input type="text" id="sub-name" class="p-2 w-full text-sm"></div><div class="flex flex-col"><label class="text-xs font-bold text-morandi-dark mb-1">é‡‘é¡</label><input type="number" id="sub-price" class="p-2 w-full text-sm"></div><div class="flex flex-col"><label class="text-xs font-bold text-morandi-dark mb-1">åˆ†æ“”äºº</label><input type="text" id="sub-person" class="p-2 w-full text-sm"></div><div class="flex flex-col"><label class="text-xs font-bold text-morandi-dark mb-1">é€±æœŸ</label><select id="sub-cycle" class="p-2 w-full text-sm bg-white font-bold"><option value="monthly">æ¯æœˆ</option><option value="yearly">æ¯å¹´</option></select></div><div class="flex flex-col"><label class="text-xs font-bold text-morandi-dark mb-1">æ‰£æ¬¾æ—¥</label><input type="date" id="sub-date" class="p-2 w-full text-sm"></div>
                    </div>
                    <div class="mt-2 text-right">
                        <button onclick="toggleSubForm()" class="btn-retro px-4 py-2 bg-gray-200 text-gray-700 font-bold rounded mr-2 hover:bg-gray-300">å–æ¶ˆ</button>
                        <button onclick="addSub()" class="btn-retro px-6 py-2 bg-morandi-green text-white border-2 border-morandi-dark font-bold hover:opacity-90 shadow-retro-sm">å„²å­˜</button>
                    </div>
                </div>
            </div>
            
            <div class="bg-white border-2 border-morandi-dark shadow-retro mt-4 md:mt-6">
                <div class="flex p-2 bg-morandi-paper border-b-2 border-morandi-dark gap-2">
                    <button onclick="renderSubs('service')" class="flex-1 py-2 font-bold text-sm md:text-base text-morandi-dark border-2 border-transparent hover:border-morandi-dark rounded bg-white transition shadow-sm">ä¾æœå‹™</button>
                    <button onclick="renderSubs('person')" class="flex-1 py-2 font-bold text-sm md:text-base text-morandi-dark border-2 border-transparent hover:border-morandi-dark rounded bg-white transition shadow-sm">ä¾äººå“¡</button>
                </div>
                <div id="sub-list-container" class="p-4 md:p-6 bg-morandi-bg"></div>
            </div>
        </div>

        <!-- Tab 5: Ledger -->
        <div id="tab-debt" class="section-content hidden fade-in space-y-4 md:space-y-8 pb-10">
            <header class="flex justify-between items-end border-b-4 border-morandi-dark pb-2 mb-4">
                <div>
                    <h2 class="text-xl md:text-4xl font-display font-bold text-morandi-dark">å…¨çƒç™¾å¤§ä¼æ¥­æŠ•è³‡æ”¶ç›Šç®¡ç†</h2>
                    <p class="text-[10px] md:text-sm font-bold text-morandi-brown mt-1 uppercase tracking-widest">Investment</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="exportTracker()" class="btn-retro px-2 md:px-3 py-1 text-[10px] md:text-xs bg-white border-2 border-morandi-dark text-morandi-dark font-bold shadow-retro-sm hover:bg-gray-50"><i class="fas fa-file-export"></i> <span class="hidden md:inline">åŒ¯å‡º</span></button>
                    <label class="btn-retro px-2 md:px-3 py-1 text-[10px] md:text-xs bg-morandi-brown border-2 border-morandi-dark text-white font-bold shadow-retro-sm hover:bg-morandi-brown/80 cursor-pointer flex items-center"><i class="fas fa-file-import mr-1"></i> <span class="hidden md:inline">åŒ¯å…¥</span><input type="file" class="hidden" onchange="importTracker(this)"></label>
                </div>
            </header>

            <div class="bg-white border-2 border-morandi-dark shadow-retro">
                <div class="p-3 md:p-5 bg-morandi-paper border-b-2 border-morandi-dark"><h3 class="font-bold text-base md:text-lg text-morandi-dark"><i class="fas fa-pen-nib mr-2"></i> æ–°å¢å¸³å‹™ç´€éŒ„</h3></div>
                <div class="p-4 md:p-6 bg-morandi-bg">
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-3 p-3 md:p-4 border border-morandi-brown/30 bg-white/50 rounded">
                        <div class="md:col-span-2 flex gap-2">
                            <select id="ledger-category" class="w-1/2 p-2 text-sm font-bold bg-white" onchange="updateLedgerTypeOptions()"><option value="general">ä¸€èˆ¬å¸³å‹™</option><option value="camera">ç›¸æ©Ÿå¤¢</option></select>
                            <select id="ledger-type" class="w-1/2 p-2 text-sm font-bold bg-white"></select>
                        </div>
                        <input type="date" id="ledger-date" class="p-2 text-sm border-morandi-dark">
                        <input type="text" id="ledger-desc" placeholder="é …ç›®" class="p-2 text-sm">
                        <input type="number" id="ledger-amount" placeholder="é‡‘é¡" class="p-2 text-sm">
                        <button onclick="addLedgerEntry()" class="btn-retro bg-morandi-dark text-white font-bold py-2 md:col-span-5 border-2 border-morandi-dark hover:opacity-90 mt-2">æ–°å¢</button>
                    </div>
                </div>
            </div>

            <div class="bg-white border-2 border-morandi-dark shadow-retro mt-4 md:mt-6">
                <button onclick="toggleCollapse('debt-list-content', 'icon-debt-list')" class="w-full flex justify-between items-center p-4 md:p-5 bg-morandi-paper hover:bg-morandi-brown/20 transition text-left group">
                    <span class="font-bold text-base md:text-lg text-morandi-dark group-hover:translate-x-1 transition-transform"><i class="fas fa-hand-holding-usd mr-2"></i> ä¸€èˆ¬å¸³å‹™æ˜ç´° <span id="debt-header-balance" class="text-xs ml-2 font-normal text-morandi-brown"></span></span>
                    <i id="icon-debt-list" class="fas fa-chevron-down transition-transform border-2 border-morandi-dark rounded-full p-1 w-6 h-6 md:w-8 md:h-8 flex items-center justify-center bg-white text-xs md:text-base"></i>
                </button>
                <div id="debt-list-content" class="collapse-content bg-white"><div class="p-4 md:p-6 bg-morandi-bg"><ul id="debt-list" class="space-y-2"></ul></div></div>
            </div>

            <div class="bg-white border-2 border-morandi-dark shadow-retro mt-4 md:mt-6">
                <button onclick="toggleCollapse('camera-fund-content', 'icon-camera-fund')" class="w-full flex justify-between items-center p-4 md:p-5 bg-morandi-paper hover:bg-morandi-brown/20 transition text-left group">
                    <span class="font-bold text-base md:text-lg text-morandi-dark group-hover:translate-x-1 transition-transform"><i class="fas fa-camera-retro mr-2"></i> ç²¿ç²¿å‹æ–¯ã®ç›¸æ©Ÿå¤¢ <span id="camera-header-balance" class="text-xs ml-2 font-normal text-morandi-green"></span></span>
                    <i id="icon-camera-fund" class="fas fa-chevron-down transition-transform border-2 border-morandi-dark rounded-full p-1 w-6 h-6 md:w-8 md:h-8 flex items-center justify-center bg-white text-xs md:text-base"></i>
                </button>
                <div id="camera-fund-content" class="collapse-content bg-white"><div class="p-4 md:p-6 bg-morandi-bg"><div class="flex justify-between items-center mb-2"><div class="text-xs font-bold text-morandi-brown bg-white px-2 py-1 border border-morandi-brown rounded">Target: NT$ <span id="camera-target-display">50000</span></div></div><div class="mb-6"><div class="flex justify-between text-xs font-bold mb-1"><span>å­˜é¡: NT$ <span id="camera-current">0</span></span><span id="camera-percent">0%</span></div><div class="w-full bg-gray-200 rounded-full h-4 border border-morandi-dark overflow-hidden"><div id="camera-bar" class="bg-morandi-green h-full transition-all duration-500" style="width: 0%"></div></div></div><ul id="fund-list" class="max-h-60 overflow-y-auto custom-scroll space-y-1 text-sm bg-white p-4 border border-morandi-brown/20 rounded"></ul></div></div>
            </div>
        </div>

        <!-- Tab 6: Tools -->
        <div id="tab-tools" class="section-content hidden fade-in space-y-4 md:space-y-8 pb-10">
            <header class="border-b-4 border-morandi-dark pb-2 mb-4"><h2 class="text-2xl md:text-4xl font-display font-bold text-morandi-dark">å°å·¥å…·</h2><p class="text-xs md:text-sm font-bold text-morandi-brown mt-1 uppercase tracking-widest">Utilities</p></header>
            <div class="bg-white border-2 border-morandi-dark shadow-retro"><button onclick="toggleCollapse('qr-content', 'icon-qr-collapse')" class="w-full flex justify-between items-center p-4 md:p-5 bg-morandi-paper hover:bg-morandi-brown/20 transition text-left group"><span class="font-bold text-base md:text-lg text-morandi-dark"><i class="fas fa-qrcode mr-2"></i> QR Code è£½ä½œ</span><i id="icon-qr-collapse" class="fas fa-chevron-down transition-transform border-2 border-morandi-dark rounded-full p-1 w-6 h-6 md:w-8 md:h-8 flex items-center justify-center bg-white text-xs md:text-base"></i></button><div id="qr-content" class="collapse-content bg-white"><div class="p-6 bg-morandi-bg flex flex-col items-center"><input type="text" id="qr-input" placeholder="è¼¸å…¥ç¶²å€æˆ–æ–‡å­—..." class="w-full p-3 mb-4"><button onclick="generateQR()" class="btn-retro w-full bg-morandi-green text-white py-3 font-bold border-2 border-morandi-dark shadow-retro-sm mb-8">ç”Ÿæˆåœ–ç¢¼</button><div class="p-4 bg-white border-2 border-morandi-dark shadow-retro-sm"><div id="qrcode"></div></div></div></div></div>
            <div class="bg-white border-2 border-morandi-dark shadow-retro mt-4 md:mt-6"><button onclick="toggleCollapse('url-content', 'icon-url-collapse')" class="w-full flex justify-between items-center p-4 md:p-5 bg-morandi-paper hover:bg-morandi-brown/20 transition text-left group"><span class="font-bold text-base md:text-lg text-morandi-dark"><i class="fas fa-link mr-2"></i> ç¸®ç¶²å€</span><i id="icon-url-collapse" class="fas fa-chevron-down transition-transform border-2 border-morandi-dark rounded-full p-1 w-6 h-6 md:w-8 md:h-8 flex items-center justify-center bg-white text-xs md:text-base"></i></button><div id="url-content" class="collapse-content bg-white"><div class="p-6 bg-morandi-bg"><p class="text-xs font-bold text-morandi-brown mb-4 bg-morandi-paper p-2 border border-morandi-brown">* ä»‹é¢æ¼”ç¤ºæ¨¡å¼ (Demo Mode)</p><input type="text" id="url-input" placeholder="è¼¸å…¥é•·ç¶²å€..." class="w-full p-3 mb-4"><button onclick="shortenUrl()" class="btn-retro w-full bg-morandi-blue text-white py-3 font-bold border-2 border-morandi-dark shadow-retro-sm mb-6">ç¸®çŸ­é€£çµ</button><div class="relative"><input type="text" id="short-url-output" readonly placeholder="çµæœå°‡é¡¯ç¤ºæ–¼æ­¤" class="w-full p-3 bg-gray-100 text-gray-500 font-mono text-sm"><button onclick="copyUrl()" class="btn-retro absolute right-0 top-0 h-full px-4 bg-morandi-dark text-white border-l-2 border-morandi-dark"><i class="fas fa-copy"></i></button></div></div></div></div>
        </div>

    </main>

    <!-- Notification Toast -->
    <div id="toast" class="fixed bottom-6 right-6 bg-morandi-dark text-white px-6 py-4 border-2 border-white shadow-retro font-bold transform translate-y-32 opacity-0 transition-all duration-300 z-50">Notification</div>

    <script>
        // --- State Management ---
        let appData = { tasks: [], drinks: [], orders: [], subs: [], debts: [], cameraFund: { target: 50000, entries: [] } };
        let currentCalendarDate = new Date();
        let currentDrinkCalendarDate = new Date(); // Separate state for drink calendar
        let orderSort = 'desc'; 
        let orderFilterUnfinished = false;
        const ORDER_STATUSES = ["ç¢ºèªä¸­", "å·²åŒ¯æ¬¾", "å°å¸³å®Œæˆ", "éŸ“åœ‹ç«¯ä¸‹å–®", "éŸ“åœ‹ç«¯å‡ºè²¨", "å¾…é›†é‹å›å°", "å·²æŠµå°", "æŠµå°æ•´ç†ä¸­", "å¾…é¢äº¤", "å·²å¯„å‡º", "è¨‚å–®å®Œæˆ"];

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            updateDate();
            renderTasks();
            renderCalendar();
            
            renderDrinks();
            renderDrinkCalendar(); // Init drink calendar
            
            renderOrders(); // Should be available if tab-purchasing existed
            
            updateStats(); // Drink stats
            
            renderSubs('service');
            renderDebts();
            renderCameraFund();
            
            updateLedgerTypeOptions(); // Init ledger type
            
            toggleCollapse('matrix-content', 'icon-matrix-view'); // Auto open matrix
            
            document.getElementById('drink-date').valueAsDate = new Date();
            document.getElementById('order-date').valueAsDate = new Date();
            document.getElementById('task-date').valueAsDate = new Date();
            document.getElementById('ledger-date').valueAsDate = new Date(); 
            document.getElementById('sub-date').valueAsDate = new Date();
        });

        function loadData() {
            const saved = localStorage.getItem('retroDashboardData');
            if (saved) {
                const parsed = JSON.parse(saved);
                appData = { ...appData, ...parsed };
                // Ensure arrays exist
                ['tasks','drinks','orders','subs','debts'].forEach(k => { if(!appData[k]) appData[k] = []; });
                if(!appData.cameraFund) appData.cameraFund = { target: 50000, entries: [] };
            }
        }
        function saveData() { localStorage.setItem('retroDashboardData', JSON.stringify(appData)); }
        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.remove('translate-y-32', 'opacity-0');
            setTimeout(() => { toast.classList.add('translate-y-32', 'opacity-0'); }, 3000);
        }
        function updateDate() {
            const now = new Date();
            const dateStr = `${now.getFullYear()}.${String(now.getMonth()+1).padStart(2,'0')}.${String(now.getDate()).padStart(2,'0')}`;
            const dayStr = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'][now.getDay()];
            document.getElementById('current-date').innerHTML = `<span class="mr-2">${dateStr}</span><span class="text-xs bg-morandi-brown text-white px-1 rounded">${dayStr}</span>`;
        }
        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
                if(btn.id === `btn-${tabName}`) btn.classList.add('active');
            });
            document.querySelectorAll('.section-content').forEach(section => {
                section.classList.add('hidden');
                if(section.id === `tab-${tabName}`) section.classList.remove('hidden');
            });
            // Re-render calendars if switching to tabs to ensure layout
            if(tabName === 'planner') renderCalendar();
            if(tabName === 'drinks') renderDrinkCalendar();
        }
        function toggleCollapse(contentId, iconId) {
            const content = document.getElementById(contentId);
            const icon = document.getElementById(iconId);
            if (content.classList.contains('open')) {
                content.classList.remove('open');
                icon.style.transform = 'rotate(0deg)';
            } else {
                content.classList.add('open');
                icon.style.transform = 'rotate(180deg)';
            }
        }
        function toggleTimeInput() { document.getElementById('task-time').disabled = document.getElementById('task-allday').checked; }

        // --- Planner Functions ---
        function addTask() {
             const date = document.getElementById('task-date').value; const title = document.getElementById('task-title').value;
             if (!title.trim() || !date) return showToast("è«‹è‡³å°‘è¼¸å…¥æ—¥æœŸèˆ‡æ¨™é¡Œ");
             const newTask = {
                id: Date.now(), date, time: document.getElementById('task-time').value, isAllDay: document.getElementById('task-allday').checked,
                quadrant: document.getElementById('task-priority').value, title, text: title, content: document.getElementById('task-content').value,
                location: document.getElementById('task-location').value, url: document.getElementById('task-url').value, completed: false
             };
             appData.tasks.push(newTask); saveData(); renderTasks(); renderCalendar();
             
             document.getElementById('task-title').value = '';
             document.getElementById('task-content').value = '';
             document.getElementById('task-location').value = '';
             document.getElementById('task-url').value = '';
             showToast("æ—¥ç¨‹å·²æ–°å¢");
        }
        function renderTasks() {
            ['q1', 'q2', 'q3', 'q4'].forEach(q => document.getElementById(`list-${q}`).innerHTML = '');
            appData.tasks.forEach(task => {
                const displayTitle = task.title || task.text || "æœªå‘½åä»»å‹™";
                const d = new Date(task.date); const m = String(d.getMonth()+1).padStart(2,'0'); const day = String(d.getDate()).padStart(2,'0'); const wd = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][d.getDay()];
                const displayDate = task.date ? `<span class="text-[10px] text-morandi-brown block mb-1 font-bold"><i class="fas fa-calendar-alt mr-1"></i>${m}/${day} (${wd}) ${task.time || (task.isAllDay ? 'å…¨æ—¥' : '')}</span>` : '';
                const li = document.createElement('li');
                li.className = "flex justify-between items-start group border-b border-dashed border-gray-300 pb-2 last:border-0";
                li.innerHTML = `<div class="flex items-start gap-3 w-full"><label class="flex items-center cursor-pointer mt-1"><input type="checkbox" ${task.completed ? 'checked' : ''} onchange="toggleTask(${task.id})"></label><div class="w-full">${displayDate}<span class="text-sm font-serif leading-relaxed ${task.completed ? 'line-through text-gray-400' : 'text-morandi-dark font-medium'} w-full break-words pr-2 block">${displayTitle}</span>${task.content ? `<div class="text-xs text-gray-500 mt-1 truncate">${task.content}</div>` : ''}${task.url ? `<a href="${task.url}" target="_blank" class="text-xs text-morandi-blue hover:underline"><i class="fas fa-link"></i> é€£çµ</a>` : ''}</div></div><button onclick="deleteTask(${task.id})" class="text-morandi-brown hover:text-red-500 opacity-0 group-hover:opacity-100 transition px-1"><i class="fas fa-times"></i></button>`;
                const targetList = task.quadrant ? document.getElementById(`list-${task.quadrant}`) : document.getElementById('list-q1');
                if(targetList) targetList.appendChild(li);
            });
        }
        function toggleTask(id) { const task = appData.tasks.find(t => t.id === id); if (task) { task.completed = !task.completed; saveData(); renderTasks(); } }
        function deleteTask(id) { if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) { appData.tasks = appData.tasks.filter(t => t.id !== id); saveData(); renderTasks(); renderCalendar(); } }

        function renderCalendar() {
             const year = currentCalendarDate.getFullYear(); const month = currentCalendarDate.getMonth();
             document.getElementById('calendar-month-year').textContent = new Date(year, month).toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
             const firstDay = new Date(year, month, 1).getDay(); const daysInMonth = new Date(year, month + 1, 0).getDate();
             const grid = document.getElementById('calendar-grid'); grid.innerHTML = '';
             for(let i=0; i<firstDay; i++) grid.appendChild(document.createElement('div'));
             for(let day=1; day<=daysInMonth; day++) {
                 const dayDiv = document.createElement('div'); dayDiv.className = "calendar-day bg-white border border-morandi-brown/20 p-1 flex flex-col items-center cursor-pointer relative";
                 const checkDate = `${year}-${String(month+1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                 if(day === new Date().getDate() && month === new Date().getMonth() && year === new Date().getFullYear()) dayDiv.classList.add('today');
                 dayDiv.innerHTML = `<span class="text-xs font-bold text-morandi-dark mb-1">${day}</span>`;
                 const dayTasks = appData.tasks.filter(t => t.date === checkDate);
                 const dotContainer = document.createElement('div'); dotContainer.className = "flex gap-1 flex-wrap justify-center";
                 dayTasks.forEach(t => { const dot = document.createElement('div'); let color = 'bg-gray-400'; if(t.quadrant === 'q1') color = 'bg-morandi-pink'; else if(t.quadrant === 'q2') color = 'bg-morandi-blue'; else if(t.quadrant === 'q3') color = 'bg-yellow-400'; dot.className = `w-2 h-2 rounded-full ${color}`; dotContainer.appendChild(dot); });
                 dayDiv.appendChild(dotContainer);
                 dayDiv.onclick = () => { 
                    document.getElementById('task-date').value = checkDate; 
                    if(!document.getElementById('add-task-content').classList.contains('open')) toggleCollapse('add-task-content', 'icon-add-task');
                    document.getElementById('add-task-container').scrollIntoView({behavior:'smooth'}); 
                 };
                 grid.appendChild(dayDiv);
             }
        }
        function changeMonth(delta) { currentCalendarDate.setMonth(currentCalendarDate.getMonth() + delta); renderCalendar(); }

        // --- DRINKS LOGIC ---
        function toggleDrinkForm() {
            const panel = document.getElementById('drink-form-panel');
            if(panel.classList.contains('open')) {
                panel.classList.remove('open');
            } else {
                panel.classList.add('open');
            }
        }

        function addDrink() {
            const date = document.getElementById('drink-date').value;
            let price = Math.round(parseFloat(document.getElementById('drink-price').value));
            const shop = document.getElementById('drink-shop').value;
            const name = document.getElementById('drink-name').value;
            
            // New Fields
            const ice = document.getElementById('drink-ice').value;
            const sugar = document.getElementById('drink-sugar').value;
            const isTreat = document.getElementById('drink-treat').checked;
            const isEco = document.getElementById('drink-eco').checked;

            if (!date || isNaN(price) || !shop || !name) {
                return showToast("è«‹å¡«å¯«å®Œæ•´é£²æ–™è³‡è¨Š");
            }
            
            appData.drinks.unshift({ 
                id: Date.now(), date, price, shop, name,
                ice, sugar, isTreat, isEco
            });
            saveData();
            renderDrinks();
            renderDrinkCalendar(); // Refresh calendar
            updateStats();
            
            // Close form after add
            toggleDrinkForm();
            
            document.getElementById('drink-price').value = '';
            document.getElementById('drink-shop').value = '';
            document.getElementById('drink-name').value = '';
            document.getElementById('drink-treat').checked = false;
            document.getElementById('drink-eco').checked = false;
            showToast("é£²æ–™ç´€éŒ„å·²ä¿å­˜ï¼");
        }

        function deleteDrink(id) {
            if(confirm("ç¢ºå®šåˆªé™¤é€™ç­†ç´€éŒ„ï¼Ÿ")) {
                appData.drinks = appData.drinks.filter(d => d.id !== id);
                saveData();
                renderDrinks();
                renderDrinkCalendar();
                updateStats();
            }
        }

        function renderDrinks() {
            const tbody = document.getElementById('drink-list-body');
            tbody.innerHTML = '';
            
            appData.drinks.slice(0, 20).forEach(d => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-morandi-paper/50 transition border-b border-gray-200 last:border-0";
                
                // Format Price (Strikethrough if treat)
                let priceDisplay = `NT$${Math.round(d.price)}`;
                if(d.isTreat) priceDisplay = `<span class="line-through text-gray-400 text-[10px] mr-1">${priceDisplay}</span><span class="text-morandi-pink font-bold text-xs">ğŸ</span>`;
                
                // Tags
                let tags = [];
                if(d.ice && d.ice !== 'ç„¡') tags.push(d.ice);
                if(d.sugar && d.sugar !== 'ç„¡') tags.push(d.sugar);
                if(d.isEco) tags.push('<i class="fas fa-leaf text-green-500"></i>');
                
                tr.innerHTML = `
                    <td class="p-2 md:p-3 text-morandi-brown text-xs font-bold font-display whitespace-nowrap">${d.date}</td>
                    <td class="p-2 md:p-3 font-bold text-morandi-dark">
                        <div>${d.shop}</div>
                        <div class="text-[10px] text-gray-500">${d.name}</div>
                    </td>
                    <td class="p-2 md:p-3 text-gray-600 text-xs">
                        ${tags.length > 0 ? tags.join(' Â· ') : '-'}
                    </td>
                    <td class="p-2 md:p-3 text-morandi-dark font-display font-bold whitespace-nowrap">${priceDisplay}</td>
                    <td class="p-2 md:p-3 text-center">
                        <button onclick="deleteDrink(${d.id})" class="text-xs text-gray-400 hover:text-red-500"><i class="fas fa-trash-alt"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderDrinkCalendar() {
            const year = currentDrinkCalendarDate.getFullYear();
            const month = currentDrinkCalendarDate.getMonth();
            
            document.getElementById('drink-calendar-month-year').textContent = new Date(year, month).toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
            
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const grid = document.getElementById('drink-calendar-grid');
            grid.innerHTML = '';

            for(let i=0; i<firstDay; i++) grid.appendChild(document.createElement('div'));
            
            for(let day=1; day<=daysInMonth; day++) {
                const dayDiv = document.createElement('div');
                dayDiv.className = "calendar-day bg-white border border-morandi-brown/20 p-1 flex flex-col items-center cursor-pointer relative";
                
                const checkDate = `${year}-${String(month+1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                // Highlight Today
                if(day === new Date().getDate() && month === new Date().getMonth() && year === new Date().getFullYear()) {
                    dayDiv.classList.add('today');
                }

                dayDiv.innerHTML = `<span class="text-xs font-bold text-morandi-dark mb-1">${day}</span>`;
                
                // Find drinks for this day
                const dayDrinks = appData.drinks.filter(d => d.date === checkDate);
                
                const dotContainer = document.createElement('div');
                dotContainer.className = "flex gap-1 flex-wrap justify-center";
                dayDrinks.forEach(d => {
                    const dot = document.createElement('div');
                    // Special dot for Treat
                    dot.className = d.isTreat 
                        ? `w-2 h-2 rounded-full bg-morandi-pink border border-morandi-dark` 
                        : `w-2 h-2 rounded-full bg-morandi-brown`;
                    dotContainer.appendChild(dot);
                });
                dayDiv.appendChild(dotContainer);
                
                // Click to add drink on that date
                dayDiv.onclick = () => {
                    document.getElementById('drink-date').value = checkDate;
                    if(!document.getElementById('drink-form-panel').classList.contains('open')) {
                        toggleDrinkForm();
                    }
                };

                grid.appendChild(dayDiv);
            }
        }
        
        function changeDrinkMonth(delta) {
            currentDrinkCalendarDate.setMonth(currentDrinkCalendarDate.getMonth() + delta);
            renderDrinkCalendar();
        }

        function updateStats() {
            if (appData.drinks.length === 0) {
                document.getElementById('stat-total-cost').textContent = "NT$ 0";
                document.getElementById('stat-total-cups').textContent = "å…± 0 æ¯";
                document.getElementById('stat-fav-shop').textContent = "-";
                document.getElementById('stat-fav-drink').textContent = "-";
                document.getElementById('chart-bars').innerHTML = '<div class="text-xs text-gray-400 w-full text-center flex items-center justify-center h-full">æš«ç„¡è³‡æ–™</div>';
                return;
            }

            const currentYear = new Date().getFullYear();
            const thisYearDrinks = appData.drinks.filter(d => new Date(d.date).getFullYear() === currentYear);

            // Total Cost (Exclude treats from cost, but include in count)
            const total = Math.round(thisYearDrinks.reduce((sum, d) => sum + (d.isTreat ? 0 : (parseFloat(d.price) || 0)), 0));
            
            document.getElementById('stat-total-cost').textContent = `NT$ ${total}`;
            document.getElementById('stat-total-cups').textContent = `å…± ${thisYearDrinks.length} æ¯`;

            const getMode = (arr) => {
                const counts = {};
                let max = 0, res = "-";
                arr.forEach(a => {
                    counts[a] = (counts[a] || 0) + 1;
                    if(counts[a] > max) { max = counts[a]; res = a; }
                });
                return res;
            }

            document.getElementById('stat-fav-shop').textContent = getMode(thisYearDrinks.map(d => d.shop));
            document.getElementById('stat-fav-drink').textContent = getMode(thisYearDrinks.map(d => d.name));

            // Chart Logic (Last 7 drinks)
            const chartContainer = document.getElementById('chart-bars');
            chartContainer.innerHTML = '';
            const recent = appData.drinks.slice(0, 7).reverse(); // Last 7
            const maxPrice = Math.max(...recent.map(d => d.price), 100);

            recent.forEach(d => {
                const heightPct = (d.price / maxPrice) * 100;
                const bar = document.createElement('div');
                bar.className = "flex-1 flex flex-col justify-end items-center group relative";
                
                let barColor = 'bg-morandi-green';
                let priceLabel = `$${Math.round(d.price)}`;
                
                // Visual update for treats in chart
                if (d.isTreat) {
                    barColor = 'bg-morandi-pink'; // Treat color
                    priceLabel = 'ğŸ';
                }

                bar.innerHTML = `
                    <div class="absolute -top-6 text-[10px] font-bold text-morandi-dark opacity-0 group-hover:opacity-100 transition-opacity bg-white border border-morandi-dark px-1 rounded shadow-retro-sm z-10">${priceLabel}</div>
                    <div class="w-full ${barColor} border-2 border-morandi-dark hover:opacity-80 transition-all" style="height: ${Math.max(heightPct, 5)}%"></div>
                    <div class="text-[10px] text-morandi-dark font-bold mt-2 truncate w-full text-center transform -rotate-45 origin-top-left translate-x-2">${d.shop.substring(0,3)}</div>
                `;
                chartContainer.appendChild(bar);
            });
        }

        // --- PURCHASING / ORDERS LOGIC ---
        function toggleOrderForm() {
             const panel = document.getElementById('order-form-panel');
             if(panel.classList.contains('open')) panel.classList.remove('open');
             else panel.classList.add('open');
        }

        function renderStatusOptions() { if(document.getElementById('order-status')) document.getElementById('order-status').innerHTML = ORDER_STATUSES.map(s => `<option value="${s}">${s}</option>`).join(''); }
        function calcProfit() {
            const krw = parseFloat(document.getElementById('order-krw-cost').value) || 0; const rate = parseFloat(document.getElementById('order-rate').value) || 1; const sell = parseFloat(document.getElementById('order-sell-price').value) || 0;
            let twdCost = 0; if (rate > 0) twdCost = Math.round(krw / rate); const profit = Math.round(sell - twdCost);
            document.getElementById('order-twd-cost').value = twdCost > 0 ? twdCost : ''; document.getElementById('order-profit').value = (sell > 0 && krw > 0) ? `NT$ ${profit}` : '';
            const profitInput = document.getElementById('order-profit'); if(profit < 0) { profitInput.classList.add('text-red-500'); profitInput.classList.remove('text-morandi-dark'); } else { profitInput.classList.remove('text-red-500'); profitInput.classList.add('text-morandi-dark'); }
        }
        function addOrder() {
            const date = document.getElementById('order-date').value; const code = document.getElementById('order-code').value; const shop = document.getElementById('order-shop').value; const name = document.getElementById('order-name').value; const spec = document.getElementById('order-spec').value; const qty = parseInt(document.getElementById('order-qty').value) || 1; const status = document.getElementById('order-status').value;
            const krw = Math.round(parseFloat(document.getElementById('order-krw-cost').value)); const rate = parseFloat(document.getElementById('order-rate').value); const sell = Math.round(parseFloat(document.getElementById('order-sell-price').value));
            const paid = document.getElementById('order-paid').checked; const shipping = document.getElementById('order-shipping').checked; const note = document.getElementById('order-note').value;
            if(!date || !code || !shop || !name || isNaN(krw) || isNaN(sell)) return showToast("è«‹å¡«å¯«å¿…å¡«æ¬„ä½");
            const twdCost = Math.round(krw / rate); const profit = Math.round(sell - twdCost);
            appData.orders.unshift({ id: Date.now(), date, code, shop, name, spec, qty, status, krw, rate, twdCost, sell, profit, paid, shipping, note });
            saveData(); renderOrders(); updatePurchasingStats(); toggleOrderForm();
            document.getElementById('order-code').value = ''; document.getElementById('order-shop').value = ''; document.getElementById('order-name').value = ''; document.getElementById('order-spec').value = ''; document.getElementById('order-qty').value = '1'; document.getElementById('order-krw-cost').value = ''; document.getElementById('order-sell-price').value = ''; document.getElementById('order-twd-cost').value = ''; document.getElementById('order-profit').value = ''; document.getElementById('order-note').value = ''; document.getElementById('order-paid').checked = false; document.getElementById('order-shipping').checked = false;
            showToast("è¨‚å–®å·²å„²å­˜ï¼");
        }
        function deleteOrder(id) { if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) { appData.orders = appData.orders.filter(o => o.id !== id); saveData(); renderOrders(); updatePurchasingStats(); } }
        function updateOrderStatus(id, newStatus) { const order = appData.orders.find(o => o.id === id); if(order) { order.status = newStatus; saveData(); updatePurchasingStats(); showToast(`ç‹€æ…‹æ›´æ–°ï¼š${newStatus}`); } }
        function updateOrderDisplaySettings() { orderSort = document.getElementById('order-sort-select').value; orderFilterUnfinished = document.getElementById('order-filter-unfinished').checked; renderOrders(); }
        function renderOrders() {
            const tbody = document.getElementById('order-list-body'); tbody.innerHTML = ''; let displayOrders = [...appData.orders];
            if (orderFilterUnfinished) displayOrders = displayOrders.filter(o => o.status !== "è¨‚å–®å®Œæˆ");
            displayOrders.sort((a, b) => { const dateA = new Date(a.date); const dateB = new Date(b.date); return orderSort === 'desc' ? dateB - dateA : dateA - dateB; });
            document.getElementById('order-count-display').textContent = displayOrders.length;
            const itemsToShow = displayOrders; 
            if(itemsToShow.length === 0) { const tr = document.createElement('tr'); tr.innerHTML = '<td colspan="6" class="p-8 text-center text-gray-400 text-xs italic">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è¨‚å–®</td>'; tbody.appendChild(tr); return; }
            itemsToShow.forEach(o => {
                const tr = document.createElement('tr'); tr.className = "hover:bg-morandi-paper/50 transition";
                const statusOptions = ORDER_STATUSES.map(s => `<option value="${s}" ${o.status === s ? 'selected' : ''}>${s}</option>`).join('');
                tr.innerHTML = `<td class="p-2 md:p-3 text-morandi-brown text-xs border-r border-morandi-dark/10 whitespace-nowrap"><div class="font-bold">${o.date}</div><div class="text-morandi-dark">${o.code}</div></td><td class="p-2 md:p-3 text-gray-700 text-xs border-r border-morandi-dark/10 min-w-[150px]"><div class="font-bold text-morandi-dark">${o.name}</div><div class="text-[10px] text-gray-500">${o.shop} Â· ${o.spec} x${o.qty}</div>${o.note ? `<div class="text-[10px] text-morandi-brown italic mt-1">"${o.note}"</div>` : ''}</td><td class="p-2 md:p-3 border-r border-morandi-dark/10 min-w-[100px]"><select onchange="updateOrderStatus(${o.id}, this.value)" class="text-xs p-1 border rounded bg-white w-full cursor-pointer hover:border-morandi-blue">${statusOptions}</select></td><td class="p-2 md:p-3 text-xs border-r border-morandi-dark/10 space-y-1 whitespace-nowrap"><div>${o.paid ? '<span class="text-white bg-morandi-green px-1 rounded text-[10px]">å·²æ”¶</span>' : '<span class="text-white bg-red-300 px-1 rounded text-[10px]">æœªæ”¶</span>'}</div><div>${o.shipping ? '<span class="text-white bg-morandi-blue px-1 rounded text-[10px]">é‹è²»OK</span>' : '<span class="text-gray-400 text-[10px]">é‹è²»æœª</span>'}</div></td><td class="p-2 md:p-3 border-r border-morandi-dark/10 whitespace-nowrap"><div class="font-display font-bold text-sm ${o.profit < 0 ? 'text-red-500' : 'text-morandi-green'}">$${Math.round(o.profit)}</div><div class="text-[10px] text-gray-400">æˆæœ¬ $${Math.round(o.twdCost)}</div></td><td class="p-2 md:p-3 text-center"><button onclick="deleteOrder(${o.id})" class="text-xs text-gray-400 hover:text-red-500 p-1"><i class="fas fa-trash-alt"></i></button></td>`;
                tbody.appendChild(tr);
            });
        }
        function updatePurchasingStats() {
            const orders = appData.orders; let netProfit = 0, totalRevenue = 0, totalCost = 0, unpaidAmount = 0, statusCounts = {};
            ORDER_STATUSES.forEach(s => statusCounts[s] = 0);
            orders.forEach(o => { netProfit += o.profit || 0; totalRevenue += o.sell || 0; totalCost += o.twdCost || 0; if (!o.paid) unpaidAmount += o.sell || 0; const s = o.status || "ç¢ºèªä¸­"; if(statusCounts.hasOwnProperty(s)) statusCounts[s]++; else { if(s === 'completed') statusCounts["è¨‚å–®å®Œæˆ"] = (statusCounts["è¨‚å–®å®Œæˆ"] || 0) + 1; else statusCounts["ç¢ºèªä¸­"]++; } });
            const margin = totalRevenue > 0 ? ((netProfit / totalRevenue) * 100).toFixed(1) : 0;
            document.getElementById('stats-net-profit').textContent = `NT$ ${Math.round(netProfit)}`; document.getElementById('stats-revenue').textContent = `NT$ ${Math.round(totalRevenue)}`; document.getElementById('stats-cost').textContent = `NT$ ${Math.round(totalCost)}`; document.getElementById('stats-unpaid').textContent = `NT$ ${Math.round(unpaidAmount)}`; document.getElementById('stats-margin').textContent = `${margin}%`; document.getElementById('stats-total-orders').textContent = orders.length;
            const distContainer = document.getElementById('stats-status-dist'); distContainer.innerHTML = ''; const maxCount = Math.max(...Object.values(statusCounts), 1);
            ORDER_STATUSES.forEach(status => { const count = statusCounts[status]; if(count > 0) { const percent = (count / maxCount) * 100; const bar = document.createElement('div'); bar.className = "flex items-center text-xs"; bar.innerHTML = `<div class="w-24 text-right font-bold text-morandi-dark mr-2 truncate">${status}</div><div class="flex-1 bg-gray-100 rounded-full h-4 overflow-hidden relative"><div class="bg-morandi-brown absolute top-0 left-0 h-full rounded-full" style="width: ${percent}%"></div></div><div class="w-8 text-left ml-2 text-morandi-brown font-bold">${count}</div>`; distContainer.appendChild(bar); } });
            if(Object.values(statusCounts).every(c => c === 0)) distContainer.innerHTML = '<div class="text-xs text-gray-400 text-center">æš«ç„¡åˆ†å¸ƒè³‡æ–™</div>';
        }

        // --- Subscriptions ---
        function toggleSubForm() {
             const panel = document.getElementById('sub-form-panel');
             if(panel.classList.contains('open')) panel.classList.remove('open');
             else panel.classList.add('open');
        }
        function addSub() {
            const name = document.getElementById('sub-name').value; const price = parseFloat(document.getElementById('sub-price').value); const person = document.getElementById('sub-person').value || 'è‡ªå·±'; const cycle = document.getElementById('sub-cycle').value; const date = document.getElementById('sub-date').value;
            if(!name || isNaN(price) || !date) return showToast("è«‹å¡«å¯«å®Œæ•´è³‡è¨Š");
            appData.subs.push({ id: Date.now(), name, price, person, cycle, date, isPaid: false }); saveData(); renderSubs('service');
            document.getElementById('sub-name').value = ''; document.getElementById('sub-price').value = ''; toggleSubForm(); showToast("è¨‚é–±å·²æ–°å¢");
        }
        function toggleSubPaid(id) { const s = appData.subs.find(sub => sub.id === id); if(s) { s.isPaid = !s.isPaid; saveData(); renderSubs(); } }
        function deleteSub(id) { if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) { appData.subs = appData.subs.filter(s => s.id !== id); saveData(); renderSubs(); } }
        let currentSubView = 'service';
        function renderSubs(view = currentSubView) {
            currentSubView = view; const container = document.getElementById('sub-list-container'); container.innerHTML = '';
            if(view === 'service') {
                const ul = document.createElement('ul'); ul.className = "space-y-3";
                appData.subs.forEach(s => {
                    const li = document.createElement('li'); li.className = "bg-white p-3 border border-morandi-dark/20 rounded flex justify-between items-center";
                    li.innerHTML = `<div class="flex items-center gap-3"><input type="checkbox" ${s.isPaid ? 'checked' : ''} onchange="toggleSubPaid(${s.id})"><div><div class="font-bold text-morandi-dark">${s.name}</div><div class="text-xs text-gray-500">${s.cycle === 'monthly' ? 'æ¯æœˆ' : 'æ¯å¹´'} ${s.date}æ—¥ Â· ${s.person}</div></div></div><div class="flex items-center gap-4"><div class="font-display font-bold text-morandi-dark">NT$ ${s.price}</div><button onclick="deleteSub(${s.id})" class="text-red-300 hover:text-red-500"><i class="fas fa-trash"></i></button></div>`; ul.appendChild(li);
                }); container.appendChild(ul);
            } else {
                const byPerson = {}; appData.subs.forEach(s => { if(!byPerson[s.person]) byPerson[s.person] = { total: 0, items: [] }; byPerson[s.person].total += s.price; byPerson[s.person].items.push(s); });
                Object.keys(byPerson).forEach(person => {
                    const group = byPerson[person]; const div = document.createElement('div'); div.className = "mb-4 bg-white border-2 border-morandi-dark p-4 shadow-retro-sm";
                    div.innerHTML = `<div class="flex justify-between items-center mb-2 border-b border-morandi-dark/20 pb-2"><h4 class="font-bold text-morandi-dark text-lg">${person}</h4><span class="font-display font-bold text-morandi-green text-xl">NT$ ${group.total}</span></div><ul class="text-sm space-y-1">${group.items.map(i => `<li class="flex justify-between text-gray-600"><span>${i.name}</span><span>$${i.price}</span></li>`).join('')}</ul>`; container.appendChild(div);
                });
            }
        }

        // --- Ledger ---
        function updateLedgerTypeOptions() {
            const category = document.getElementById('ledger-category').value; const typeSelect = document.getElementById('ledger-type'); typeSelect.innerHTML = '';
            if(category === 'general') typeSelect.innerHTML = `<option value="owe">é‚„æ¬¾</option><option value="lend">æ”¶æ¬¾</option>`; else typeSelect.innerHTML = `<option value="deposit">å­˜å…¥åŸºé‡‘</option>`;
        }
        function addLedgerEntry() {
            const category = document.getElementById('ledger-category').value; const type = document.getElementById('ledger-type').value; const date = document.getElementById('ledger-date').value; const desc = document.getElementById('ledger-desc').value; const amount = parseFloat(document.getElementById('ledger-amount').value);
            if(!date || !desc || isNaN(amount)) return showToast("è«‹å¡«å¯«å®Œæ•´è³‡è¨Š");
            if(category === 'general') { appData.debts.unshift({ id: Date.now(), date, type, person: desc, amount, note: '', status: 'unsettled' }); saveData(); renderDebts(); } else { appData.cameraFund.entries.unshift({ id: Date.now(), date, desc, amount }); saveData(); renderCameraFund(); }
            document.getElementById('ledger-desc').value = ''; document.getElementById('ledger-amount').value = ''; showToast("ç´€éŒ„å·²æ–°å¢");
        }
        function toggleDebtStatus(id) { const d = appData.debts.find(db => db.id === id); if(d) { d.status = d.status === 'settled' ? 'unsettled' : 'settled'; saveData(); renderDebts(); } }
        function renderDebts() {
            const ul = document.getElementById('debt-list'); 
            ul.innerHTML = '';
            
            // Calculate Balance for Header
            let totalOwe = 0;
            let totalLend = 0;

            appData.debts.forEach(d => {
                const isPaid = d.status === 'settled';
                if (!isPaid) {
                    if (d.type === 'owe') totalOwe += d.amount;
                    else totalLend += d.amount;
                }
                
                const li = document.createElement('li'); 
                li.className = `p-3 border-l-4 ${d.type === 'owe' ? 'border-red-400' : 'border-green-400'} bg-white shadow-sm flex justify-between items-center ${isPaid ? 'opacity-50' : ''}`;
                li.innerHTML = `<div class="flex flex-col"><span class="text-[10px] text-gray-400">${d.date}</span><div class="font-bold text-morandi-dark">${d.type === 'owe' ? 'é‚„æ¬¾' : 'æ”¶æ¬¾'} ${d.person} <span class="ml-2 text-lg">$${d.amount}</span></div></div><button onclick="toggleDebtStatus(${d.id})" class="px-2 py-1 text-xs border border-morandi-dark rounded hover:bg-morandi-dark hover:text-white transition">${isPaid ? 'å·²çµæ¸…' : 'æ¨™è¨˜çµæ¸…'}</button>`; 
                ul.appendChild(li);
            });
            
            // Update Header Text
            const balanceText = [];
            if(totalLend > 0) balanceText.push(`å¾…æ”¶ $${totalLend}`);
            if(totalOwe > 0) balanceText.push(`å¾…ä»˜ $${totalOwe}`);
            document.getElementById('debt-header-balance').textContent = balanceText.length ? `(${balanceText.join(' / ')})` : '';
        }

        function renderCameraFund() {
            const current = appData.cameraFund.entries.reduce((sum, e) => sum + e.amount, 0); const target = appData.cameraFund.target; const percent = Math.min((current / target) * 100, 100).toFixed(1);
            
            // Update Header Balance
            document.getElementById('camera-header-balance').textContent = `(ç›®å‰å­˜é¡ $${current})`;

            document.getElementById('camera-current').textContent = current; document.getElementById('camera-target-display').textContent = target; document.getElementById('camera-percent').textContent = percent + '%'; document.getElementById('camera-bar').style.width = percent + '%';
            const ul = document.getElementById('fund-list'); ul.innerHTML = '';
            appData.cameraFund.entries.forEach(e => { const li = document.createElement('li'); li.className = "flex justify-between border-b border-dashed border-gray-200 pb-1"; li.innerHTML = `<span>${e.date} ${e.desc}</span><span class="font-bold text-morandi-green">+$${e.amount}</span>`; ul.appendChild(li); });
        }

        // --- Tools & Export ---
        function generateQR() {
            const input = document.getElementById('qr-input').value; const container = document.getElementById('qrcode'); container.innerHTML = '';
            if(!input) return showToast("è«‹è¼¸å…¥å…§å®¹");
            new QRCode(container, { text: input, width: 150, height: 150, colorDark : "#4A4238", colorLight : "#ffffff", correctLevel : QRCode.CorrectLevel.H });
        }
        function shortenUrl() {
            const input = document.getElementById('url-input').value; const output = document.getElementById('short-url-output');
            if(!input) return showToast("è«‹è¼¸å…¥ç¶²å€");
            showToast("æ¨¡æ“¬ç¸®ç¶²å€ä¸­..."); setTimeout(() => { const hash = Math.random().toString(36).substring(7); output.value = `https://s.url/${hash}`; showToast("å·²ç”¢ç”Ÿæ¼”ç¤ºç”¨çŸ­ç¶²å€"); }, 500);
        }
        function copyUrl() { const copyText = document.getElementById("short-url-output"); copyText.select(); document.execCommand("copy"); showToast("å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿"); }
        function exportData() { const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(appData)); const link = document.createElement('a'); link.href = dataStr; link.download = "backup.json"; link.click(); }
        function importData(input) { const file = input.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = e => { try { appData = JSON.parse(e.target.result); saveData(); location.reload(); } catch(err) { showToast("éŒ¯èª¤"); } }; reader.readAsText(file); }
        function clearAllData() { if(confirm("ç¢ºå®šæ¸…é™¤ï¼Ÿ")) { localStorage.removeItem('retroDashboardData'); location.reload(); } }
        
        // Export Functions
        function exportTasks() { if(appData.tasks.length===0)return showToast("ç„¡è³‡æ–™"); const a=document.createElement('a'); a.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(appData.tasks)); a.download="tasks.json"; a.click(); }
        function importTasks(input) { const f=input.files[0]; if(!f)return; const r=new FileReader(); r.onload=e=>{ try{ const j=JSON.parse(e.target.result); if(Array.isArray(j)){ appData.tasks=[...j,...appData.tasks]; saveData(); renderTasks(); renderCalendar(); showToast("åŒ¯å…¥æˆåŠŸ"); } }catch(e){showToast("éŒ¯èª¤");} }; r.readAsText(f); input.value=''; }
        
        function exportDrinks() { if(appData.drinks.length===0)return showToast("ç„¡è³‡æ–™"); const a=document.createElement('a'); a.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(appData.drinks)); a.download="drinks.json"; a.click(); }
        function importDrinks(input) { const f=input.files[0]; if(!f)return; const r=new FileReader(); r.onload=e=>{ try{ const j=JSON.parse(e.target.result); if(Array.isArray(j)){ appData.drinks=[...j,...appData.drinks]; saveData(); renderDrinks(); renderDrinkCalendar(); updateStats(); showToast("åŒ¯å…¥æˆåŠŸ"); } }catch(e){showToast("éŒ¯èª¤");} }; r.readAsText(f); input.value=''; }

        function exportOrders() { if(appData.orders.length===0)return showToast("ç„¡è³‡æ–™"); const a=document.createElement('a'); a.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(appData.orders)); a.download="orders.json"; a.click(); }
        function importOrders(input) { const f=input.files[0]; if(!f)return; const r=new FileReader(); r.onload=e=>{ try{ const j=JSON.parse(e.target.result); if(Array.isArray(j)){ const now=Date.now(); const imported=j.map((o,i)=>{ let s="ç¢ºèªä¸­"; if(o.status==="completed")s="è¨‚å–®å®Œæˆ"; else if(ORDER_STATUSES.includes(o.status))s=o.status; if(o.clientCode!==undefined){ return { id:o.id||(now+i), date:o.date, code:o.clientCode, shop:o.store, name:o.productName, spec:o.spec||'', qty:o.quantity||1, status:s, krw:Math.round(o.costKRW||0), rate:o.exchangeRate||1, twdCost:Math.round(o.costTWD||0), sell:Math.round(o.price||0), profit:Math.round((o.price||0)-(o.costTWD||0)), paid:o.isPaid||false, shipping:o.isShippingPaid||false, note:o.note||'' }; } else { return { ...o, id:o.id?o.id:(now+i), status:s, krw:Math.round(o.krw||0), twdCost:Math.round(o.twdCost||0), sell:Math.round(o.sell||0), profit:Math.round(o.profit||0) }; } }); appData.orders=[...imported,...appData.orders]; saveData(); renderOrders(); updatePurchasingStats(); showToast("åŒ¯å…¥æˆåŠŸ"); } }catch(e){showToast("éŒ¯èª¤");} }; r.readAsText(f); input.value=''; }

        function exportSubs() { if(appData.subs.length===0)return showToast("ç„¡è³‡æ–™"); const a=document.createElement('a'); a.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(appData.subs)); a.download="subs.json"; a.click(); }
        function importSubs(input) { const f=input.files[0]; if(!f)return; const r=new FileReader(); r.onload=e=>{ try{ const j=JSON.parse(e.target.result); if(Array.isArray(j)){ appData.subs=[...j,...appData.subs]; saveData(); renderSubs(); showToast("åŒ¯å…¥æˆåŠŸ"); } }catch(e){showToast("éŒ¯èª¤");} }; r.readAsText(f); input.value=''; }

        function exportTracker() { const d={debts:appData.debts, cameraFund:appData.cameraFund}; const a=document.createElement('a'); a.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(d)); a.download="tracker.json"; a.click(); }
        function importTracker(input) { const f=input.files[0]; if(!f)return; const r=new FileReader(); r.onload=e=>{ try{ const j=JSON.parse(e.target.result); if(Array.isArray(j)){ const imported=j.map(i=>({ id:i.id||Date.now(), date:i.id?new Date(i.id).toLocaleDateString('zh-TW',{year:'numeric',month:'2-digit',day:'2-digit'}).replace(/\//g,'-'):new Date().toLocaleDateString('zh-TW',{year:'numeric',month:'2-digit',day:'2-digit'}).replace(/\//g,'-'), type:i.type==='repayment'?'owe':'owe', person:i.item||'æœªå‘½å', amount:i.amount||0, note:i.type==='repayment'?'(èˆŠåŒ¯å…¥)':'', status:'unsettled' })); appData.debts=[...imported,...appData.debts]; } else if(j.debts||j.cameraFund){ if(j.debts)appData.debts=[...j.debts,...appData.debts]; if(j.cameraFund&&j.cameraFund.entries)appData.cameraFund.entries=[...j.cameraFund.entries,...appData.cameraFund.entries]; } saveData(); renderDebts(); renderCameraFund(); showToast("åŒ¯å…¥æˆåŠŸ"); }catch(e){showToast("éŒ¯èª¤");} }; r.readAsText(f); input.value=''; }
    </script>
</body>
</html>