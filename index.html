<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å€‹äººæ‰‹æœ­ (Notion Style)</title>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Inter Font (Standard Notion) & Gaegu (Korean Handwritten) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Gaegu:wght@400;700&display=swap" rel="stylesheet">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        notion: {
                            bg: '#FFFFFF',          /* ä¸»èƒŒæ™¯ */
                            sidebar: '#F7F7F5',     /* å´é‚Šæ¬„ */
                            text: '#37352F',        /* ä¸»è¦æ–‡å­— */
                            dim: 'rgba(55, 53, 47, 0.6)', /* æ¬¡è¦æ–‡å­— */
                            border: '#E9E9E7',      /* é‚Šæ¡† */
                            hover: '#EFEFED',       /* æ‡¸åœèƒŒæ™¯ */
                            'red-bg': '#FDEBEC',
                            'blue-bg': '#E6F3F7',
                            'green-bg': '#EDF3EC',
                            'yellow-bg': '#FBF3DB',
                            'brown-bg': '#F4EEEE',
                            'orange-bg': '#FAEBDD',
                            'purple-bg': '#F6F3F9',
                            'gray-bg': '#F1F1EF'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'ui-sans-serif', 'system-ui', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'sans-serif'],
                        korean: ['"Gaegu"', 'cursive'], 
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            color: #37352F;
            background-color: #FFFFFF;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #D3D1CB; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #AEACA6; }

        /* Animations */
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Notion-like UI */
        .nav-item {
            display: flex; align-items: center; padding: 6px 12px; margin-bottom: 2px;
            border-radius: 4px; color: #37352F; font-weight: 500; font-size: 14px;
            transition: background-color 0.1s; cursor: pointer; user-select: none;
        }
        .nav-item:hover { background-color: #EFEFED; }
        .nav-item.active { background-color: #EFEFED; font-weight: 600; }
        .nav-item i, .nav-item .emoji { margin-right: 10px; width: 20px; text-align: center; font-size: 16px; color: #787774; }

        input, select, textarea {
            background-color: transparent; border: 1px solid #E9E9E7; color: #37352F;
            border-radius: 4px; padding: 6px 10px; font-size: 14px; transition: all 0.2s;
        }
        input:focus, select:focus, textarea:focus { border-color: #A4A29E; outline: none; box-shadow: 0 0 0 2px rgba(46, 170, 220, 0.1); }
        input::placeholder, textarea::placeholder { color: rgba(55, 53, 47, 0.4); }
        
        .btn-notion {
            display: inline-flex; align-items: center; justify-content: center;
            padding: 4px 10px; font-size: 13px; border-radius: 4px; font-weight: 500;
            transition: background-color 0.1s; cursor: pointer; border: 1px solid rgba(55, 53, 47, 0.16);
            color: #37352F; background: white;
        }
        .btn-notion:hover { background-color: #EFEFED; }
        .btn-notion-primary { background-color: #2383E2; color: white; border: 1px solid #2383E2; }
        .btn-notion-primary:hover { background-color: #1D70C2; }

        .collapse-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; border-top: 0px solid #4A4238; }
        .collapse-content.open { max-height: 3000px; }
        
        /* Transitions for Forms */
        #task-form-panel, #drink-form-panel, #order-form-panel, #sub-form-panel, #lit-form-panel, #course-form-panel, #ledger-form-panel {
            transition: max-height 0.4s ease-in-out, opacity 0.4s ease-in-out, margin 0.4s, padding 0.4s;
            max-height: 0; opacity: 0; overflow: hidden; padding: 0; margin: 0; border: none;
        }
        #task-form-panel.open, #drink-form-panel.open, #order-form-panel.open, #sub-form-panel.open, #lit-form-panel.open, #course-form-panel.open, #ledger-form-panel.open {
            max-height: 2000px; opacity: 1; margin-bottom: 1.5rem; padding: 1.5rem; border: 1px solid #E9E9E7; border-radius: 6px;
        }

        .notion-callout { padding: 16px; border-radius: 4px; display: flex; align-items: flex-start; }
        #drop-zone.dragover { background-color: #E6F3F7; border-color: #2383E2; }

        .schedule-cell { min-height: 60px; border-bottom: 1px solid #E9E9E7; border-right: 1px solid #E9E9E7; position: relative; }
        .course-block { position: absolute; left: 2px; right: 2px; top: 2px; bottom: 2px; border-radius: 4px; padding: 4px; font-size: 11px; font-weight: 500; color: #37352F; display: flex; flex-direction: column; justify-content: center; text-align: center; z-index: 10; overflow: hidden; text-overflow: ellipsis; }
        
        .grid-schedule { display: grid; grid-template-columns: 85px repeat(5, 1fr); }
        
        /* Cover Image Styles - Updated for Mobile Visibility */
        #page-cover-container {
            position: relative;
            width: 100%;
            height: 200px; 
            background-color: #F1F1EF; 
            overflow: hidden;
            background-size: cover;
            background-position: center;
        }
    </style>
</head>
<body class="h-screen flex overflow-hidden bg-notion-bg text-notion-text">

    <!-- Sidebar -->
    <aside class="w-60 bg-notion-sidebar border-r border-notion-border flex-shrink-0 flex flex-col h-full transition-all duration-300 hidden md:flex">
        <div class="p-4 border-b border-notion-border/50">
            <div id="sidebar-date-display" class="font-bold text-xl text-notion-text mb-4 px-1 tracking-tight leading-tight min-h-[3rem]"></div>
            <div class="flex gap-2">
                 <button onclick="backupAllData()" class="btn-notion flex-1 justify-center text-xs text-notion-dim hover:text-notion-text" title="åŒ¯å‡º">
                    <i class="fas fa-download mr-1"></i>åŒ¯å‡º
                </button>
                 <label class="btn-notion flex-1 justify-center text-xs text-notion-dim hover:text-notion-text cursor-pointer" title="åŒ¯å…¥">
                    <i class="fas fa-upload mr-1"></i>åŒ¯å…¥
                    <input type="file" class="hidden" onchange="importAllData(this)">
                </label>
            </div>
        </div>
        <div class="flex-1 overflow-y-auto px-2 py-2 space-y-0.5 custom-scroll">
            <div class="text-xs font-semibold text-notion-dim px-3 py-2 mt-2">FAVORITES</div>
            <div onclick="switchTab('dashboard')" id="btn-dashboard" class="nav-item active"><span class="emoji">ğŸ </span>Dashboard</div>
            <div class="text-xs font-semibold text-notion-dim px-3 py-2 mt-4">PRIVATE</div>
            <div onclick="switchTab('academia')" id="btn-academia" class="nav-item"><span class="emoji">ğŸ“</span>Academia</div>
            <div onclick="switchTab('drinks')" id="btn-drinks" class="nav-item"><span class="emoji">ğŸ§‹</span>Drinks Log</div>
            <div onclick="switchTab('debt')" id="btn-debt" class="nav-item"><span class="emoji">ğŸ’°</span>Finance</div>
            <div onclick="switchTab('literature')" id="btn-literature" class="nav-item"><span class="emoji">ğŸ“š</span>Literature</div>
            <div onclick="switchTab('planner')" id="btn-planner" class="nav-item"><span class="emoji">ğŸ“…</span>Planner</div>
            <div onclick="switchTab('purchasing')" id="btn-purchasing" class="nav-item"><span class="emoji">ğŸ›ï¸</span>Purchase Agent</div>
            <div onclick="switchTab('resources')" id="btn-resources" class="nav-item"><span class="emoji">ğŸ“‚</span>Resources</div>
            <div onclick="switchTab('subs')" id="btn-subs" class="nav-item"><span class="emoji">ğŸ’³</span>Subscriptions</div>
        </div>
    </aside>

    <!-- Mobile Nav Bar (Bottom) - Removed Notebook -->
    <div class="md:hidden fixed bottom-0 left-0 right-0 h-16 bg-white border-t border-notion-border z-50 flex justify-around items-center px-2">
        <button onclick="switchTab('dashboard')" class="flex flex-col items-center justify-center w-full h-full text-notion-dim hover:text-notion-text"><i class="fas fa-home text-lg mb-1"></i><span class="text-[10px]">Home</span></button>
        <button onclick="switchTab('planner')" class="flex flex-col items-center justify-center w-full h-full text-notion-dim hover:text-notion-text"><i class="fas fa-calendar-alt text-lg mb-1"></i><span class="text-[10px]">Planner</span></button>
        <button onclick="switchTab('resources')" class="flex flex-col items-center justify-center w-full h-full text-notion-dim hover:text-notion-text"><i class="fas fa-folder text-lg mb-1"></i><span class="text-[10px]">Files</span></button>
        <button onclick="showMoreMenu()" class="flex flex-col items-center justify-center w-full h-full text-notion-dim hover:text-notion-text"><i class="fas fa-ellipsis-h text-lg mb-1"></i><span class="text-[10px]">More</span></button>
    </div>

    <!-- Mobile More Menu -->
    <div id="mobile-more-menu" class="hidden md:hidden fixed inset-0 bg-black/50 z-50" onclick="hideMoreMenu()">
        <div class="absolute bottom-16 right-4 bg-white rounded-lg shadow-xl w-48 py-2 overflow-hidden animate-fade-in-up" onclick="event.stopPropagation()">
            <div class="border-b border-gray-100 pb-1 mb-1">
                <div class="px-4 py-2 hover:bg-notion-hover flex items-center gap-3 cursor-pointer text-sm" onclick="backupAllData(); hideMoreMenu()">
                    <i class="fas fa-download w-4 text-center text-gray-400"></i> åŒ¯å‡ºè³‡æ–™
                </div>
                <label class="px-4 py-2 hover:bg-notion-hover flex items-center gap-3 cursor-pointer text-sm">
                    <i class="fas fa-upload w-4 text-center text-gray-400"></i> åŒ¯å…¥å‚™ä»½
                    <input type="file" class="hidden" onchange="importAllData(this)">
                </label>
            </div>
            <div onclick="switchTab('academia'); hideMoreMenu()" class="px-4 py-3 hover:bg-notion-hover flex items-center gap-3 border-b border-gray-100"><span>ğŸ“</span> Academia</div>
            <div onclick="switchTab('drinks'); hideMoreMenu()" class="px-4 py-3 hover:bg-notion-hover flex items-center gap-3 border-b border-gray-100"><span>ğŸ§‹</span> Drinks</div>
            <div onclick="switchTab('debt'); hideMoreMenu()" class="px-4 py-3 hover:bg-notion-hover flex items-center gap-3 border-b border-gray-100"><span>ğŸ’°</span> Finance</div>
            <div onclick="switchTab('literature'); hideMoreMenu()" class="px-4 py-3 hover:bg-notion-hover flex items-center gap-3 border-b border-gray-100"><span>ğŸ“š</span> Literature</div>
            <div onclick="switchTab('purchasing'); hideMoreMenu()" class="px-4 py-3 hover:bg-notion-hover flex items-center gap-3 border-b border-gray-100"><span>ğŸ›ï¸</span> Shop</div>
            <div onclick="switchTab('subs'); hideMoreMenu()" class="px-4 py-3 hover:bg-notion-hover flex items-center gap-3"><span>ğŸ’³</span> Subscriptions</div>
        </div>
    </div>


    <!-- Main Content Area -->
    <main class="flex-1 h-full overflow-y-auto relative bg-white">
        <!-- Top Cover Image Area (Fixed Layout) -->
        <div id="page-cover-container" class="bg-gradient-to-r from-pink-100 via-purple-100 to-indigo-100 opacity-90 group relative w-full h-48 md:h-64">
            <!-- Fixed: Grouped buttons in a container, z-20 to be above image -->
            <div class="absolute bottom-2 right-4 flex gap-2 z-20 opacity-100 md:opacity-0 md:group-hover:opacity-100 transition-opacity duration-200">
                <button onclick="removeCover()" class="btn-notion text-xs bg-white/80 hover:bg-white shadow-sm text-red-500" title="ç§»é™¤å°é¢"><i class="fas fa-times"></i></button>
                <label class="btn-notion text-xs bg-white/80 hover:bg-white cursor-pointer shadow-sm">
                    <i class="fas fa-image mr-1"></i> æ›´æ›å°é¢
                    <input type="file" class="hidden" accept="image/*" onchange="uploadCover(this)">
                </label>
            </div>
        </div>
        
        <div class="max-w-5xl mx-auto px-4 md:px-12 pb-24 md:pb-12 relative z-10">
            <!-- Dynamic Page Icon with ID -->
            <div id="page-icon" class="text-6xl md:text-7xl mb-4 select-none -mt-10 md:-mt-12">ğŸ </div>
            <div class="mb-8 border-b border-notion-border pb-4 flex flex-col md:flex-row justify-between items-start md:items-end gap-4">
                <div>
                    <h1 class="text-3xl md:text-4xl font-bold text-notion-text mb-1" id="page-title">Dashboard</h1>
                    <div class="text-sm text-notion-dim flex items-center gap-2" id="page-desc">
                        <span>æœ€å¾Œæ›´æ–°: <span id="dashboard-date">--</span></span>
                    </div>
                </div>
                
                <!-- Mobile Only Actions (Header) -->
                <div class="flex gap-2 md:hidden">
                    <button onclick="backupAllData()" class="btn-notion hover:bg-notion-gray-bg text-notion-dim text-xs">
                        <i class="fas fa-download mr-1"></i>åŒ¯å‡º
                    </button>
                    <label class="btn-notion hover:bg-notion-gray-bg text-notion-dim cursor-pointer text-xs">
                        <i class="fas fa-upload mr-1"></i>åŒ¯å…¥
                        <input type="file" class="hidden" onchange="importAllData(this)">
                    </label>
                </div>
            </div>

            <!-- Content Container -->
            <div id="content-area">
                
                <!-- Tab 0: Dashboard -->
                <div id="tab-dashboard" class="section-content fade-in space-y-8">
                    <div class="bg-notion-gray-bg rounded-md p-6 flex flex-col md:flex-row items-center justify-between">
                        <div class="flex-1 border-l-4 border-notion-text pl-4 py-1">
                            <p class="text-xl font-korean text-notion-text leading-relaxed">"ë©ˆì¶°ì„œë„ ê´œì°®ì•„ ì•„ë¬´ ì´ìœ ë„ ëª¨ë¥´ëŠ” ì±„ ë‹¬ë¦´ í•„ìš” ì—†ì´"</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="space-y-8">
                            <section>
                                <h3 class="text-lg font-bold mb-3 flex items-center border-b border-notion-border pb-2"><span class="mr-2">ğŸ </span> To Do List</h3>
                                <div id="dashboard-tasks" class="space-y-1"><div class="text-sm text-notion-dim pl-2">è¼‰å…¥ä¸­...</div></div>
                            </section>
                        </div>
                        <div class="space-y-8">
                            <section>
                                <div class="flex justify-between items-center mb-3 border-b border-notion-border pb-2">
                                    <h3 class="text-lg font-bold flex items-center"><span class="mr-2">ğŸ”–</span> Bookmarks</h3>
                                    <button onclick="addBookmark()" class="text-notion-dim hover:text-notion-text"><i class="fas fa-plus"></i></button>
                                </div>
                                <ul id="dash-bookmarks" class="space-y-1"><li class="text-sm text-notion-dim pl-2">æš«ç„¡æ›¸ç±¤</li></ul>
                            </section>
                            <section>
                                <h3 class="text-lg font-bold mb-3 flex items-center border-b border-notion-border pb-2"><span class="mr-2">ğŸ“…</span> Upcoming & Due</h3>
                                <ul id="dash-due-dates" class="space-y-2"><li class="text-sm text-notion-dim pl-2">ç„¡è¿‘æœŸäº‹é …</li></ul>
                            </section>
                        </div>
                    </div>
                </div>

                <!-- Tab: Resources -->
                <div id="tab-resources" class="section-content hidden fade-in space-y-8">
                     <section>
                        <h3 class="text-lg font-bold mb-3 flex items-center border-b border-notion-border pb-2"><span class="mr-2">ğŸ“š</span> Recent Sources</h3>
                        <div id="dash-recent-sources" class="space-y-1 overflow-y-auto custom-scroll"><div class="text-sm text-notion-dim">å°šç„¡æ–‡ç»è³‡æ–™</div></div>
                    </section>
                     <section>
                        <h3 class="text-lg font-bold mb-3 flex items-center border-b border-notion-border pb-2"><span class="mr-2">ğŸ“‚</span> æ­¸æª”ç´€éŒ„ (File Log)</h3>
                        <div id="drop-zone" class="border border-dashed border-gray-300 rounded p-6 text-center cursor-pointer hover:bg-notion-hover mb-4 transition bg-notion-gray-bg/30">
                            <i class="fas fa-cloud-upload-alt text-2xl text-notion-dim mb-2"></i>
                            <div class="text-sm text-notion-text font-medium">æ‹–æ›³æª”æ¡ˆè‡³æ­¤å»ºç«‹ç´€éŒ„</div>
                            <div class="text-xs text-notion-dim mt-1">(åƒ…è¨˜éŒ„æª”åèˆ‡é€£çµï¼Œæª”æ¡ˆè«‹è‡ªè¡Œä¸Šå‚³é›²ç«¯)</div>
                        </div>
                        <ul id="dash-drive-files" class="space-y-2 text-sm custom-scroll"></ul>
                    </section>
                </div>

                <!-- Tab 1: Planner -->
                <div id="tab-planner" class="section-content hidden fade-in">
                    <div class="flex justify-end mb-4"><button onclick="toggleTaskForm()" class="btn-notion btn-notion-primary"><i class="fas fa-plus mr-1"></i> æ–°å¢å¾…è¾¦</button></div>
                    <div id="task-form-panel" class="bg-notion-gray-bg rounded-md border border-notion-border">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                            <input type="date" id="task-date" class="w-full">
                            <div class="flex items-center gap-2"><input type="time" id="task-time" class="w-full"><label class="text-sm text-notion-dim whitespace-nowrap"><input type="checkbox" id="task-allday" onchange="toggleTimeInput()"> å…¨æ—¥</label></div>
                            <select id="task-priority" class="md:col-span-2"><option value="q1">ğŸ”¥ ç·Šæ€¥ä¸”é‡è¦</option><option value="q2">â­ é‡è¦ä½†ä¸ç·Šæ€¥</option><option value="q3">âš¡ ç·Šæ€¥ä½†ä¸é‡è¦</option><option value="q4">â˜• ä¸é‡è¦ä¸ç·Šæ€¥</option></select>
                        </div>
                        <input type="text" id="task-title" placeholder="ä»»å‹™æ¨™é¡Œ" class="w-full font-bold mb-4">
                        <textarea id="task-content" rows="3" placeholder="è©³ç´°å…§å®¹..." class="w-full mb-4"></textarea>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"><input type="text" id="task-location" placeholder="åœ°é»"><input type="text" id="task-url" placeholder="ç›¸é—œé€£çµ"></div>
                        <div class="flex justify-end gap-2"><button onclick="toggleTaskForm()" class="btn-notion">å–æ¶ˆ</button><button onclick="addTask()" class="btn-notion btn-notion-primary">ç¢ºèªæ–°å¢</button></div>
                    </div>
                    <div class="flex justify-between items-center mb-4 mt-8"><button onclick="changeMonth(-1)" class="btn-notion"><i class="fas fa-chevron-left"></i></button><h2 id="calendar-month-year" class="text-xl font-bold"></h2><button onclick="changeMonth(1)" class="btn-notion"><i class="fas fa-chevron-right"></i></button></div>
                    <div class="grid grid-cols-7 text-center text-xs font-semibold text-notion-dim mb-2 border-b border-notion-border pb-2"><div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div></div>
                    <div id="calendar-grid" class="grid grid-cols-7 gap-1"></div>
                    <h3 class="text-lg font-bold mt-8 mb-4 border-b border-notion-border pb-2">å¾…è¾¦æ¸…å–®</h3>
                    <div class="bg-notion-gray-bg/50 p-2 rounded">
                        <div class="flex justify-between items-center p-2"><span class="text-sm font-semibold text-notion-dim">æ‰€æœ‰äº‹é …</span><button onclick="toggleCollapse('all-tasks-list', 'icon-matrix-view')" class="text-notion-dim hover:text-notion-text"><i id="icon-matrix-view" class="fas fa-chevron-down"></i></button></div>
                        <ul id="all-tasks-list" class="divide-y divide-notion-border collapse-content open"></ul>
                        <div id="empty-tasks-msg" class="hidden p-8 text-center text-notion-dim text-sm">ç›®å‰æ²’æœ‰å¾…è¾¦äº‹é …</div>
                    </div>
                </div>

                <!-- Tab 1.5: Academia -->
                <div id="tab-academia" class="section-content hidden fade-in">
                    <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
                        <div class="flex flex-col md:flex-row gap-4 items-start md:items-center w-full md:w-auto overflow-x-auto">
                            <div class="flex bg-notion-gray-bg p-1 rounded-md shrink-0" id="semester-tabs">
                                <button onclick="switchSemester('114-1')" id="sem-btn-114-1" class="px-3 py-1 rounded text-sm font-bold transition">114-1</button>
                                <button onclick="switchSemester('114-2')" id="sem-btn-114-2" class="px-3 py-1 rounded text-sm font-bold text-notion-dim hover:bg-white/50 transition">114-2</button>
                                <button onclick="switchSemester('115-1')" id="sem-btn-115-1" class="px-3 py-1 rounded text-sm font-bold text-notion-dim hover:bg-white/50 transition">115-1</button>
                                <button onclick="switchSemester('115-2')" id="sem-btn-115-2" class="px-3 py-1 rounded text-sm font-bold text-notion-dim hover:bg-white/50 transition">115-2</button>
                            </div>
                            <div class="flex gap-2 shrink-0">
                                <div class="notion-callout bg-notion-blue-bg py-1 px-3 flex items-center text-sm"><span class="mr-2">ğŸ“</span> <span id="acad-gpa" class="font-bold">0.0</span> <span class="text-notion-dim text-xs ml-1">/ 4.3</span></div>
                                <div class="notion-callout bg-notion-green-bg py-1 px-3 flex items-center text-sm"><span class="mr-2">ğŸ“Š</span> <span id="acad-total-credits" class="font-bold">0</span> <span class="text-notion-dim text-xs ml-1">/ 42</span></div>
                            </div>
                        </div>
                        <button onclick="toggleCourseForm()" class="btn-notion btn-notion-primary ml-auto"><i class="fas fa-plus mr-1"></i> èª²ç¨‹</button>
                    </div>
                    <div id="course-form-panel" class="bg-notion-gray-bg rounded-md border border-notion-border">
                         <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                            <input type="text" id="course-name" placeholder="èª²ç¨‹åç¨±" class="md:col-span-2">
                            <input type="number" id="course-credits" placeholder="å­¸åˆ†" value="2">
                            <input type="number" id="course-target-grade" placeholder="ç›®æ¨™æˆç¸¾">
                            <input type="number" id="course-grade" placeholder="å¯¦éš›æˆç¸¾">
                            <input type="number" id="course-gpa" placeholder="å–®ç§‘GPA" step="0.1">
                            <select id="course-type"><option value="å¿…ä¿®">å¿…ä¿®</option><option value="å¿…é¸ä¿®">å¿…é¸ä¿®</option><option value="é¸ä¿®">é¸ä¿®</option></select>
                            <select id="course-day"><option value="1">é€±ä¸€</option><option value="2">é€±äºŒ</option><option value="3">é€±ä¸‰</option><option value="4">é€±å››</option><option value="5">é€±äº”</option></select>
                            <select id="course-start"></select><select id="course-end"></select>
                            <input type="hidden" id="course-semester">
                            <button id="btn-save-course" onclick="addCourse()" class="btn-notion btn-notion-primary">ä¿å­˜</button>
                        </div>
                    </div>
                    
                    <h3 class="text-base font-bold mb-3 mt-6">èª²ç¨‹åˆ—è¡¨ (All Courses)</h3>
                    <!-- Responsive Course List Container -->
                    <div id="course-list-container">
                        <!-- Desktop Table -->
                        <div class="hidden md:block overflow-x-auto border border-notion-border rounded-md mb-8">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-notion-gray-bg text-notion-dim text-xs">
                                    <tr>
                                        <th class="p-3 border-b border-notion-border text-left">å­¸æœŸ</th>
                                        <th class="p-3 border-b border-notion-border text-left">èª²ç¨‹</th>
                                        <th class="p-3 border-b border-notion-border text-left">é¡åˆ¥</th>
                                        <th class="p-3 border-b border-notion-border text-left">å­¸åˆ†</th>
                                        <th class="p-3 border-b border-notion-border text-left">ç›®æ¨™</th>
                                        <th class="p-3 border-b border-notion-border text-left">å¯¦éš›</th>
                                        <th class="p-3 border-b border-notion-border w-24"></th>
                                    </tr>
                                </thead>
                                <tbody id="course-list-body-desktop" class="divide-y divide-notion-border bg-white"></tbody>
                            </table>
                        </div>
                        <!-- Mobile Cards -->
                        <div id="course-list-body-mobile" class="md:hidden space-y-3 mb-8"></div>
                    </div>

                    <div class="mb-8">
                        <div class="flex justify-between items-center mb-3 border-b border-notion-border pb-2">
                            <h3 class="text-base font-bold">èª²ç¨‹è¦åŠƒ (Course Planning)</h3>
                            <button onclick="toggleCourseForm()" class="text-xs text-blue-600 hover:underline"><i class="fas fa-plus"></i> æ–°å¢è¦åŠƒ</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="bg-notion-gray-bg/50 rounded p-3 border border-notion-border"><div class="text-xs font-bold text-red-600 uppercase mb-2">å¿…ä¿®</div><ul id="plan-required" class="space-y-1 text-sm text-notion-text"></ul></div>
                            <div class="bg-notion-gray-bg/50 rounded p-3 border border-notion-border"><div class="text-xs font-bold text-blue-600 uppercase mb-2">å¿…é¸ä¿®</div><ul id="plan-comp-elective" class="space-y-1 text-sm text-notion-text"></ul></div>
                            <div class="bg-notion-gray-bg/50 rounded p-3 border border-notion-border"><div class="text-xs font-bold text-green-600 uppercase mb-2">é¸ä¿®</div><ul id="plan-elective" class="space-y-1 text-sm text-notion-text"></ul></div>
                        </div>
                    </div>
                    <h3 class="text-base font-bold mb-3 pt-6 border-t border-notion-border">æœ¬å­¸æœŸèª²è¡¨ <span id="schedule-title-semester" class="text-sm font-normal text-notion-dim ml-2"></span></h3>
                    <div class="overflow-x-auto border border-notion-border rounded-md mb-8">
                        <div class="min-w-[600px] bg-white">
                            <div class="grid-schedule border-b border-notion-border bg-notion-gray-bg text-center text-xs font-bold py-2 text-notion-dim"><div>æ™‚é–“</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div></div>
                            <div id="schedule-container" class="relative"></div>
                        </div>
                    </div>
                </div>

                <div id="tab-drinks" class="section-content hidden fade-in">
                    <div class="flex justify-end mb-4"><button onclick="toggleDrinkForm()" class="btn-notion btn-notion-primary"><i class="fas fa-plus mr-1"></i> ç´€éŒ„é£²å“</button></div>
                    <div id="drink-form-panel" class="bg-notion-gray-bg rounded-md border border-notion-border">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <input type="date" id="drink-date">
                            <input type="text" id="drink-shop" placeholder="åº—å®¶">
                            <input type="text" id="drink-name" placeholder="å“é …" class="md:col-span-2">
                            <div class="flex gap-2 items-center md:col-span-2">
                                <input type="number" id="drink-price" placeholder="é‡‘é¡" class="flex-1">
                                <label class="text-xs"><input type="checkbox" id="drink-treat" onchange="toggleDrinkPriceState()"> è«‹å®¢</label>
                                <label class="text-xs"><input type="checkbox" id="drink-meal" onchange="toggleDrinkPriceState()"> éš¨é¤</label>
                                <label class="text-xs"><input type="checkbox" id="drink-eco"> ç’°ä¿</label>
                            </div>
                        </div>
                        <button onclick="addDrink()" class="btn-notion btn-notion-primary w-full">ç´€éŒ„</button>
                    </div>
                    <div class="mb-8">
                        <div class="flex justify-between items-center mb-4 border-b border-notion-border pb-2">
                             <h3 class="text-base font-bold">é£²å“æ—¥æ›†</h3>
                             <div class="flex items-center gap-2">
                                 <button onclick="changeDrinkMonth(-1)" class="btn-notion"><i class="fas fa-chevron-left"></i></button>
                                 <span id="drink-calendar-month-year" class="text-sm font-bold"></span>
                                 <button onclick="changeDrinkMonth(1)" class="btn-notion"><i class="fas fa-chevron-right"></i></button>
                             </div>
                        </div>
                        <div class="grid grid-cols-7 text-center text-xs font-semibold text-notion-dim mb-1"><div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div></div>
                        <div id="drink-calendar-grid" class="grid grid-cols-7 gap-1"></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                         <div class="notion-callout bg-notion-green-bg flex-col items-center justify-center text-center">
                             <div class="text-xs text-notion-dim uppercase tracking-wider">ç¸½èŠ±è²»</div>
                             <div class="text-2xl font-bold mt-1" id="stat-total-cost">NT$ 0</div>
                             <div class="text-xs text-gray-500 mt-1" id="stat-total-cups">0 æ¯</div>
                         </div>
                         <div class="notion-callout bg-notion-blue-bg flex-col items-center justify-center text-center">
                             <div class="text-xs text-notion-dim uppercase tracking-wider">æœ€å¸¸å»</div>
                             <div class="text-xl font-bold mt-1" id="stat-fav-shop">-</div>
                         </div>
                         <div class="notion-callout bg-notion-red-bg flex-col items-center justify-center text-center">
                             <div class="text-xs text-notion-dim uppercase tracking-wider">æœ€æ„›å–</div>
                             <div class="text-xl font-bold mt-1" id="stat-fav-drink">-</div>
                         </div>
                    </div>
                    <div class="grid grid-cols-1 gap-6">
                        <div>
                             <h3 class="text-base font-bold mb-3 border-b border-notion-border pb-2">æœ€è¿‘ç´€éŒ„</h3>
                             <div class="overflow-x-auto">
                                <table class="w-full text-sm text-left">
                                    <thead class="text-notion-dim text-xs bg-notion-gray-bg"><tr><th class="p-2 rounded-l">æ—¥æœŸ</th><th class="p-2">åº—å®¶</th><th class="p-2">å“é …</th><th class="p-2">é‡‘é¡</th><th class="p-2 rounded-r w-8"></th></tr></thead>
                                    <tbody id="drink-list-body" class="divide-y divide-notion-border"></tbody>
                                </table>
                             </div>
                        </div>
                    </div>
                </div>

                <div id="tab-purchasing" class="section-content hidden fade-in">
                    <div class="flex justify-end mb-4"><button onclick="toggleOrderForm()" class="btn-notion btn-notion-primary"><i class="fas fa-plus mr-1"></i> æ–°å¢è¨‚å–®</button></div>
                    <div id="order-form-panel" class="bg-notion-gray-bg rounded-md border border-notion-border">
                        <h4 class="font-bold mb-4">å»ºç«‹/ç·¨è¼¯è¨‚å–®</h4>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                            <input type="date" id="order-date">
                            <input type="text" id="order-shop" placeholder="åº—å®¶">
                            <input type="text" id="order-code" placeholder="ä»£è™Ÿ">
                            <input type="number" id="order-rate" placeholder="åŒ¯ç‡ (38)" value="38" oninput="calcProfit()">
                            <select id="order-status" class="md:col-span-3"></select>
                        </div>
                        <div class="mb-4 bg-white p-3 rounded border border-notion-border">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm font-bold">å“é …åˆ—è¡¨</span>
                                <button onclick="addOrderItemRow()" class="text-xs text-blue-500 hover:underline">+ å¢åŠ å“é …</button>
                            </div>
                            <div id="order-items-container" class="space-y-2"></div>
                        </div>
                        <div class="grid grid-cols-3 gap-4 mb-4 text-sm">
                            <div class="bg-white p-2 rounded border">æˆæœ¬: <span id="order-twd-cost" class="font-bold">0</span></div>
                            <div class="bg-white p-2 rounded border">å”®åƒ¹: <span id="order-sell-price" class="font-bold" contenteditable="true" oninput="calculateProfitManual()">0</span></div>
                            <div class="bg-notion-green-bg p-2 rounded border border-green-200">åˆ©æ½¤: <span id="order-profit" class="font-bold text-green-700">0</span></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <input type="text" id="order-note" placeholder="å‚™è¨»">
                            <div class="flex gap-4 items-center">
                                <label class="text-sm"><input type="checkbox" id="order-paid"> å•†å“å·²æ”¶</label>
                                <label class="text-sm"><input type="checkbox" id="order-shipping"> é‹è²»å·²åŒ¯</label>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="resetOrderForm(); toggleOrderForm()" class="btn-notion flex-1">å–æ¶ˆ</button>
                            <button id="btn-save-order" onclick="saveOrder()" class="btn-notion btn-notion-primary flex-1">å„²å­˜è¨‚å–®</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-4 mb-6">
                        <div class="notion-callout bg-notion-gray-bg flex-col text-center py-3"><div class="text-xs text-notion-dim">æ·¨åˆ©æ½¤</div><div class="text-xl font-bold text-green-600" id="stats-net-profit">0</div></div>
                        <div class="notion-callout bg-notion-gray-bg flex-col text-center py-3"><div class="text-xs text-notion-dim">æœªæ”¶æ¬¾</div><div class="text-xl font-bold text-red-500" id="stats-unpaid">0</div></div>
                        <div class="notion-callout bg-notion-gray-bg flex-col text-center py-3"><div class="text-xs text-notion-dim">è¨‚å–®æ•¸</div><div class="text-xl font-bold" id="stats-total-orders">0</div></div>
                    </div>
                    <div class="flex justify-between items-center mb-3 border-b border-notion-border pb-2">
                        <h3 class="text-base font-bold">è¨‚å–®å¸³æœ¬</h3>
                        <div class="flex items-center gap-2 text-xs">
                             <select id="order-sort-select" onchange="updateOrderDisplaySettings()" class="bg-transparent border-none p-0 font-bold"><option value="desc">æ–°â†’èˆŠ</option><option value="asc">èˆŠâ†’æ–°</option></select>
                             <label><input type="checkbox" id="order-filter-unfinished" onchange="updateOrderDisplaySettings()"> åƒ…æœªå®Œæˆ</label>
                        </div>
                    </div>
                    <!-- Updated Order List Layout: Grid Cards -->
                    <div id="order-list-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Content injected by JS (renderOrders) -->
                    </div>
                </div>

                <div id="tab-subs" class="section-content hidden fade-in">
                     <div class="flex justify-end mb-4"><button onclick="toggleSubForm()" class="btn-notion btn-notion-primary"><i class="fas fa-plus mr-1"></i> æ–°å¢è¨‚é–±</button></div>
                    <div id="sub-form-panel" class="bg-notion-gray-bg rounded-md border border-notion-border">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                            <select id="sub-name" class="md:col-span-2" onchange="updateSubPrice(this)">
                                <option value="" disabled selected>é¸æ“‡æœå‹™æˆ–è¼¸å…¥</option>
                                <option value="Spotify">Spotify</option><option value="Netflix">Netflix</option>
                                <option value="iCloud">iCloud</option><option value="YouTube">YouTube</option><option value="Other">è‡ªè¨‚...</option>
                            </select>
                            <input type="text" id="sub-name-custom" placeholder="æœå‹™åç¨±" class="md:col-span-2 hidden">
                            <input type="number" id="sub-price" placeholder="é‡‘é¡">
                            <input type="text" id="sub-person" placeholder="åˆ†æ“”äºº">
                            <select id="sub-cycle"><option value="monthly">æ¯æœˆ</option><option value="quarterly">æ¯å­£</option><option value="yearly">æ¯å¹´</option></select>
                            <input type="date" id="sub-date">
                        </div>
                        <button onclick="addSub()" class="btn-notion btn-notion-primary w-full">å„²å­˜</button>
                    </div>
                    <div id="sub-list-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>

                <div id="tab-debt" class="section-content hidden fade-in space-y-8">
                    <div id="ledger-form-container" class="bg-notion-gray-bg p-4 rounded-md border border-notion-border">
                        <h3 class="text-sm font-bold mb-3">æ–°å¢/ç·¨è¼¯ç´€éŒ„</h3>
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
                             <div class="md:col-span-2 flex gap-2">
                                <select id="ledger-category" onchange="updateLedgerTypeOptions()" class="flex-1"><option value="general">ä¸€èˆ¬å¸³å‹™</option><option value="camera">ç›¸æ©Ÿå¤¢</option></select>
                                <select id="ledger-type" class="flex-1"></select>
                            </div>
                            <input type="date" id="ledger-date">
                            <input type="text" id="ledger-desc" placeholder="å°è±¡ / é …ç›®">
                            <input type="number" id="ledger-amount" placeholder="é‡‘é¡">
                        </div>
                        <div class="flex gap-2 mt-3 justify-end">
                            <button id="btn-cancel-ledger" onclick="resetLedgerForm()" class="btn-notion hidden">å–æ¶ˆ</button>
                            <button id="btn-save-ledger" onclick="saveLedgerEntry()" class="btn-notion btn-notion-primary">æ–°å¢</button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <!-- Collapsible General Debt Section -->
                            <details class="group border border-notion-border rounded bg-white overflow-hidden mb-4" open>
                                <summary class="flex justify-between items-center p-3 cursor-pointer hover:bg-notion-hover list-none bg-notion-gray-bg select-none">
                                    <div class="flex items-center gap-2">
                                        <i class="fas fa-chevron-right text-xs text-gray-400 group-open:rotate-90 transition-transform"></i>
                                        <span class="font-bold text-base">ä¸€èˆ¬å¸³å‹™ (æ¬ æ¬¾/é‚„æ¬¾)</span>
                                    </div>
                                    <span id="debt-total-balance" class="text-xs font-normal bg-white border border-notion-border px-2 py-1 rounded">çµé¤˜: 0</span>
                                </summary>
                                <div id="debt-list" class="p-0 border-t border-notion-border"></div>
                            </details>
                        </div>
                        <div>
                            <!-- Collapsible Camera Fund Section -->
                            <details class="group border border-notion-border rounded bg-white overflow-hidden mb-4" open>
                                <summary class="flex justify-between items-center p-3 cursor-pointer hover:bg-notion-hover list-none bg-notion-gray-bg select-none">
                                    <div class="flex items-center gap-2">
                                        <i class="fas fa-chevron-right text-xs text-gray-400 group-open:rotate-90 transition-transform"></i>
                                        <span class="font-bold text-base">ç›¸æ©Ÿå¤¢åŸºé‡‘</span>
                                    </div>
                                    <span id="camera-header-balance" class="text-xs font-normal text-green-600 bg-white border border-notion-border px-2 py-1 rounded">å­˜: 0</span>
                                </summary>
                                <div class="p-3 border-t border-notion-border">
                                    <div class="w-full bg-gray-100 rounded-full h-2 mb-4 overflow-hidden"><div id="camera-bar" class="bg-green-500 h-full transition-all duration-500" style="width: 0%"></div></div>
                                    <ul id="fund-list" class="space-y-0 max-h-96 overflow-y-auto custom-scroll"></ul>
                                </div>
                            </details>
                        </div>
                    </div>
                </div>

                <div id="tab-literature" class="section-content hidden fade-in">
                    <div class="flex justify-end mb-4"><button onclick="toggleCollapse('lit-form-panel', 'icon-add-lit')" class="btn-notion btn-notion-primary"><i id="icon-add-lit" class="fas fa-plus mr-1 transition-transform duration-300"></i> æ–°å¢æ–‡ç»</button></div>
                    <div id="lit-form-panel" class="bg-notion-gray-bg rounded-md border border-notion-border mb-8 collapse-content">
                        <div class="p-4">
                            <h4 class="text-xs font-bold text-notion-dim mb-4 uppercase">åŸºæœ¬è³‡è¨Š</h4>
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                                <input type="text" id="lit-title" placeholder="æ¨™é¡Œ" class="md:col-span-2 font-bold">
                                <input type="text" id="lit-author" placeholder="ä½œè€…">
                                <input type="text" id="lit-date" placeholder="å¹´ä»½ (2023)">
                                <select id="lit-type"><option>æœŸåˆŠè«–æ–‡</option><option>æ›¸ç±</option><option>å­¸ä½è«–æ–‡</option><option>ç¶²è·¯æ–‡ç« </option><option>å…¶ä»–</option></select>
                                <select id="lit-status"><option>å·²è®€</option><option>é–±è®€ä¸­</option><option>æƒ³è®€</option></select>
                                <input type="text" id="lit-field" placeholder="é ˜åŸŸ" class="md:col-span-2">
                                <input type="text" id="lit-keywords" placeholder="é—œéµå­—" class="md:col-span-4">
                                <input type="text" id="lit-doi" placeholder="DOI">
                                <input type="text" id="lit-theories" placeholder="ç›¸é—œç†è«–" class="md:col-span-3">
                            </div>
                            <h4 class="text-xs font-bold text-notion-dim mb-4 uppercase">è®Šæ•¸æ¨¡å‹</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 bg-white p-4 rounded border border-notion-border">
                                <input type="text" id="lit-method-iv" placeholder="è‡ªè®Šæ•¸ (IV)">
                                <input type="text" id="lit-method-dv" placeholder="å› è®Šæ•¸ (DV)">
                                <input type="text" id="lit-method-med" placeholder="ä¸­ä»‹è®Šæ•¸ (Mediator)">
                                <input type="text" id="lit-method-mod" placeholder="èª¿ç¯€è®Šæ•¸ (Moderator)">
                            </div>
                            <h4 class="text-xs font-bold text-notion-dim mb-4 uppercase">ç ”ç©¶æ ¸å¿ƒ</h4>
                            <div class="space-y-4 mb-6">
                                <textarea id="lit-background" class="w-full" rows="2" placeholder="ç ”ç©¶èƒŒæ™¯..."></textarea>
                                <textarea id="lit-purpose" class="w-full" rows="2" placeholder="ç ”ç©¶ç›®çš„..."></textarea>
                                <textarea id="lit-conclusion" class="w-full" rows="3" placeholder="ç ”ç©¶çµè«–..."></textarea>
                                <textarea id="lit-note" class="w-full" rows="2" placeholder="å€‹äººç­†è¨˜..."></textarea>
                                <input type="text" id="lit-link" placeholder="é€£çµ URL" class="w-full">
                            </div>
                            <button onclick="addLit()" class="btn-notion btn-notion-primary w-full">å„²å­˜æ–‡ç»</button>
                        </div>
                    </div>
                    <div id="lit-list-container" class="space-y-4"></div>
                </div>

            </div> </div>
    </main>
    
    <div id="course-note-modal" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl h-[80vh] flex flex-col">
            <div class="p-4 border-b border-notion-border flex justify-between items-center">
                <h3 class="font-bold text-lg" id="modal-course-title">èª²ç¨‹ç­†è¨˜</h3>
                <button onclick="closeCourseNote()" class="text-gray-400 hover:text-black"><i class="fas fa-times"></i></button>
            </div>
            <div class="flex-1 p-4 bg-notion-gray-bg/30">
                <textarea id="modal-course-content" class="w-full h-full p-4 border border-notion-border rounded resize-none focus:ring-0 text-sm leading-relaxed" placeholder="åœ¨æ­¤è¼¸å…¥ç­†è¨˜..."></textarea>
            </div>
            <div class="p-4 border-t border-notion-border flex justify-end">
                <button onclick="saveCurrentCourseNote()" class="btn-notion btn-notion-primary">å„²å­˜</button>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-6 right-6 bg-gray-800 text-white px-4 py-3 rounded shadow-lg transform translate-y-32 opacity-0 transition-all duration-300 z-50 text-sm">Notification</div>

    <script>
        // --- CORE FUNCTIONS ---
        const TIME_SLOTS = ["08:10~09:00", "09:10~10:00", "10:10~11:00", "11:10~12:00", "13:30~14:20", "14:30~15:20", "15:30~16:20"];
        const ORDER_STATUSES = ["ç¢ºèªä¸­", "å·²åŒ¯æ¬¾", "å°å¸³å®Œæˆ", "éŸ“åœ‹ç«¯ä¸‹å–®", "éŸ“åœ‹ç«¯å‡ºè²¨", "å¾…é›†é‹å›å°", "å·²æŠµå°", "æŠµå°æ•´ç†ä¸­", "å¾…é¢äº¤", "å·²å¯„å‡º", "è¨‚å–®å®Œæˆ"];
        
        let currentSemester = '114-1'; 
        let appData = { tasks: [], drinks: [], orders: [], subs: [], debts: [], cameraFund: { target: 50000, entries: [] }, literature: [], bookmarks: [], courseNotes: "", driveFiles: [], courses: [], coverImage: null };
        let currentCalendarDate = new Date();
        let currentDrinkCalendarDate = new Date();
        let orderSort = 'desc';
        let orderFilterUnfinished = false;
        let currentEditingCourseId = null;
        let currentEditingOrderId = null;
        let currentNoteCourseId = null; 
        let editingLedgerId = null; // New variable for finance editing

        document.addEventListener('DOMContentLoaded', () => {
            loadData(); 
            updateDate(); 
            switchTab('dashboard');
            renderTasks(); renderCalendar(); renderDrinks(); renderDrinkCalendar(); 
            renderStatusOptions(); renderOrders(); updateStats(); updatePurchasingStats(); 
            renderSubs(); renderDebts(); renderCameraFund(); updateLedgerTypeOptions(); 
            renderLiterature(); initAcademiaSelects(); renderSchedule('schedule-container'); renderCourseList(); 
            renderCoursePlanning(); updateAcademicStats(); initDragAndDrop(); switchSemester('114-1');
        });

        // Utils
        function loadData() { 
            const s=localStorage.getItem('retroDashboardData'); 
            if(s){ 
                const p=JSON.parse(s); 
                appData={...appData,...p}; 
                ['tasks','drinks','orders','subs','debts','literature','bookmarks','driveFiles','courses'].forEach(k=>{if(!appData[k])appData[k]=[]}); 
                if(!appData.cameraFund)appData.cameraFund={target:50000,entries:[]};
            } 
        }
        function saveData() { localStorage.setItem('retroDashboardData', JSON.stringify(appData)); }
        function showToast(m) { const t=document.getElementById('toast'); t.textContent=m; t.classList.remove('translate-y-32','opacity-0'); setTimeout(()=>{t.classList.add('translate-y-32','opacity-0');},3000); }
        function updateDate() { 
            const n=new Date(); 
            const dateStr = `${n.getFullYear()} / ${String(n.getMonth()+1).padStart(2,'0')} / ${String(n.getDate()).padStart(2,'0')} (${['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][n.getDay()]})`;
            if(document.getElementById('sidebar-date-display')) document.getElementById('sidebar-date-display').innerHTML = dateStr;
            if(document.getElementById('dashboard-date')) document.getElementById('dashboard-date').innerHTML = dateStr;
        }
        
        function switchTab(t) { 
            document.querySelectorAll('.nav-item').forEach(b=>{ b.classList.remove('active'); if(b.id===`btn-${t}`) b.classList.add('active'); });
            document.querySelectorAll('.section-content').forEach(s=>{s.classList.add('hidden');if(s.id===`tab-${t}`)s.classList.remove('hidden');}); 
            
            const titles = { 'dashboard':'Dashboard', 'planner':'Planner', 'drinks':'Drinks Log', 'purchasing':'Purchase Agent', 'subs':'Subscriptions', 'debt':'Finance', 'literature':'Literature', 'academia':'Academia', 'resources':'Resources' };
            const icons = { 'dashboard':'ğŸ ', 'planner':'ğŸ“…', 'drinks':'ğŸ§‹', 'purchasing':'ğŸ›ï¸', 'subs':'ğŸ’³', 'debt':'ğŸ’°', 'literature':'ğŸ“š', 'academia':'ğŸ“', 'resources':'ğŸ“‚' };
            const descs = { 'dashboard':'ç¾å¥½çš„ä¸€å¤©ï¼Œå¾é€™è£¡é–‹å§‹ã€‚', 'planner':'ç®¡ç†æ‚¨çš„æ—¥ç¨‹èˆ‡å¾…è¾¦äº‹é …ã€‚', 'drinks':'ç´€éŒ„æ¯ä¸€æ¯å¿«æ¨‚çš„æ³‰æºã€‚', 'purchasing':'è¿½è¹¤ä»£è³¼è¨‚å–®èˆ‡åˆ©æ½¤ã€‚', 'subs':'ç®¡ç†å®šæœŸæ‰£æ¬¾çš„æœå‹™ã€‚', 'debt':'ä¸€èˆ¬çš„è¨˜å¸³èˆ‡å¤¢æƒ³åŸºé‡‘ã€‚', 'literature':'å­¸è¡“æ–‡ç»çš„æ•´ç†èˆ‡ç­†è¨˜ã€‚', 'academia':'èª²è¡¨ã€å­¸åˆ†èˆ‡æˆç¸¾ç®¡ç†ã€‚', 'resources':'æª”æ¡ˆæ­¸æª”èˆ‡è¿‘æœŸåƒè€ƒæ–‡ç»ã€‚' };
            
            if(document.getElementById('page-title')) document.getElementById('page-title').innerText = titles[t];
            if(document.getElementById('page-desc')) document.getElementById('page-desc').innerHTML = `<span>${descs[t]}</span>`; 
            if(document.getElementById('page-icon')) document.getElementById('page-icon').innerText = icons[t] || 'ğŸ“’';

            if(t==='planner') renderCalendar(); 
            if(t==='drinks') renderDrinkCalendar();
            if(t==='dashboard') { renderDashboard(); renderSchedule('dash-schedule-container'); }
            if(t==='academia') { renderAcademia(); }
            if(t==='resources') { renderDriveFiles(); }
            if(t==='purchasing') { renderOrders(); updatePurchasingStats(); } 
            
            hideMoreMenu();
        }

        // --- DASHBOARD RENDER & HELPERS ---
        function renderDashboard() {
            const todayStr = new Date().toISOString().split('T')[0];
            const dashTasks = document.getElementById('dashboard-tasks');
            if(dashTasks) {
                dashTasks.innerHTML = '';
                const todayTasks = appData.tasks.filter(t => t.date === todayStr && !t.completed);
                const q1Tasks = appData.tasks.filter(t => t.quadrant === 'q1' && !t.completed && t.date !== todayStr);
                const combinedTasks = [...todayTasks, ...q1Tasks]; // Removed slice limit as requested
                if(combinedTasks.length === 0) dashTasks.innerHTML = '<div class="text-sm text-notion-dim pl-2 italic">ç„¡ç·Šæ€¥å¾…è¾¦</div>';
                else {
                    combinedTasks.forEach(t => {
                        dashTasks.innerHTML += `<div class="flex items-start gap-2 p-1 hover:bg-notion-hover rounded cursor-default"><input type="checkbox" onclick="toggleTask(${t.id}); renderDashboard()" class="mt-1 cursor-pointer"><div class="flex-1 min-w-0"><div class="text-sm font-medium text-black truncate">${t.title}</div><div class="text-[10px] text-notion-dim">${t.date}</div></div></div>`;
                    });
                }
            }
            renderBookmarks(); renderDriveFiles(); renderRecentSources();
        }

        function renderBookmarks() {
            const list = document.getElementById('dash-bookmarks'); if(!list) return;
            list.innerHTML = '';
            if(appData.bookmarks.length === 0) list.innerHTML = '<li class="text-sm text-notion-dim pl-2">æš«ç„¡æ›¸ç±¤</li>';
            appData.bookmarks.forEach(b => {
                list.innerHTML += `<li class="flex justify-between items-center group p-1 hover:bg-notion-hover rounded"><a href="${b.url}" target="_blank" class="flex items-center text-sm text-blue-600 hover:underline truncate"><i class="fas fa-link text-xs mr-2 text-gray-400"></i>${b.title}</a><button onclick="deleteBookmark(${b.id})" class="text-gray-300 hover:text-red-400 opacity-0 group-hover:opacity-100 px-2"><i class="fas fa-times"></i></button></li>`;
            });
        }
        function addBookmark() {
            const title = prompt("ç¶²ç«™åç¨±ï¼š"); if(!title) return;
            const url = prompt("ç¶²å€ï¼š", "https://"); if(!url) return;
            appData.bookmarks.push({ id: Date.now(), title, url }); saveData(); renderBookmarks();
        }
        function deleteBookmark(id) { if(confirm("ç§»é™¤æ­¤æ›¸ç±¤ï¼Ÿ")) { appData.bookmarks = appData.bookmarks.filter(b => b.id !== id); saveData(); renderBookmarks(); } }
        
        function renderRecentSources() {
             const sourceList = document.getElementById('dash-recent-sources');
            if(sourceList) {
                sourceList.innerHTML = '';
                const recentLits = [...appData.literature].sort((a,b) => b.id - a.id).slice(0, 5);
                if(recentLits.length === 0) sourceList.innerHTML = '<div class="text-xs text-gray-400 italic">å°šç„¡æ–‡ç»è³‡æ–™</div>';
                else {
                    recentLits.forEach(l => {
                        sourceList.innerHTML += `<div class="text-xs border-b border-notion-border pb-1 mb-1 last:border-0"><div class="font-bold text-notion-text truncate">${l.title}</div><div class="text-[10px] text-notion-dim truncate">${l.author}</div></div>`;
                    });
                }
            }
        }
        
        function saveCourseNotes() { const note = document.getElementById('notebook-global-note'); if(note) { appData.courseNotes = note.value; saveData(); } }

        function initDragAndDrop() {
            const z = document.getElementById('drop-zone'); if(!z) return;
            z.addEventListener('dragover', e => { e.preventDefault(); z.classList.add('dragover'); });
            z.addEventListener('dragleave', e => { e.preventDefault(); z.classList.remove('dragover'); });
            z.addEventListener('drop', e => {
                e.preventDefault(); z.classList.remove('dragover');
                [...e.dataTransfer.files].forEach(f => { appData.driveFiles.unshift({id:Date.now(), name:f.name, date:new Date().toLocaleDateString(), url:''}); });
                saveData(); renderDriveFiles();
            });
        }
        function renderDriveFiles(){
            const l=document.getElementById('dash-drive-files'); if(!l)return; l.innerHTML='';
            appData.driveFiles.forEach(f=>{
                l.innerHTML+=`<li class="flex justify-between items-center p-1 hover:bg-notion-hover rounded"><div class="truncate flex-1"><i class="fas fa-file text-notion-dim mr-2"></i><a href="${f.url||'#'}" target="_blank" class="hover:underline cursor-pointer" onclick="if(!'${f.url}') editDriveFileUrl(${f.id})">${f.name}</a></div><div class="flex gap-1"><button onclick="editDriveFileUrl(${f.id})" class="text-gray-400 hover:text-black"><i class="fas fa-link"></i></button><button onclick="deleteDriveFile(${f.id})" class="text-gray-300 hover:text-red-500"><i class="fas fa-times"></i></button></div></li>`;
            });
        }
        function editDriveFileUrl(id){
             const f=appData.driveFiles.find(x=>x.id===id); const u=prompt("è¼¸å…¥é€£çµ URL:", f.url||"");
             if(u!==null){ f.url=u; saveData(); renderDriveFiles(); }
        }
        function deleteDriveFile(id){ if(confirm("ç§»é™¤?")){ appData.driveFiles=appData.driveFiles.filter(f=>f.id!==id); saveData(); renderDriveFiles(); } }

        // --- ACADEMIA ---
        function toggleCourseForm(){ 
            const p=document.getElementById('course-form-panel'); p.classList.toggle('open'); 
            if(document.getElementById('course-semester')) document.getElementById('course-semester').value = currentSemester;
            if(p.classList.contains('open') && !currentEditingCourseId) resetCourseForm();
        }
        
        function resetCourseForm() {
            document.getElementById('course-name').value = ''; document.getElementById('course-credits').value = '2';
            document.getElementById('course-target-grade').value = ''; document.getElementById('course-grade').value = '';
            document.getElementById('course-gpa').value = ''; document.getElementById('btn-save-course').innerText = 'ä¿å­˜';
            currentEditingCourseId = null;
        }

        function initAcademiaSelects() {
            const start=document.getElementById('course-start'), end=document.getElementById('course-end');
            if(!start) return;
            let ops=''; TIME_SLOTS.forEach((time, index) => { ops += `<option value="${index+1}">${time}</option>`; });
            start.innerHTML=ops; end.innerHTML=ops;
        }
        
        function switchSemester(sem) {
            currentSemester = sem;
            ['114-1', '114-2', '115-1', '115-2'].forEach(s => {
                const btn = document.getElementById(`sem-btn-${s}`);
                if(btn) btn.className = s === sem ? "px-3 py-1 rounded text-sm font-bold bg-white shadow-sm text-notion-text transition" : "px-3 py-1 rounded text-sm font-bold text-notion-dim hover:bg-white/50 transition";
            });
            document.getElementById('schedule-title-semester').innerText = sem;
            renderAcademia();
        }

        function updateAcademicStats(){
            let tc=0, ws=0, vc=0;
            appData.courses.forEach(c=>{ 
                const cred = parseInt(c.credits) || 0; tc += cred; 
                if(c.gpaPoints > 0){ ws += (c.gpaPoints * cred); vc += cred; } 
            });
            document.getElementById('acad-total-credits').innerText=tc;
            document.getElementById('acad-gpa').innerText=vc>0?(ws/vc).toFixed(2):"0.0";
        }

        function renderAcademia() { renderSchedule('schedule-container'); renderCourseList(); renderCoursePlanning(); updateAcademicStats(); }

        function addCourse() {
            const n=document.getElementById('course-name').value;
            if(!n) return showToast("è«‹è¼¸å…¥åç¨±");
            
            const courseData = {
                id: currentEditingCourseId ? currentEditingCourseId : Date.now(), 
                name:n, 
                credits:parseInt(document.getElementById('course-credits').value)||0,
                grade:parseFloat(document.getElementById('course-grade').value)||0, 
                target:parseFloat(document.getElementById('course-target-grade').value)||0, 
                gpaPoints:parseFloat(document.getElementById('course-gpa').value)||0, 
                day:parseInt(document.getElementById('course-day').value),
                start:parseInt(document.getElementById('course-start').value), end:parseInt(document.getElementById('course-end').value),
                semester: currentSemester, 
                type: document.getElementById('course-type').value
            };

            if(currentEditingCourseId) {
                const idx = appData.courses.findIndex(c => c.id === currentEditingCourseId);
                if(idx !== -1) appData.courses[idx] = { ...appData.courses[idx], ...courseData };
            } else {
                appData.courses.push(courseData);
            }

            saveData(); renderAcademia(); toggleCourseForm();
        }

        function editCourse(id) {
            const c = appData.courses.find(c => c.id === id); if(!c) return;
            currentEditingCourseId = id;
            document.getElementById('course-name').value = c.name; document.getElementById('course-credits').value = c.credits;
            document.getElementById('course-target-grade').value = c.target || ''; document.getElementById('course-grade').value = c.grade || '';
            document.getElementById('course-gpa').value = c.gpaPoints || ''; document.getElementById('course-type').value = c.type || 'å¿…ä¿®';
            document.getElementById('course-day').value = c.day || 1; document.getElementById('course-start').value = c.start || 1;
            document.getElementById('course-end').value = c.end || 1; document.getElementById('btn-save-course').innerText = 'æ›´æ–°èª²ç¨‹';
            const p=document.getElementById('course-form-panel'); if(!p.classList.contains('open')) p.classList.add('open');
            p.scrollIntoView({behavior: 'smooth'});
        }

        // --- COURSE NOTES (FIXED) ---
        function openCourseNote(id) {
            currentNoteCourseId = id;
            const course = appData.courses.find(c => c.id === id);
            if (!course) return;
            document.getElementById('modal-course-title').innerText = `ç­†è¨˜: ${course.name}`;
            document.getElementById('modal-course-content').value = course.note || '';
            document.getElementById('course-note-modal').classList.remove('hidden');
        }

        function closeCourseNote() {
            document.getElementById('course-note-modal').classList.add('hidden');
            currentNoteCourseId = null;
        }

        function saveCurrentCourseNote() {
            if (!currentNoteCourseId) return;
            const content = document.getElementById('modal-course-content').value;
            const idx = appData.courses.findIndex(c => c.id === currentNoteCourseId);
            if (idx !== -1) {
                appData.courses[idx].note = content;
                saveData();
                showToast('ç­†è¨˜å·²å„²å­˜');
                closeCourseNote();
            }
        }

        function renderSchedule(containerId) {
            const c=document.getElementById(containerId); if(!c)return;
            let h=''; 
            TIME_SLOTS.forEach((timeRange, index) => {
                const periodIndex = index + 1;
                h += `<div class="grid-schedule border-b border-notion-border text-center"><div class="text-[10px] text-notion-dim py-2 border-r border-notion-border flex items-center justify-center bg-notion-gray-bg/30 px-1 leading-tight">${timeRange.replace('~', '<br>~<br>')}</div>`;
                for(let d=1; d<=5; d++){ h+=`<div class="schedule-cell relative" data-d="${d}" data-p="${periodIndex}"></div>`; }
                h+='</div>';
            });
            c.innerHTML=h;
            const colors=['bg-red-100 text-red-800','bg-blue-100 text-blue-800','bg-green-100 text-green-800','bg-purple-100 text-purple-800','bg-yellow-100 text-yellow-800'];
            const filteredCourses = appData.courses.filter(c => c.semester === currentSemester || !c.semester); 
            filteredCourses.forEach((co, idx)=>{
                if(co.day > 5) return;
                const cells = c.querySelectorAll(`.schedule-cell[data-d="${co.day}"]`);
                cells.forEach(cell => {
                    if(parseInt(cell.dataset.p) === co.start) {
                        const dur = co.end - co.start + 1;
                        const block = document.createElement('div');
                        block.className = `course-block absolute inset-1 rounded p-1 text-[10px] font-bold leading-tight flex flex-col justify-center items-center z-10 ${colors[idx%colors.length]}`;
                        block.style.height = `${(61 * dur) - 4}px`; block.style.zIndex = '20';
                        block.innerHTML = co.name;
                        cell.appendChild(block);
                    }
                });
            });
        }

        function renderCoursePlanning() {
            const types = { 'required': 'plan-required', 'comp-elective': 'plan-comp-elective', 'elective': 'plan-elective' };
            for (let t in types) { const el = document.getElementById(types[t]); if(el) el.innerHTML = ''; }
            appData.courses.forEach(c => {
                let targetId = '';
                if (c.type === 'å¿…ä¿®') targetId = types['required']; else if (c.type === 'å¿…é¸ä¿®') targetId = types['comp-elective']; else if (c.type === 'é¸ä¿®') targetId = types['elective'];
                if (targetId) {
                    const el = document.getElementById(targetId);
                    const isCompleted = c.grade > 0;
                    const styleClass = isCompleted ? "text-notion-text font-medium" : "text-notion-dim border-dashed border-gray-300 italic";
                    if(el) el.innerHTML += `<li class="flex justify-between border-b border-notion-border last:border-0 py-1 ${styleClass}"><span>${c.name}</span><span class="text-xs">${c.credits}å­¸åˆ†</span></li>`;
                }
            });
        }
        
        function renderCourseList(){
            const desktopBody = document.getElementById('course-list-body-desktop');
            const mobileBody = document.getElementById('course-list-body-mobile');
            if(!desktopBody || !mobileBody) return;
            
            desktopBody.innerHTML = '';
            mobileBody.innerHTML = '';
            
            const allCourses = [...appData.courses].sort((a,b) => (a.semester||'') > (b.semester||'') ? -1 : 1);
            
            allCourses.forEach(c => {
                let actualDisplay = c.grade > 0 ? `${c.grade} <span class="text-xs text-notion-dim">(${c.gpaPoints||'-'})</span>` : '-';
                
                // Desktop Row
                desktopBody.innerHTML += `
                <tr class="hover:bg-notion-hover border-b border-notion-border last:border-0">
                    <td class="p-3 font-bold text-notion-dim">${c.semester || '-'}</td>
                    <td class="p-3 font-medium text-notion-text">${c.name}</td>
                    <td class="p-3 text-xs text-notion-dim">${c.type || 'æœªåˆ†é¡'}</td>
                    <td class="p-3 text-sm">${c.credits}</td>
                    <td class="p-3 text-sm font-mono text-notion-dim">${c.target > 0 ? c.target : '-'}</td>
                    <td class="p-3 text-sm font-mono font-bold">${actualDisplay}</td>
                    <td class="p-3 text-right">
                        <div class="flex justify-end gap-2">
                             <button onclick="editCourse(${c.id})" class="text-gray-400 hover:text-blue-500"><i class="fas fa-edit"></i></button>
                             <button onclick="deleteCourse(${c.id})" class="text-gray-300 hover:text-red-500"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                </tr>`;
                
                // Mobile Card (New Design)
                mobileBody.innerHTML += `
                <div class="bg-white border border-notion-border rounded p-3 shadow-sm flex flex-col gap-2">
                    <div class="flex justify-between items-start">
                        <div>
                            <span class="text-xs bg-notion-gray-bg px-1.5 py-0.5 rounded text-notion-dim mb-1 inline-block">${c.semester || '-'}</span>
                            <div class="font-bold text-notion-text text-base">${c.name}</div>
                            <div class="text-xs text-notion-dim">${c.type} Â· ${c.credits} å­¸åˆ†</div>
                        </div>
                        <div class="text-right">
                             <div class="font-mono font-bold text-lg text-blue-600">${c.grade > 0 ? c.grade : '--'}</div>
                             <div class="text-[10px] text-notion-dim">ç›®æ¨™: ${c.target || '-'}</div>
                        </div>
                    </div>
                    <div class="border-t border-notion-border pt-2 flex justify-end gap-3 mt-1">
                        <button onclick="editCourse(${c.id})" class="text-xs text-blue-500 flex items-center gap-1"><i class="fas fa-edit"></i> ç·¨è¼¯</button>
                        <button onclick="deleteCourse(${c.id})" class="text-xs text-red-500 flex items-center gap-1"><i class="fas fa-trash"></i> åˆªé™¤</button>
                    </div>
                </div>`;
            });
        }

        // --- PURCHASING (FIXED) ---
        function toggleOrderForm(){ 
            document.getElementById('order-form-panel').classList.toggle('open'); 
            if(!document.getElementById('order-form-panel').classList.contains('open')) resetOrderForm();
        }
        function renderStatusOptions() {
            const sel = document.getElementById('order-status'); if(!sel) return;
            sel.innerHTML = ORDER_STATUSES.map(s => `<option value="${s}">${s}</option>`).join('');
        }
        function addOrderItemRow(name='', qty=1, krw=''){ 
            const c=document.getElementById('order-items-container');
            const d=document.createElement('div'); 
            // Changed input layout for mobile
            d.className="flex flex-col md:flex-row gap-2 mb-2 item-row items-stretch md:items-center border-b md:border-b-0 border-dashed border-gray-200 pb-2 md:pb-0";
            d.innerHTML=`
                <input class="flex-1 bg-transparent border border-notion-border rounded px-2 py-1 text-sm item-name w-full" placeholder="å“å" value="${name}">
                <div class="flex gap-2 w-full">
                    <input type="number" class="flex-1 bg-transparent border border-notion-border rounded px-2 py-1 text-sm item-qty" placeholder="æ•¸é‡" value="${qty}" oninput="calcProfit()">
                    <input type="number" class="flex-1 bg-transparent border border-notion-border rounded px-2 py-1 text-sm item-krw" placeholder="éŸ“å¹£" value="${krw}" oninput="calcProfit()">
                    <button onclick="this.parentElement.parentElement.remove(); calcProfit()" class="text-gray-400 hover:text-red-500 w-8 flex-shrink-0 flex items-center justify-center border border-gray-200 rounded"><i class="fas fa-times"></i></button>
                </div>
            `;
            c.appendChild(d);
        }
        function calcProfit() {
            const rate = parseFloat(document.getElementById('order-rate').value) || 38;
            let totalKRW = 0;
            document.querySelectorAll('.item-row').forEach(row => {
                const q = parseFloat(row.querySelector('.item-qty').value)||0;
                const k = parseFloat(row.querySelector('.item-krw').value)||0;
                totalKRW += (k * q);
            });
            const costTWD = Math.ceil(totalKRW / rate);
            document.getElementById('order-twd-cost').innerText = costTWD;
            const sell = parseFloat(document.getElementById('order-sell-price').innerText) || 0;
            document.getElementById('order-profit').innerText = sell - costTWD;
        }
        function calculateProfitManual() { calcProfit(); }
        
        function saveOrder() {
            const items = [];
            document.querySelectorAll('.item-row').forEach(row => {
                items.push({
                    name: row.querySelector('.item-name').value,
                    qty: parseFloat(row.querySelector('.item-qty').value)||0,
                    krw: parseFloat(row.querySelector('.item-krw').value)||0
                });
            });
            
            const order = {
                id: currentEditingOrderId ? currentEditingOrderId : Date.now(),
                date: document.getElementById('order-date').value,
                code: document.getElementById('order-code').value,
                shop: document.getElementById('order-shop').value,
                rate: parseFloat(document.getElementById('order-rate').value),
                status: document.getElementById('order-status').value,
                items: items,
                cost: parseFloat(document.getElementById('order-twd-cost').innerText),
                sell: parseFloat(document.getElementById('order-sell-price').innerText),
                profit: parseFloat(document.getElementById('order-profit').innerText),
                note: document.getElementById('order-note').value,
                isPaid: document.getElementById('order-paid').checked,
                isShippingPaid: document.getElementById('order-shipping').checked
            };

            if(currentEditingOrderId) {
                const idx = appData.orders.findIndex(o => o.id === currentEditingOrderId);
                if(idx !== -1) appData.orders[idx] = order;
            } else {
                appData.orders.unshift(order);
            }
            
            saveData(); renderOrders(); updatePurchasingStats(); toggleOrderForm();
        }

        function resetOrderForm() {
            currentEditingOrderId = null;
            document.getElementById('order-date').value = ''; document.getElementById('order-code').value = '';
            document.getElementById('order-shop').value = ''; document.getElementById('order-items-container').innerHTML = '';
            document.getElementById('order-twd-cost').innerText = '0'; document.getElementById('order-sell-price').innerText = '0';
            document.getElementById('order-profit').innerText = '0'; document.getElementById('order-note').value = '';
            document.getElementById('order-paid').checked = false; document.getElementById('order-shipping').checked = false;
            document.getElementById('btn-save-order').innerText = 'å„²å­˜è¨‚å–®';
        }

        function editOrder(id) {
            const order = appData.orders.find(o => o.id === id);
            if (!order) return;

            currentEditingOrderId = id;
            document.getElementById('order-date').value = order.date;
            document.getElementById('order-code').value = order.code || '';
            document.getElementById('order-shop').value = order.shop || '';
            document.getElementById('order-rate').value = order.rate || 38;
            document.getElementById('order-status').value = order.status;
            document.getElementById('order-note').value = order.note || '';
            document.getElementById('order-paid').checked = order.isPaid;
            document.getElementById('order-shipping').checked = order.isShippingPaid;
            
            const container = document.getElementById('order-items-container');
            container.innerHTML = '';
            if (order.items && order.items.length > 0) {
                order.items.forEach(item => {
                    addOrderItemRow(item.name, item.qty, item.krw);
                });
            } else {
                addOrderItemRow(order.name, 1, 0); 
            }

            document.getElementById('order-sell-price').innerText = order.sell || 0;
            calcProfit(); 
            document.getElementById('btn-save-order').innerText = 'æ›´æ–°è¨‚å–®';
            
            const panel = document.getElementById('order-form-panel');
            if (!panel.classList.contains('open')) {
                panel.classList.add('open');
            }
            panel.scrollIntoView({ behavior: 'smooth' });
        }

        function renderOrders() {
            const tbody = document.getElementById('order-list-container'); if(!tbody) return; tbody.innerHTML = '';
            let list = [...appData.orders];
            if (orderSort === 'asc') list.sort((a,b) => new Date(a.date) - new Date(b.date)); else list.sort((a,b) => new Date(b.date) - new Date(a.date));
            if (orderFilterUnfinished) list = list.filter(o => o.status !== 'è¨‚å–®å®Œæˆ');
            
            list.forEach(o => {
                const itemsStr = o.items.map(i => `<div class="truncate">${i.name} <span class="text-gray-400">x${i.qty}</span></div>`).join('');
                const statusOptions = ORDER_STATUSES.map(s => `<option value="${s}" ${s===o.status?'selected':''}>${s}</option>`).join('');
                
                const cardHtml = `
                    <div class="bg-white border border-notion-border rounded p-3 shadow-sm relative flex flex-col h-full">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <div class="font-bold text-lg text-notion-text">${o.shop}</div>
                                <div class="text-xs text-notion-dim">${o.date} <span class="mx-1">Â·</span> ${o.code || '-'}</div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold text-green-600">$${o.profit}</div>
                                <div class="text-xs text-notion-dim">åˆ©æ½¤</div>
                            </div>
                        </div>
                        <div class="text-sm text-gray-700 mb-3 border-b border-gray-100 pb-2 flex-1 overflow-y-auto max-h-32">
                            ${itemsStr}
                            ${o.note ? `<div class="text-xs text-gray-400 mt-1 italic">è¨»: ${o.note}</div>` : ''}
                        </div>
                        <div class="flex flex-col gap-2 mt-auto">
                            <select onchange="updateOrderStatus(${o.id}, this.value)" class="bg-gray-100 text-xs rounded p-1 border-none cursor-pointer w-full">
                                ${statusOptions}
                            </select>
                            <div class="flex justify-between items-center">
                                <div class="flex gap-1">
                                    <span class="text-xs px-2 py-1 rounded cursor-pointer ${o.isPaid?'bg-green-100 text-green-700':'bg-red-100 text-red-700'}" onclick="toggleOrderPaid(${o.id}, 'paid')">${o.isPaid?'å·²æ”¶':'æœªæ”¶'}</span>
                                    <span class="text-xs px-2 py-1 rounded cursor-pointer ${o.isShippingPaid?'bg-green-100 text-green-700':'bg-red-100 text-red-700'}" onclick="toggleOrderPaid(${o.id}, 'shipping')">${o.isShippingPaid?'é‹OK':'é‹æœª'}</span>
                                </div>
                                <div class="flex gap-3">
                                     <button onclick="editOrder(${o.id})" class="text-gray-400 hover:text-blue-500"><i class="fas fa-edit"></i></button>
                                     <button onclick="deleteOrder(${o.id})" class="text-gray-300 hover:text-red-500"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                tbody.innerHTML += cardHtml;
            });
        }
        function toggleOrderPaid(id, type) {
            const order = appData.orders.find(o => o.id === id);
            if(order) {
                if(type === 'paid') order.isPaid = !order.isPaid;
                else order.isShippingPaid = !order.isShippingPaid;
                saveData(); renderOrders(); updatePurchasingStats();
            }
        }
        function deleteOrder(id) { if(confirm("åˆªé™¤ï¼Ÿ")) { appData.orders = appData.orders.filter(o => o.id !== id); saveData(); renderOrders(); updatePurchasingStats(); } }
        function updateOrderStatus(id, newStatus) { const order = appData.orders.find(o => o.id === id); if(order){ order.status = newStatus; saveData(); showToast("ç‹€æ…‹å·²æ›´æ–°"); } }
        function updateOrderDisplaySettings() {
            orderSort = document.getElementById('order-sort-select').value;
            orderFilterUnfinished = document.getElementById('order-filter-unfinished').checked;
            renderOrders();
        }
        function updatePurchasingStats() {
            // Unpaid calculation: Sum of 'sell' price where isPaid is false (Receivables)
            // Or 'sell' price where status isn't complete? Usually 'isPaid' is the tracker.
            // Using 'sell' as per typical agent usage (receivable from customer)
            const net = appData.orders.reduce((acc, o) => acc + (o.profit || 0), 0);
            const unpaid = appData.orders.filter(o => !o.isPaid).reduce((acc, o) => acc + (o.sell || 0), 0); 
            document.getElementById('stats-net-profit').innerText = net;
            document.getElementById('stats-unpaid').innerText = unpaid;
            document.getElementById('stats-total-orders').innerText = appData.orders.length;
        }

        // --- DRINKS ---
        function toggleDrinkForm(){ document.getElementById('drink-form-panel').classList.toggle('open'); }
        function toggleDrinkPriceState(){const dis=document.getElementById('drink-treat').checked||document.getElementById('drink-meal').checked; const p=document.getElementById('drink-price'); p.disabled=dis; if(dis)p.value='';}
        function addDrink(){
            const d=document.getElementById('drink-date').value; const s=document.getElementById('drink-shop').value; const n=document.getElementById('drink-name').value;
            if(!d||!s||!n) return showToast("è«‹è¼¸å…¥å®Œæ•´è³‡è¨Š");
            let p=parseFloat(document.getElementById('drink-price').value)||0;
            const tr=document.getElementById('drink-treat').checked; const m=document.getElementById('drink-meal').checked;
            if(tr||m) p=0;
            appData.drinks.unshift({id:Date.now(),date:d,shop:s,name:n,price:p,isTreat:tr,isMeal:m,isEco:document.getElementById('drink-eco').checked});
            saveData(); renderDrinks(); updateStats(); toggleDrinkForm(); renderDrinkCalendar();
        }
        function renderDrinks(){
            const b=document.getElementById('drink-list-body'); if(!b)return; b.innerHTML='';
            appData.drinks.slice(0,20).forEach(d=>{
                b.innerHTML+=`<tr class="hover:bg-notion-hover"><td class="p-2 border-b border-notion-border">${d.date}</td><td class="p-2 border-b border-notion-border font-medium">${d.shop}</td><td class="p-2 border-b border-notion-border text-notion-dim">${d.name}</td><td class="p-2 border-b border-notion-border font-bold">${d.isTreat?'ğŸ':d.isMeal?'ğŸ±':d.price}</td><td class="p-2 border-b border-notion-border"><button onclick="deleteDrink(${d.id})" class="text-gray-300 hover:text-red-500"><i class="fas fa-trash"></i></button></td></tr>`;
            });
        }
        function deleteDrink(id){if(confirm("åˆªé™¤ï¼Ÿ")){appData.drinks=appData.drinks.filter(d=>d.id!==id); saveData(); renderDrinks(); updateStats(); renderDrinkCalendar();}}
        function updateStats(){
            const ds = appData.drinks; const total = ds.reduce((a,b)=>a+b.price,0);
            document.getElementById('stat-total-cost').innerText = `NT$ ${total}`; document.getElementById('stat-total-cups').innerText = `${ds.length} æ¯`;
            if(ds.length > 0) {
                const shops = {}; const drinks = {}; ds.forEach(d => { shops[d.shop] = (shops[d.shop]||0)+1; drinks[d.name] = (drinks[d.name]||0)+1; });
                document.getElementById('stat-fav-shop').innerText = Object.keys(shops).reduce((a, b) => shops[a] > shops[b] ? a : b);
                document.getElementById('stat-fav-drink').innerText = Object.keys(drinks).reduce((a, b) => drinks[a] > drinks[b] ? a : b);
            }
        }
        function renderDrinkCalendar(){
            const g=document.getElementById('drink-calendar-grid'); if(!g)return; g.innerHTML=''; 
            const d=new Date(currentDrinkCalendarDate.getFullYear(),currentDrinkCalendarDate.getMonth(),1); const m=d.getMonth(); 
            document.getElementById('drink-calendar-month-year').textContent=`${d.getFullYear()} / ${m+1}`; 
            for(let i=0;i<d.getDay();i++){g.innerHTML+='<div></div>';} 
            while(d.getMonth()===m){ 
                const dateStr=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; 
                const cups=appData.drinks.filter(dr=>dr.date===dateStr).length; 
                g.innerHTML+=`<div class="h-12 border border-notion-border rounded p-1 text-xs relative flex items-center justify-center hover:bg-notion-hover ${cups>0?'bg-notion-blue-bg':''}"><span class="font-bold">${d.getDate()}</span>${cups>0 ? `<span class="absolute bottom-0.5 right-1 text-[8px] text-notion-dim">ğŸ¥¤${cups}</span>` : ''}</div>`; 
                d.setDate(d.getDate()+1); 
            } 
        }
        function changeDrinkMonth(d){currentDrinkCalendarDate.setMonth(currentDrinkCalendarDate.getMonth()+d); renderDrinkCalendar();}

        // --- FINANCE ---
        function updateLedgerTypeOptions(){ 
            const c=document.getElementById('ledger-category').value; const t=document.getElementById('ledger-type'); 
            if(c==='general') t.innerHTML='<option value="owe">æ¬ æ¬¾ (Owe)</option><option value="repay">é‚„æ¬¾ (Repay)</option>'; else t.innerHTML='<option value="deposit">å­˜å…¥ (Deposit)</option><option value="withdraw">æå– (Withdraw)</option>'; 
        }

        function resetLedgerForm() {
            document.getElementById('ledger-date').value = '';
            document.getElementById('ledger-desc').value = '';
            document.getElementById('ledger-amount').value = '';
            document.getElementById('btn-save-ledger').innerText = 'æ–°å¢';
            document.getElementById('btn-cancel-ledger').classList.add('hidden');
            editingLedgerId = null;
        }

        function editLedgerEntry(id, category) {
            let entry;
            if (category === 'general') {
                entry = appData.debts.find(d => d.id === id);
            } else {
                entry = appData.cameraFund.entries.find(e => e.id === id);
            }
            if (!entry) return;

            editingLedgerId = id;
            document.getElementById('ledger-category').value = category;
            updateLedgerTypeOptions();
            document.getElementById('ledger-type').value = entry.type;
            document.getElementById('ledger-date').value = entry.date;
            document.getElementById('ledger-desc').value = entry.desc;
            document.getElementById('ledger-amount').value = entry.amount;
            
            document.getElementById('btn-save-ledger').innerText = 'æ›´æ–°';
            document.getElementById('btn-cancel-ledger').classList.remove('hidden');
            
            const p = document.getElementById('ledger-form-container');
            p.scrollIntoView({ behavior: 'smooth' });
        }

        function saveLedgerEntry(){
             const category = document.getElementById('ledger-category').value;
             const type = document.getElementById('ledger-type').value; 
             const amount = parseFloat(document.getElementById('ledger-amount').value);
             const date = document.getElementById('ledger-date').value;
             const desc = document.getElementById('ledger-desc').value;
             
             if (!amount || !date || !desc) return showToast("è«‹å¡«å¯«å®Œæ•´è³‡è¨Š");

             const newItem = {
                 id: editingLedgerId ? editingLedgerId : Date.now(), 
                 date: date, 
                 desc: desc, 
                 amount: amount, 
                 type: type
             };
             
             if (editingLedgerId) {
                 // Update Existing
                 if (category === 'general') {
                     const idx = appData.debts.findIndex(d => d.id === editingLedgerId);
                     if (idx !== -1) appData.debts[idx] = newItem;
                 } else {
                     const idx = appData.cameraFund.entries.findIndex(e => e.id === editingLedgerId);
                     if (idx !== -1) appData.cameraFund.entries[idx] = newItem;
                 }
                 showToast("ç´€éŒ„å·²æ›´æ–°");
             } else {
                 // Create New
                 if(category === 'general') appData.debts.unshift(newItem); 
                 else appData.cameraFund.entries.unshift(newItem);
                 showToast("ç´€éŒ„å·²æ–°å¢");
             }
             
             saveData(); 
             renderDebts(); 
             renderCameraFund(); 
             resetLedgerForm();
        }
        
        function renderDebts(){
            const c=document.getElementById('debt-list'); c.innerHTML='';
            
            const sortedDebts = [...appData.debts].sort((a,b) => new Date(b.date) - new Date(a.date));
            
            let totalBalance = 0;
            appData.debts.forEach(d => {
                if(d.type === 'owe') totalBalance += d.amount;
                else totalBalance -= d.amount;
            });
            
            const headerEl = document.getElementById('debt-total-balance');
            if(headerEl) {
                headerEl.innerText = `ç¸½æ¬ æ¬¾: $${totalBalance}`;
                headerEl.className = `text-xs font-bold px-2 py-1 rounded ${totalBalance > 0 ? 'bg-red-50 text-red-600' : 'bg-green-50 text-green-600'}`;
            }

            sortedDebts.forEach(h => {
                c.innerHTML += `
                    <div class="flex justify-between items-center border-b border-notion-border py-2 text-sm">
                        <span class="text-notion-dim font-mono text-xs w-24">${h.date}</span>
                        <div class="flex-1 px-2 font-medium truncate">${h.desc}</div>
                        <span class="${h.type==='owe'?'text-red-500':'text-green-600'} font-bold w-20 text-right">
                            ${h.type==='owe'?'å€Ÿ':'é‚„'} $${h.amount}
                        </span>
                        <div class="flex gap-2 ml-2">
                            <button onclick="editLedgerEntry(${h.id}, 'general')" class="text-gray-400 hover:text-blue-500"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteDebt(${h.id})" class="text-gray-300 hover:text-red-500"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                `;
            });
        }
        
        function renderCameraFund(){
            const l=document.getElementById('fund-list'); l.innerHTML=''; 
            let total=0;
            appData.cameraFund.entries.forEach(e => total += (e.type==='withdraw' ? -e.amount : e.amount));
            
            const headerEl = document.getElementById('camera-header-balance');
            if(headerEl) headerEl.innerText = `å­˜: $${total}`;
            
            const sortedEntries = [...appData.cameraFund.entries].sort((a,b) => new Date(b.date) - new Date(a.date));
            
            sortedEntries.forEach(e=>{ 
                l.innerHTML+=`
                <li class="flex justify-between p-2 border-b border-notion-border text-sm items-center">
                    <span class="text-notion-dim text-xs font-mono w-24">${e.date}</span>
                    <span class="flex-1 truncate px-2">${e.desc}</span>
                    <span class="${e.type=='withdraw'?'text-red-500':'text-green-600'} font-bold w-20 text-right">$${e.amount}</span>
                    <div class="flex gap-2 ml-2">
                        <button onclick="editLedgerEntry(${e.id}, 'camera')" class="text-gray-400 hover:text-blue-500"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteCameraEntry(${e.id})" class="text-gray-300 hover:text-red-500"><i class="fas fa-trash"></i></button>
                    </div>
                </li>`; 
            });
            document.getElementById('camera-bar').style.width = Math.min((total/50000)*100, 100) + '%'; 
        }
        
        function deleteCameraEntry(id) { if(confirm("åˆªé™¤ï¼Ÿ")) { appData.cameraFund.entries = appData.cameraFund.entries.filter(e => e.id !== id); saveData(); renderCameraFund(); } }


        // --- LITERATURE ---
        function renderLiterature(){
            const c=document.getElementById('lit-list-container'); c.innerHTML='';
            appData.literature.forEach(l=>{
                const details = document.createElement('details'); details.className = "group border border-notion-border rounded bg-white mb-2 overflow-hidden";
                details.innerHTML = `<summary class="p-4 cursor-pointer hover:bg-notion-hover list-none flex justify-between items-start"><div><div class="font-bold text-lg text-notion-text">${l.title}</div><div class="text-sm text-notion-dim mt-1">${l.author} <span class="mx-1">Â·</span> ${l.date||'?'}</div></div><span class="bg-notion-gray-bg px-2 py-1 rounded text-xs whitespace-nowrap">${l.status}</span></summary><div class="p-4 bg-notion-gray-bg/20 border-t border-notion-border text-sm space-y-3">${l.method_iv ? `<div class="grid grid-cols-2 gap-2 text-xs mb-2"><div><span class="font-bold">IV:</span> ${l.method_iv}</div><div><span class="font-bold">DV:</span> ${l.method_dv}</div></div>` : ''}${l.background ? `<div><div class="font-bold text-xs text-notion-dim uppercase mb-1">èƒŒæ™¯</div><p>${l.background}</p></div>` : ''}${l.note ? `<div><div class="font-bold text-xs text-notion-dim uppercase mb-1">ç­†è¨˜</div><p>${l.note}</p></div>` : ''}${l.link ? `<a href="${l.link}" target="_blank" class="text-blue-500 hover:underline block text-right mt-2"><i class="fas fa-link mr-1"></i>æŸ¥çœ‹é€£çµ</a>` : ''}<button onclick="deleteLit(${l.id})" class="text-red-400 text-xs hover:underline mt-2">åˆªé™¤æ–‡ç»</button></div>`;
                c.appendChild(details);
            });
        }
        function addLit(){
            const l = { id:Date.now(), title:document.getElementById('lit-title').value, author:document.getElementById('lit-author').value, date:document.getElementById('lit-date').value, type:document.getElementById('lit-type').value, status:document.getElementById('lit-status').value, method_iv:document.getElementById('lit-method-iv').value, method_dv:document.getElementById('lit-method-dv').value, background:document.getElementById('lit-background').value, note:document.getElementById('lit-note').value, link:document.getElementById('lit-link').value };
            appData.literature.unshift(l); saveData(); renderLiterature(); toggleCollapse('lit-form-panel', 'icon-add-lit');
        }
        function deleteLit(id){if(confirm("åˆªé™¤ï¼Ÿ")){appData.literature=appData.literature.filter(l=>l.id!==id); saveData(); renderLiterature();}}
        
        // --- SUBSCRIPTIONS ---
        function toggleSubForm(){ document.getElementById('sub-form-panel').classList.toggle('open'); }
        function updateSubPrice(select) {
            const p = document.getElementById('sub-price'); const custom = document.getElementById('sub-name-custom');
            custom.classList.add('hidden');
            if(select.value === 'Spotify') p.value = 302; else if(select.value === 'Netflix') p.value = 670; else if(select.value === 'iCloud') p.value = 300; else if(select.value === 'Other') { custom.classList.remove('hidden'); p.value = ''; } else p.value = '';
        }
        function addSub() {
            const sel = document.getElementById('sub-name').value;
            appData.subs.push({ id:Date.now(), name: sel === 'Other' ? document.getElementById('sub-name-custom').value : sel, price:parseFloat(document.getElementById('sub-price').value), person:document.getElementById('sub-person').value, cycle:document.getElementById('sub-cycle').value, date:document.getElementById('sub-date').value });
            saveData(); renderSubs(); toggleSubForm();
        }
        function renderSubs() {
            const c=document.getElementById('sub-list-container'); c.innerHTML=''; const groups = {}; const iconMap = { 'Spotify': 'fab fa-spotify text-green-500', 'Netflix': 'fas fa-tv text-red-600', 'YouTube': 'fab fa-youtube text-red-500', 'iCloud': 'fas fa-cloud text-blue-400' };
            appData.subs.forEach(s => { if(!groups[s.name]) groups[s.name] = []; groups[s.name].push(s); });
            for(let service in groups) {
                const items = groups[service]; const total = items.reduce((a,b)=>a+b.price,0);
                
                // Calculate Days Left
                let daysLeftText = '';
                if(items[0].date) {
                    const today = new Date();
                    const start = new Date(items[0].date);
                    let nextDate = new Date(start);
                    
                    // Simple cycle logic (can be improved)
                    while (nextDate < today) {
                         if(items[0].cycle === 'monthly') nextDate.setMonth(nextDate.getMonth() + 1);
                         else if(items[0].cycle === 'quarterly') nextDate.setMonth(nextDate.getMonth() + 3);
                         else if(items[0].cycle === 'yearly') nextDate.setFullYear(nextDate.getFullYear() + 1);
                    }
                    const diffTime = Math.abs(nextDate - today);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                    daysLeftText = `<span class="absolute top-2 right-2 text-[10px] bg-red-100 text-red-600 px-1.5 py-0.5 rounded font-bold">å‰© ${diffDays} å¤©</span>`;
                }

                c.innerHTML += `<div class="bg-white border border-notion-border rounded p-4 shadow-sm flex flex-col h-full relative">
                    ${daysLeftText}
                    <div class="flex items-center gap-3 mb-1"><div class="w-10 h-10 rounded-full bg-notion-gray-bg flex items-center justify-center text-xl shrink-0"><i class="${iconMap[service] || 'fas fa-receipt text-gray-400'}"></i></div><div><div class="font-bold text-notion-text">${service}</div><div class="text-xs text-notion-dim font-mono">ç¸½è¨ˆ: $${total} / ${items[0].cycle}</div></div></div><div class="mt-3 border-t border-gray-100 pt-2 space-y-1">${items.map(item => `<div class="flex justify-between items-center text-xs text-gray-600"><span>${item.person}</span><div class="flex items-center gap-2"><span class="font-medium">$${item.price}</span><button onclick="deleteSub(${item.id})" class="text-gray-300 hover:text-red-500"><i class="fas fa-times"></i></button></div></div>`).join('')}</div></div>`;
            }
        }
        function deleteSub(id){ if(confirm("åˆªé™¤ï¼Ÿ")){appData.subs=appData.subs.filter(s=>s.id!==id); saveData(); renderSubs();} }

        // --- MISC ---
        function toggleCollapse(contentId, iconId) { 
            const content=document.getElementById(contentId); const icon=document.getElementById(iconId); 
            if(!content) return; 
            content.classList.toggle('open'); 
            if(icon) icon.style.transform = content.classList.contains('open') ? 'rotate(180deg)' : 'rotate(0deg)'; 
        }
        function toggleTask(id){ const t=appData.tasks.find(x=>x.id===id); if(t){t.completed=!t.completed; saveData(); renderTasks(); renderDashboard();}}
        function deleteTask(id){ if(confirm("åˆªé™¤ï¼Ÿ")){appData.tasks=appData.tasks.filter(x=>x.id!==id); saveData(); renderTasks(); renderCalendar(); renderDashboard();}}
        function renderCalendar(){
            const g=document.getElementById('calendar-grid'); if(!g)return; g.innerHTML=''; 
            const d=new Date(currentCalendarDate.getFullYear(),currentCalendarDate.getMonth(),1); const m=d.getMonth(); 
            document.getElementById('calendar-month-year').textContent=`${d.getFullYear()} / ${m+1}`; 
            for(let i=0;i<d.getDay();i++){g.innerHTML+='<div></div>';} 
            while(d.getMonth()===m){ 
                const dateStr=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; 
                const hasTask=appData.tasks.some(t=>t.date===dateStr && !t.completed); 
                g.innerHTML+=`<div class="h-16 border border-notion-border rounded p-1 text-xs relative ${hasTask?'bg-notion-yellow-bg':''}"><span class="font-bold">${d.getDate()}</span>${hasTask ? '<div class="w-1.5 h-1.5 bg-red-400 rounded-full absolute top-1.5 right-1.5"></div>' : ''}</div>`; 
                d.setDate(d.getDate()+1); 
            } 
        }
        function changeMonth(d){currentCalendarDate.setMonth(currentCalendarDate.getMonth()+d); renderCalendar();}
        function toggleTimeInput(){document.getElementById('task-time').disabled=document.getElementById('task-allday').checked;}
        function toggleTaskForm(){ const p=document.getElementById('task-form-panel'); p.classList.toggle('open'); }
        function addTask(){
            const d=document.getElementById('task-date').value; const t=document.getElementById('task-title').value; 
            if(!t.trim()||!d)return showToast("è«‹è¼¸å…¥æ—¥æœŸèˆ‡æ¨™é¡Œ"); 
            appData.tasks.push({id:Date.now(),date:d, time:document.getElementById('task-time').value, isAllDay:document.getElementById('task-allday').checked, quadrant:document.getElementById('task-priority').value, title:t,text:t, content:document.getElementById('task-content').value, location:document.getElementById('task-location').value, url:document.getElementById('task-url').value, completed:false}); 
            saveData(); renderTasks(); renderCalendar(); showToast("å·²æ–°å¢"); toggleTaskForm();
        }
        function renderTasks(){
            const list = document.getElementById('all-tasks-list'); if(!list) return; list.innerHTML = '';
            if(appData.tasks.length === 0) { document.getElementById('empty-tasks-msg').classList.remove('hidden'); return; }
            document.getElementById('empty-tasks-msg').classList.add('hidden');
            [...appData.tasks].sort((a,b) => (a.completed===b.completed)?(new Date(a.date)-new Date(b.date)):(a.completed?1:-1)).forEach(t => {
                list.innerHTML += `<li class="p-3 hover:bg-notion-hover transition flex gap-3 items-start ${t.completed ? 'opacity-50 line-through' : ''}"><input type="checkbox" ${t.completed ? 'checked' : ''} onchange="toggleTask(${t.id})" class="mt-1 cursor-pointer"><div class="flex-1"><div class="text-sm font-medium text-notion-text">${t.title}</div><div class="text-xs text-notion-dim mt-0.5">${t.date}</div></div><button onclick="deleteTask(${t.id})" class="text-gray-300 hover:text-red-400"><i class="fas fa-trash-alt"></i></button></li>`;
            });
        }
        function showMoreMenu(){ document.getElementById('mobile-more-menu').classList.remove('hidden'); }
        function hideMoreMenu(){ document.getElementById('mobile-more-menu').classList.add('hidden'); }
        function uploadCover(input) { const file = input.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = function(e) { appData.coverImage = e.target.result; saveData(); renderCover(); }; reader.readAsDataURL(file); input.value = ''; }
        function removeCover() { if(confirm("ç¢ºå®šç§»é™¤?")) { appData.coverImage = null; saveData(); renderCover(); } }
        function renderCover() {
            const container = document.getElementById('page-cover-container'); const removeBtn = container.querySelector('button[title="ç§»é™¤å°é¢"]'); 
            if (appData.coverImage) { container.style.backgroundImage = `url('${appData.coverImage}')`; container.classList.remove('bg-gradient-to-r'); if(removeBtn) removeBtn.classList.remove('hidden'); } 
            else { container.style.backgroundImage = ''; container.classList.add('bg-gradient-to-r'); if(removeBtn) removeBtn.classList.add('hidden'); }
        }
        function backupAllData() { const a = document.createElement('a'); a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(appData)); a.download = "Notion_Backup.json"; a.click(); }
        function importAllData(input) { const f = input.files[0]; if(!f) return; const r = new FileReader(); r.onload = e => { try { appData = { ...appData, ...JSON.parse(e.target.result) }; saveData(); location.reload(); } catch(err) { alert("åŒ¯å…¥å¤±æ•—"); } }; r.readAsText(f); }
        function deleteCourse(id){ if(confirm("åˆªé™¤ï¼Ÿ")){appData.courses=appData.courses.filter(c=>c.id!==id); saveData(); renderAcademia();} }
        function deleteDebt(id){ if(confirm("åˆªé™¤ï¼Ÿ")){appData.debts=appData.debts.filter(d=>d.id!==id); saveData(); renderDebts();} }

        const originalLoadData = loadData;
        loadData = function() { originalLoadData(); if (!appData.coverImage) appData.coverImage = null; renderCover(); };
    </script>
</body>
</html>